<html lang="zh-CN"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å½±å‰§å¸ˆ - æ™ºèƒ½å‰§æœ¬åˆ›ä½œä¸åˆ†é•œè§„åˆ’å¹³å°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.544.0/dist/umd/lucide.min.js"></script>
    <style>
        :root {
            --primary-color: #000000;
            --secondary-color: #666666;
            --background-color: #ffffff;
            --surface-color: #f8f8f8;
            --border-color: #e0e0e0;
            --text-color: #333333;
            --text-secondary-color: #666666;
        }
        body {
            background-color: var(--background-color);
            color: var(--text-color);
            font-family: 'Inter', sans-serif;
        }
        .sidebar {
            background-color: var(--surface-color);
            border-right: 1px solid var(--border-color);
        }
        .main-content {
            background-color: var(--background-color);
        }
        .editor {
            background-color: var(--surface-color);
            border-left: 1px solid var(--border-color);
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            transition: background-color 0.3s;
        }
        .btn-primary:hover {
            background-color: #333333;
        }
        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
            transition: background-color 0.3s;
        }
        .btn-secondary:hover {
            background-color: #999999;
        }
        .nav-link {
            color: var(--text-secondary-color);
            transition: color 0.3s;
        }
        .nav-link:hover, .nav-link.active {
            color: var(--text-color);
        }
        .timeline-item {
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .timeline-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .modal {
            background-color: rgba(0, 0, 0, 0.1);
        }
        .modal-content {
            background-color: var(--background-color);
        }
    </style>
</head>
<body>
    <!-- é¦–é¡µ -->
    <div id="homepage" class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100">
        <!-- å¯¼èˆªæ  -->
        <nav class="bg-white shadow-sm border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 flex items-center">
                            <i data-lucide="film" class="h-8 w-8 text-blue-600"></i>
                            <span class="ml-2 text-xl font-bold text-gray-900">å½±å‰§å¸ˆ</span>
                        </div>
                        <span class="ml-4 text-sm text-gray-500">æ™ºèƒ½å‰§æœ¬åˆ›ä½œä¸åˆ†é•œè§„åˆ’å¹³å°</span>
                    </div>
                    <div class="flex items-center">
                        <button onclick="showApp()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            å¼€å§‹åˆ›ä½œ
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- ä¸»è¦å†…å®¹ -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
            <!-- è‹±é›„åŒºåŸŸ -->
            <div class="text-center mb-16">
                <h1 class="text-4xl font-extrabold text-gray-900 sm:text-5xl md:text-6xl">
                    <span class="block">è®©åˆ›æ„ç…§è¿›ç°å®</span>
                    <span class="block text-blue-600 mt-2">AIé©±åŠ¨çš„å½±è§†åˆ›ä½œåŠ©æ‰‹</span>
                </h1>
                <p class="mt-6 text-xl text-gray-500 max-w-3xl mx-auto">
                    ä»çµæ„Ÿåˆ°æˆç‰‡ï¼Œä¸€ç«™å¼å‰§æœ¬åˆ›ä½œä¸åˆ†é•œè§„åˆ’è§£å†³æ–¹æ¡ˆã€‚æ™ºèƒ½AIè¾…åŠ©ï¼Œè®©æ‚¨çš„åˆ›ä½œæ›´é«˜æ•ˆã€æ›´ä¸“ä¸šã€‚
                </p>
                <div class="mt-8">
                    <button onclick="showApp()" class="bg-blue-600 text-white px-8 py-3 rounded-lg text-lg font-medium hover:bg-blue-700 transition-colors shadow-lg hover:shadow-xl">
                        ç«‹å³å¼€å§‹åˆ›ä½œ
                    </button>
                </div>
            </div>

            <!-- åŠŸèƒ½ç‰¹æ€§ -->
            <div id="features" class="grid md:grid-cols-3 gap-8 mb-16">
                <div class="bg-white p-8 rounded-xl shadow-sm hover:shadow-md transition-shadow border border-gray-100">
                    <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mb-4">
                        <i data-lucide="edit-3" class="h-6 w-6 text-blue-600"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-900 mb-2">æ™ºèƒ½å‰§æœ¬åˆ›ä½œ</h3>
                    <p class="text-gray-600">AIè¾…åŠ©å‰§æœ¬åˆ›ä½œï¼Œæ™ºèƒ½å¯¹ç™½ç”Ÿæˆï¼Œå‰§æƒ…ç»“æ„ä¼˜åŒ–ï¼Œè®©æ‚¨çš„æ•…äº‹æ›´å…·å¸å¼•åŠ›ã€‚</p>
                </div>
                <div class="bg-white p-8 rounded-xl shadow-sm hover:shadow-md transition-shadow border border-gray-100">
                    <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mb-4">
                        <i data-lucide="layout-grid" class="h-6 w-6 text-green-600"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-900 mb-2">åˆ†é•œå¯è§†åŒ–</h3>
                    <p class="text-gray-600">ç›´è§‚çš„åˆ†é•œè§„åˆ’å·¥å…·ï¼Œæ‹–æ‹½å¼åœºæ™¯ç®¡ç†ï¼Œè®©æ‚¨çš„è§†è§‰åˆ›æ„ä¸€ç›®äº†ç„¶ã€‚</p>
                </div>
                <div class="bg-white p-8 rounded-xl shadow-sm hover:shadow-md transition-shadow border border-gray-100">
                    <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center mb-4">
                        <i data-lucide="brain" class="h-6 w-6 text-purple-600"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-900 mb-2">AIæ™ºèƒ½åŠ©æ‰‹</h3>
                    <p class="text-gray-600">ä¸“ä¸šçš„AIåˆ›ä½œåŠ©æ‰‹ï¼Œæä¾›å‰§æœ¬åˆ†æã€åˆ›æ„å»ºè®®ã€è‡ªåŠ¨ä¼˜åŒ–ç­‰æ™ºèƒ½åŠŸèƒ½ã€‚</p>
                </div>
            </div>

            <!-- å·¥ä½œæµç¨‹ -->
            <div class="bg-white p-8 rounded-xl shadow-sm border border-gray-100 mb-16">
                <h2 class="text-2xl font-bold text-center text-gray-900 mb-8">ç®€å•ä¸‰æ­¥ï¼Œå®Œæˆåˆ›ä½œ</h2>
                <div class="grid md:grid-cols-3 gap-8">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="text-2xl font-bold text-blue-600">1</span>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">æ„æ€å¤§çº²</h3>
                        <p class="text-gray-600">åˆ›å»ºæ•…äº‹å¤§çº²ï¼Œè®¾å®šè§’è‰²å’Œåœºæ™¯ï¼ŒAIè¾…åŠ©å®Œå–„å‰§æƒ…ç»“æ„ã€‚</p>
                    </div>
                    <div class="text-center">
                        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="text-2xl font-bold text-green-600">2</span>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">åˆ›ä½œå‰§æœ¬</h3>
                        <p class="text-gray-600">æ’°å†™å‰§æœ¬å†…å®¹ï¼ŒAIæ™ºèƒ½ä¼˜åŒ–å¯¹ç™½ï¼Œä¸°å¯Œåœºæ™¯æè¿°ã€‚</p>
                    </div>
                    <div class="text-center">
                        <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="text-2xl font-bold text-purple-600">3</span>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">è§„åˆ’åˆ†é•œ</h3>
                        <p class="text-gray-600">ç”Ÿæˆå¯è§†åŒ–åˆ†é•œï¼ŒAIè¾…åŠ©åˆ†é•œå›¾ç‰‡ç”Ÿæˆï¼Œå®Œæˆæ‹æ‘„è§„åˆ’ã€‚</p>
                    </div>
                </div>
            </div>

            <!-- å¼€å§‹åˆ›ä½œæŒ‰é’® -->
            <div class="text-center">
                <button onclick="showApp()" class="bg-blue-600 text-white px-10 py-4 rounded-lg text-xl font-medium hover:bg-blue-700 transition-colors shadow-lg hover:shadow-xl">
                    å¼€å¯æ‚¨çš„åˆ›ä½œä¹‹æ—…
                </button>
            </div>
        </main>

        <!-- é¡µè„š -->
        <footer class="bg-white border-t border-gray-200 py-8">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="text-center text-gray-500 text-sm">
                    <p>Â© 2024 å½±å‰§å¸ˆ - æ™ºèƒ½å‰§æœ¬åˆ›ä½œä¸åˆ†é•œè§„åˆ’å¹³å°. è®©åˆ›æ„ç…§è¿›ç°å®.</p>
                </div>
            </div>
        </footer>
    </div>

    <!-- ç¼–è¾‘å™¨åº”ç”¨ -->
    <div id="app" class="hidden">

    <!-- Header -->
    <header class="bg-white p-4 flex justify-between items-center border-b border-gray-200">
        <div class="flex items-center space-x-4">
            <h1 class="text-2xl font-bold text-black">
                <i data-lucide="film" class="text-blue-600 mr-2"></i>
                å½±å‰§å¸ˆ
            </h1>
            <div class="hidden md:block">
                <p class="text-sm text-gray-600">æ™ºèƒ½å‰§æœ¬åˆ›ä½œä¸åˆ†é•œè§„åˆ’å¹³å°</p>
                <p class="text-xs text-gray-500">è®©åˆ›æ„ç…§è¿›ç°å® Â· AIé©±åŠ¨çš„å½±è§†åˆ›ä½œåŠ©æ‰‹</p>
            </div>
            <div class="h-px w-16 bg-black mx-4"></div>
            <div class="flex space-x-2">
                <button id="export-project-btn" class="btn-primary px-4 py-2 rounded-md flex items-center space-x-2" onclick="openExportModal()">
                    <i data-lucide="download"></i>
                    <span>å¯¼å‡º</span>
                </button>
            </div>
        </div>
        <div class="flex items-center space-x-4">
            <button id="role-setting-btn" class="nav-link px-3 py-2 rounded-md flex items-center space-x-2" onclick="openRoleModal()">
                <i data-lucide="users"></i>
                <span>è§’è‰²è®¾å®š</span>
            </button>
            <button id="ai-assistant-btn" class="nav-link px-3 py-2 rounded-md flex items-center space-x-2" onclick="toggleAIAssistant()">
                <i data-lucide="bot" class="text-purple-600"></i>
                <span>AIåŠ©æ‰‹</span>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex flex-1 overflow-hidden">

        <!-- Left Sidebar: Outline Tree -->
        <aside class="sidebar w-1/4 flex flex-col relative bg-gray-50">
            <div class="absolute top-0 right-0 h-full w-px bg-gray-200"></div>
            <div class="p-4 border-b border-gray-200 flex items-center">
                <h2 class="text-lg font-light mr-4">å¤§çº²</h2>
                <div class="h-px w-12 bg-black"></div>
            </div>
            <div class="p-4 border-b border-gray-200">
                <div class="flex items-center space-x-2">
                    <input type="text" id="outline-keyword-input" class="bg-white text-black border border-gray-300 rounded-md px-3 py-2 flex-1 focus:outline-none focus:ring-1 focus:ring-black" placeholder="è¾“å…¥å…³é”®è¯...">
                    <select id="outline-structure-select" class="bg-white text-black border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-black">
                        <option value="three-act">ä¸‰å¹•å¼</option>
                        <option value="five-act">äº”å¹•å¼</option>
                    </select>
                    <button id="generate-outline-btn" class="btn-primary px-3 py-2 rounded-md">ç”Ÿæˆ</button>
                </div>
            </div>
            <div id="outline-tree" class="flex-1 p-4 overflow-y-auto">
                <!-- Outline tree will be generated here -->
            </div>
        </aside>

        <!-- Middle Content: Timeline -->
        <section class="main-content w-2/4 p-4 overflow-y-auto relative">
            <div class="absolute top-0 left-0 h-full w-px bg-gray-200"></div>
            <div class="absolute top-0 right-0 h-full w-px bg-gray-200"></div>
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center">
                    <h2 class="text-xl font-light">åˆ†é•œæ—¶é—´è½´</h2>
                    <div class="h-px w-12 bg-black ml-4"></div>
                </div>
                <div class="flex space-x-2">
                    <button id="zoom-in-btn" class="border border-gray-300 text-gray-700 px-2 py-1 rounded-md hover:bg-gray-100">
                        <i data-lucide="zoom-in"></i>
                    </button>
                    <button id="zoom-out-btn" class="border border-gray-300 text-gray-700 px-2 py-1 rounded-md hover:bg-gray-100">
                        <i data-lucide="zoom-out"></i>
                    </button>
                </div>
            </div>
            <div id="timeline" class="space-y-4">
                <!-- Timeline items will be generated here -->
            </div>
        </section>

        <!-- Right Sidebar: Editor -->
        <aside class="editor w-1/4 flex flex-col relative" id="editor-aside">
            <div class="absolute top-0 left-0 h-full w-px bg-gray-200"></div>

            <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                <div class="flex items-center">
                    <h2 class="text-xl font-light">å‰§æœ¬ç¼–è¾‘å™¨</h2>
                    <div class="h-px w-12 bg-black ml-4"></div>
                </div>
                <div class="flex space-x-2">
                    <button onclick="manualSync()" class="btn-primary px-3 py-1 rounded-md flex items-center space-x-1 text-sm">
                        <i data-lucide="save" class="w-4 h-4"></i>
                        <span>ä¿å­˜åŒæ­¥</span>
                    </button>
                    <button id="undo-btn" class="border border-gray-300 text-gray-700 px-2 py-1 rounded-md hover:bg-gray-100">
                        <i data-lucide="undo"></i>
                    </button>
                    <button id="redo-btn" class="border border-gray-300 text-gray-700 px-2 py-1 rounded-md hover:bg-gray-100">
                        <i data-lucide="redo"></i>
                    </button>
                </div>
            </div>

            <div class="flex-1 flex flex-col bg-white border border-gray-200 rounded-lg overflow-hidden">
                <!-- ç¼–è¾‘å™¨å·¥å…·æ  -->
                <div class="bg-gray-50 border-b border-gray-200 p-2 flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <button onclick="formatScript()" class="p-2 hover:bg-gray-200 rounded text-gray-700" title="æ ¼å¼åŒ–å‰§æœ¬">
                            <i data-lucide="layout"></i>
                        </button>
                        <button onclick="insertSceneHeading()" class="p-2 hover:bg-gray-200 rounded text-gray-700" title="æ’å…¥åœºæ™¯æ ‡é¢˜">
                            <i data-lucide="map-pin"></i>
                        </button>
                        <button onclick="insertCharacterName()" class="p-2 hover:bg-gray-200 rounded text-gray-700" title="æ’å…¥è§’è‰²åç§°">
                            <i data-lucide="user"></i>
                        </button>
                        <button onclick="insertDialogue()" class="p-2 hover:bg-gray-200 rounded text-gray-700" title="æ’å…¥å¯¹ç™½">
                            <i data-lucide="message-square"></i>
                        </button>
                        <button onclick="insertAction()" class="p-2 hover:bg-gray-200 rounded text-gray-700" title="æ’å…¥åŠ¨ä½œæè¿°">
                            <i data-lucide="play"></i>
                        </button>
                        <div class="h-4 w-px bg-gray-300 mx-1"></div>
                        <button onclick="undoAction()" class="p-2 hover:bg-gray-200 rounded text-gray-700" title="æ’¤é”€ (Ctrl+Z)">
                            <i data-lucide="rotate-ccw"></i>
                        </button>
                        <button onclick="redoAction()" class="p-2 hover:bg-gray-200 rounded text-gray-700" title="é‡åš (Ctrl+Y)">
                            <i data-lucide="rotate-cw"></i>
                        </button>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button onclick="toggleSearchReplace()" class="p-2 hover:bg-gray-200 rounded text-gray-700" title="æœç´¢æ›¿æ¢ (Ctrl+F)">
                            <i data-lucide="search"></i>
                        </button>
                        <button onclick="toggleWordCount()" class="p-2 hover:bg-gray-200 rounded text-gray-700" title="å­—æ•°ç»Ÿè®¡">
                            <i data-lucide="hash"></i>
                        </button>
                        <button onclick="toggleAutoSave()" class="p-2 hover:bg-gray-200 rounded text-gray-700" title="è‡ªåŠ¨ä¿å­˜">
                            <i data-lucide="save" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
                
                <!-- ç¼–è¾‘å™¨ä¸»ä½“ -->
                <div class="flex-1 relative">
                    <!-- è¡Œå·æ˜¾ç¤º -->
                    <div id="line-numbers" class="absolute top-0 left-0 bottom-0 w-10 bg-gray-50 border-r border-gray-200 text-gray-400 text-right pr-2 pt-4 font-mono text-sm overflow-hidden"></div>
                    
                    <!-- å‰§æœ¬ç¼–è¾‘å™¨ -->
                    <textarea id="script-editor" class="w-full h-full p-4 pl-14 bg-white text-black resize-none outline-none font-mono text-sm leading-relaxed" placeholder="å¼€å§‹åˆ›ä½œä½ çš„å‰§æœ¬..."></textarea>
                    
                    <!-- å­—æ•°ç»Ÿè®¡é¢æ¿ -->
                    <div id="word-count-panel" class="absolute bottom-2 right-2 bg-white border border-gray-200 rounded px-3 py-1 text-xs text-gray-600 shadow-sm hidden">
                        <div>å­—æ•°: <span id="char-count">0</span></div>
                        <div>è¡Œæ•°: <span id="line-count">0</span></div>
                        <div>åœºæ™¯: <span id="scene-count">0</span></div>
                    </div>
                </div>
                
                <!-- çŠ¶æ€æ  -->
                <div class="bg-gray-50 border-t border-gray-200 p-1 flex items-center justify-between text-xs text-gray-600">
                    <div id="cursor-position" class="ml-2">è¡Œ: 1, åˆ—: 1</div>
                    <div id="auto-save-status" class="mr-2">è‡ªåŠ¨ä¿å­˜: å·²å¯ç”¨</div>
                </div>
            </div>
        </aside>

        <!-- AI Assistant Sidebar -->
        <aside id="ai-assistant-panel" class="fixed top-16 right-0 w-80 h-[calc(100vh-4rem)] bg-white shadow-lg transform translate-x-full transition-transform duration-300 ease-in-out z-40 border-l border-gray-200">
            <!-- Pre-loaded AI Assistant content -->
            <div class="h-full flex flex-col bg-white border-l border-gray-200">
                <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-blue-600 rounded-full flex items-center justify-center">
                            <i data-lucide="bot" class="w-4 h-4 text-white"></i>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-900">AIç¼–å‰§åŠ©æ‰‹</h3>
                            <p class="text-xs text-gray-500">éšæ—¶ä¸ºæ‚¨æä¾›åˆ›ä½œå»ºè®®</p>
                        </div>
                    </div>
                    <button onclick="toggleAIAssistant()" class="text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                
                <div id="ai-chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4">
                    <div class="flex items-start space-x-3">
                        <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-blue-600 rounded-full flex-shrink-0 flex items-center justify-center">
                            <i data-lucide="bot" class="w-4 h-4 text-white"></i>
                        </div>
                        <div class="bg-gray-100 rounded-lg p-3 max-w-[80%]">
                            <p class="text-sm text-gray-800">æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„AIç¼–å‰§åŠ©æ‰‹ã€‚æˆ‘å¯ä»¥å¸®æ‚¨ï¼š</p>
                            <ul class="text-xs text-gray-600 mt-2 space-y-1">
                                <li>â€¢ ä¿®æ”¹å‰§æœ¬å¯¹ç™½</li>
                                <li>â€¢ ä¼˜åŒ–åœºæ™¯æè¿°</li>
                                <li>â€¢ æä¾›åˆ›ä½œå»ºè®®</li>
                                <li>â€¢ ç”Ÿæˆè§’è‰²å°è¯</li>
                            </ul>
                            <p class="text-xs text-gray-500 mt-2">è¯·å‘Šè¯‰æˆ‘æ‚¨éœ€è¦ä»€ä¹ˆå¸®åŠ©ï¼Ÿ</p>
                        </div>
                    </div>
                </div>
                
                <div class="p-4 border-t border-gray-200">
                    <div class="flex items-center space-x-2 mb-2">
                        <button onclick="insertSuggestion('ä¼˜åŒ–å½“å‰åœºæ™¯çš„å¯¹ç™½')" class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full hover:bg-blue-200">ä¼˜åŒ–å¯¹ç™½</button>
                        <button onclick="insertSuggestion('æ‰©å±•åœºæ™¯æè¿°')" class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full hover:bg-green-200">æ‰©å±•æè¿°</button>
                        <button onclick="insertSuggestion('æ·»åŠ è§’è‰²å¿ƒç†æ´»åŠ¨')" class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded-full hover:bg-purple-200">å¿ƒç†æ´»åŠ¨</button>
                    </div>
                    <div class="flex items-center space-x-2">
                        <input type="text" id="ai-chat-input" placeholder="è¾“å…¥æ‚¨çš„è¯·æ±‚..." class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button onclick="sendAIMessage()" class="bg-blue-600 text-white rounded-lg px-4 py-2 hover:bg-blue-700">
                            <i data-lucide="send" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            </div>
        </aside>

        <!-- AI Assistant Toggle Button (Floating) -->
        <button id="floating-ai-btn" onclick="toggleAIAssistant()" class="fixed bottom-6 right-6 bg-purple-600 text-white p-4 rounded-full shadow-lg hover:bg-purple-700 transition-all duration-300 z-30 flex items-center justify-center">
            <i data-lucide="bot" class="w-6 h-6"></i>
        </button>

    </main>

    <!-- Export Modal -->
    <div id="export-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg w-full max-w-lg p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-medium">å¯¼å‡ºé¡¹ç›®</h3>
                <button onclick="closeExportModal()" class="text-gray-500 hover:text-gray-700">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">å¯¼å‡ºæ ¼å¼</label>
                    <div class="grid grid-cols-3 gap-3">
                        <label class="flex items-center space-x-2 p-3 border border-gray-300 rounded-md cursor-pointer hover:bg-gray-50">
                            <input type="radio" name="export-format" value="txt" checked="" class="text-black focus:ring-black">
                            <span>TXT</span>
                        </label>
                        <label class="flex items-center space-x-2 p-3 border border-gray-300 rounded-md cursor-pointer hover:bg-gray-50">
                            <input type="radio" name="export-format" value="docx" class="text-black focus:ring-black">
                            <span>DOCX</span>
                        </label>
                        <label class="flex items-center space-x-2 p-3 border border-gray-300 rounded-md cursor-pointer hover:bg-gray-50">
                            <input type="radio" name="export-format" value="fdx" class="text-black focus:ring-black">
                            <span>FDX</span>
                        </label>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">å¯¼å‡ºå†…å®¹</label>
                    <div class="space-y-2">
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" checked="" class="text-black focus:ring-black">
                            <span>å‰§æœ¬å†…å®¹</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" checked="" class="text-black focus:ring-black">
                            <span>åˆ†é•œè„šæœ¬</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" class="text-black focus:ring-black">
                            <span class="text-sm text-gray-600">åŒ…å«å¤§çº²ç»“æ„</span>
                        </label>
                    </div>
                </div>
                <div class="flex justify-between space-x-3">
                    <button onclick="previewExport()" class="flex-1 border border-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-100 flex items-center justify-center space-x-2">
                        <i data-lucide="eye" class="w-4 h-4"></i>
                        <span>é¢„è§ˆ</span>
                    </button>
                    <button onclick="exportProject()" class="flex-1 btn-primary px-4 py-2 rounded-md flex items-center justify-center space-x-2">
                        <i data-lucide="download" class="w-4 h-4"></i>
                        <span>å¯¼å‡º</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Role Setting Modal -->
    <div id="role-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg w-full max-w-4xl h-[80vh] flex flex-col">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                <h3 id="role-modal-title" class="text-lg font-medium">è§’è‰²è®¾å®š</h3>
                <button onclick="closeRoleModal()" class="text-gray-500 hover:text-gray-700">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="flex flex-1 overflow-hidden">
                <div class="w-1/3 border-r border-gray-200 overflow-y-auto">
                    <div class="p-4 border-b border-gray-200">
                        <button onclick="addRole()" class="w-full btn-primary px-4 py-2 rounded-md flex items-center justify-center space-x-2">
                            <i data-lucide="plus"></i>
                            <span>æ·»åŠ è§’è‰²</span>
                        </button>
                    </div>
                    <div id="roles-list" class="p-4">
                        <!-- Roles list will be generated here -->
                    </div>
                </div>
                <div class="w-2/3 p-6 overflow-y-auto">
                    <form id="role-form" class="space-y-4">
                        <input type="hidden" id="role-id">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="role-name" class="block text-sm font-medium text-gray-700 mb-1">è§’è‰²åç§°</label>
                                <input type="text" id="role-name" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-black">
                            </div>
                            <div>
                                <label for="role-age" class="block text-sm font-medium text-gray-700 mb-1">å¹´é¾„</label>
                                <input type="number" id="role-age" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-black">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="role-gender" class="block text-sm font-medium text-gray-700 mb-1">æ€§åˆ«</label>
                                <select id="role-gender" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-black">
                                    <option value="ç”·">ç”·</option>
                                    <option value="å¥³">å¥³</option>
                                    <option value="å…¶ä»–">å…¶ä»–</option>
                                </select>
                            </div>
                            <div>
                                <label for="role-personality" class="block text-sm font-medium text-gray-700 mb-1">æ€§æ ¼ç‰¹ç‚¹</label>
                                <input type="text" id="role-personality" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-black">
                            </div>
                        </div>
                        <div>
                            <label for="role-background" class="block text-sm font-medium text-gray-700 mb-1">èƒŒæ™¯æ•…äº‹</label>
                            <textarea id="role-background" rows="3" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-black"></textarea>
                        </div>
                        <div>
                            <label for="role-relationships" class="block text-sm font-medium text-gray-700 mb-1">äººç‰©å…³ç³»</label>
                            <textarea id="role-relationships" rows="2" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-black"></textarea>
                        </div>
                        <div>
                            <label for="role-appearance" class="block text-sm font-medium text-gray-700 mb-1">å¤–è²Œç‰¹å¾</label>
                            <textarea id="role-appearance" rows="2" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-black"></textarea>
                        </div>
                        <div>
                            <label for="role-goal" class="block text-sm font-medium text-gray-700 mb-1">ç›®æ ‡åŠ¨æœº</label>
                            <textarea id="role-goal" rows="2" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-black"></textarea>
                        </div>
                        <div class="flex justify-end space-x-3">
                            <button type="button" onclick="closeRoleModal()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-100">å–æ¶ˆ</button>
                            <button type="submit" class="px-4 py-2 btn-primary rounded-md">ä¿å­˜è§’è‰²</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Debug Mode ---
        console.log('ğŸ” æ™ºèƒ½å‰§æœ¬åˆ›ä½œå·¥å…· - è°ƒè¯•æ¨¡å¼å¯åŠ¨');
        console.log('ğŸ“… å½“å‰æ—¶é—´:', new Date().toLocaleString());
        console.log('ğŸ”§ è„šæœ¬æ ‡ç­¾å·²è¢«æ‰¾åˆ°å¹¶æ‰§è¡Œ');

        // --- AIåŠ©æ‰‹åŠŸèƒ½ ---
        let aiAssistantVisible = false;
        let aiChatHistory = [];
        
        function toggleAIAssistant() {
            aiAssistantVisible = !aiAssistantVisible;
            const assistantPanel = document.getElementById('ai-assistant-panel');
            
            if (aiAssistantVisible) {
                assistantPanel.classList.remove('translate-x-full');
                loadAIAssistant();
            } else {
                assistantPanel.classList.add('translate-x-full');
            }
        }
        
        function loadAIAssistant() {
            const panel = document.getElementById('ai-assistant-panel');
            if (!panel.innerHTML.trim()) {
                panel.innerHTML = `
                    <div class="h-full flex flex-col bg-white border-l border-gray-200">
                        <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-blue-600 rounded-full flex items-center justify-center">
                                    <i data-lucide="bot" class="w-4 h-4 text-white"></i>
                                </div>
                                <div>
                                    <h3 class="font-semibold text-gray-900">AIç¼–å‰§åŠ©æ‰‹</h3>
                                    <p class="text-xs text-gray-500">éšæ—¶ä¸ºæ‚¨æä¾›åˆ›ä½œå»ºè®®</p>
                                </div>
                            </div>
                            <button onclick="toggleAIAssistant()" class="text-gray-400 hover:text-gray-600">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                        
                        <div id="ai-chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4">
                            <div class="flex items-start space-x-3">
                                <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-blue-600 rounded-full flex-shrink-0 flex items-center justify-center">
                                    <i data-lucide="bot" class="w-4 h-4 text-white"></i>
                                </div>
                                <div class="bg-gray-100 rounded-lg p-3 max-w-[80%]">
                                    <p class="text-sm text-gray-800">æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„AIç¼–å‰§åŠ©æ‰‹ã€‚æˆ‘å¯ä»¥å¸®æ‚¨ï¼š</p>
                                    <ul class="text-xs text-gray-600 mt-2 space-y-1">
                                        <li>â€¢ ä¿®æ”¹å‰§æœ¬å¯¹ç™½</li>
                                        <li>â€¢ ä¼˜åŒ–åœºæ™¯æè¿°</li>
                                        <li>â€¢ æä¾›åˆ›ä½œå»ºè®®</li>
                                        <li>â€¢ ç”Ÿæˆè§’è‰²å°è¯</li>
                                    </ul>
                                    <p class="text-xs text-gray-500 mt-2">è¯·å‘Šè¯‰æˆ‘æ‚¨éœ€è¦ä»€ä¹ˆå¸®åŠ©ï¼Ÿ</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="p-4 border-t border-gray-200">
                            <!-- å¤§å‹åº”ç”¨æŒ‰é’® -->
                            <div class="mb-4">
                                <button onclick="applyLatestAISuggestion()" class="w-full bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700 transition-all duration-200 shadow hover:shadow-md flex items-center justify-center text-base font-medium">
                                    <i data-lucide="check-circle" class="w-5 h-5 mr-2"></i>
                                    åº”ç”¨AIå»ºè®®åˆ°å‰§æœ¬
                                </button>
                            </div>
                            
                            <div class="flex items-center space-x-2 mb-2">
                                <button onclick="insertSuggestion('ä¼˜åŒ–å½“å‰åœºæ™¯çš„å¯¹ç™½')" class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full hover:bg-blue-200">ä¼˜åŒ–å¯¹ç™½</button>
                                <button onclick="insertSuggestion('æ‰©å±•åœºæ™¯æè¿°')" class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full hover:bg-green-200">æ‰©å±•æè¿°</button>
                                <button onclick="insertSuggestion('æ·»åŠ è§’è‰²å¿ƒç†æ´»åŠ¨')" class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded-full hover:bg-purple-200">å¿ƒç†æ´»åŠ¨</button>
                            </div>
                            <div class="flex items-center space-x-2 mb-3">
                                <button onclick="autoImproveScript()" class="text-xs bg-orange-100 text-orange-700 px-2 py-1 rounded-full hover:bg-orange-200">
                                    <i data-lucide="wand-2" class="w-3 h-3 inline mr-1"></i>
                                    æ™ºèƒ½ä¼˜åŒ–
                                </button>
                                <button onclick="analyzeScript()" class="text-xs bg-teal-100 text-teal-700 px-2 py-1 rounded-full hover:bg-teal-200">
                                    <i data-lucide="bar-chart-2" class="w-3 h-3 inline mr-1"></i>
                                    å‰§æœ¬åˆ†æ
                                </button>
                            </div>
                            <div class="flex items-center space-x-2">
                                <input type="text" id="ai-chat-input" placeholder="è¾“å…¥æ‚¨çš„è¯·æ±‚..." class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <button onclick="sendAIMessage()" class="bg-blue-600 text-white rounded-lg px-4 py-2 hover:bg-blue-700">
                                    <i data-lucide="send" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                lucide.createIcons();
                
                // ç»‘å®šå›è½¦å‘é€
                document.getElementById('ai-chat-input').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendAIMessage();
                    }
                });
            }
        }
        
        function insertSuggestion(text) {
            const input = document.getElementById('ai-chat-input');
            input.value = text;
            input.focus();
        }
        
        async function sendAIMessage() {
            const input = document.getElementById('ai-chat-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°ç•Œé¢
            addChatMessage('user', message);
            input.value = '';
            
            // æ˜¾ç¤ºAIæ­£åœ¨è¾“å…¥
            showAItyping();
            
            try {
                // å‡†å¤‡ä¸Šä¸‹æ–‡
                const currentScene = getCurrentScene();
                const currentShot = getCurrentShot();
                let scriptContent = '';
                
                // å°è¯•è·å–å‰§æœ¬å†…å®¹ï¼Œä½¿ç”¨æ›´å¯é çš„æ–¹å¼
                const scriptEditor = document.getElementById('script-editor');
                if (scriptEditor) {
                    scriptContent = scriptEditor.value || '';
                } else {
                    console.log('ğŸ“ æœªæ‰¾åˆ°å‰§æœ¬ç¼–è¾‘å™¨ï¼Œä½¿ç”¨ç©ºå†…å®¹');
                }
                
                const context = {
                    projectTitle: document.getElementById('project-title')?.value || 'æœªå‘½åé¡¹ç›®',
                    currentScene: currentScene,
                    currentShot: currentShot,
                    scriptContent: scriptContent,
                    chatHistory: aiChatHistory
                };
                
                // è°ƒç”¨AI API
                const response = await callAIAssistant(message, context);
                
                // éšè—æ­£åœ¨è¾“å…¥çŠ¶æ€
                hideAItyping();
                
                // æ·»åŠ AIå›å¤åˆ°ç•Œé¢
                addChatMessage('ai', response);
                
                // æ›´æ–°èŠå¤©å†å²
                aiChatHistory.push({
                    role: 'user',
                    content: message
                });
                aiChatHistory.push({
                    role: 'assistant',
                    content: response
                });
                
                // å¦‚æœAIå›å¤åŒ…å«ä¿®æ”¹å»ºè®®ï¼Œæä¾›åº”ç”¨æŒ‰é’®
                if (response.includes('**ä¿®æ”¹å»ºè®®**') || response.includes('**ä¼˜åŒ–ç»“æœ**') || response.includes('**æ™ºèƒ½ä¼˜åŒ–ç»“æœ**')) {
                    setTimeout(() => {
                        showApplyButton(response);
                    }, 500);
                }
                
            } catch (error) {
                console.error('âŒ AIåŠ©æ‰‹è°ƒç”¨å¤±è´¥:', error);
                hideAItyping();
                addChatMessage('ai', 'æŠ±æ­‰ï¼Œæˆ‘æš‚æ—¶æ— æ³•æä¾›å¸®åŠ©ã€‚è¯·ç¨åé‡è¯•ã€‚');
            }
        }
        
        async function callAIAssistant(message, context) {
            if (!getDecodedApiKey()) {
                throw new Error('âŒ AI API Keyæœªé…ç½®');
            }
            
            const prompt = `
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„AIç¼–å‰§åŠ©æ‰‹ï¼Œå¸®åŠ©ç”¨æˆ·åˆ›ä½œå’Œä¿®æ”¹å‰§æœ¬ã€‚

**é¡¹ç›®ä¿¡æ¯ï¼š**
- é¡¹ç›®æ ‡é¢˜ï¼š${context.projectTitle}
- å½“å‰åœºæ™¯ï¼š${context.currentScene ? context.currentScene.title : 'æ— '}
- å½“å‰åˆ†é•œï¼š${context.currentShot ? context.currentShot.title : 'æ— '}

**å½“å‰å‰§æœ¬å†…å®¹ï¼š**
${context.scriptContent.substring(0, 1000)}${context.scriptContent.length > 1000 ? '...' : ''}

**ç”¨æˆ·è¯·æ±‚ï¼š**
${message}

**å¯¹è¯å†å²ï¼š**
${context.chatHistory.map(msg => `${msg.role === 'user' ? 'ç”¨æˆ·' : 'åŠ©æ‰‹'}: ${msg.content}`).join('\n')}

è¯·æ ¹æ®ä»¥ä¸Šä¿¡æ¯ï¼Œä»¥ä¸“ä¸šç¼–å‰§çš„èº«ä»½æä¾›å¸®åŠ©ã€‚å¦‚æœç”¨æˆ·è¦æ±‚ä¿®æ”¹å‰§æœ¬ï¼Œè¯·æä¾›å…·ä½“çš„ä¿®æ”¹å»ºè®®ï¼Œå¹¶ä½¿ç”¨**ä¿®æ”¹å»ºè®®**æˆ–**ä¼˜åŒ–ç»“æœ**æ ‡è®°ä¿®æ”¹å†…å®¹ã€‚
            `.trim();
            
            const response = await fetch(`${AI_CONFIG.baseUrl}/chat/completions`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getDecodedApiKey()}`
                },
                body: JSON.stringify({
                    model: AI_CONFIG.defaultModel,
                    messages: [
                        {
                            role: 'system',
                            content: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„AIç¼–å‰§åŠ©æ‰‹ï¼Œç²¾é€šå‰§æœ¬åˆ›ä½œã€å¯¹ç™½è®¾è®¡ã€åœºæ™¯æ„å»ºç­‰ã€‚'
                        },
                        {
                            role: 'user',
                            content: prompt
                        }
                    ],
                    max_tokens: 2000,
                    temperature: 0.7
                })
            });
            
            if (!response.ok) {
                throw new Error(`APIè°ƒç”¨å¤±è´¥: ${response.statusText}`);
            }
            
            const data = await response.json();
            return data.choices[0].message.content;
        }
        
        function addChatMessage(role, content) {
            const messagesContainer = document.getElementById('ai-chat-messages');
            const messageDiv = document.createElement('div');
            
            if (role === 'user') {
                messageDiv.className = 'flex items-start justify-end space-x-3';
                messageDiv.innerHTML = `
                    <div class="bg-blue-600 text-white rounded-lg p-3 max-w-[80%]">
                        <p class="text-sm">${content}</p>
                    </div>
                    <div class="w-8 h-8 bg-gray-300 rounded-full flex-shrink-0 flex items-center justify-center">
                        <i data-lucide="user" class="w-4 h-4 text-gray-600"></i>
                    </div>
                `;
            } else {
                messageDiv.className = 'flex items-start space-x-3';
                messageDiv.innerHTML = `
                    <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-blue-600 rounded-full flex-shrink-0 flex items-center justify-center">
                        <i data-lucide="bot" class="w-4 h-4 text-white"></i>
                    </div>
                    <div class="bg-gray-100 rounded-lg p-3 max-w-[80%]">
                        <div class="text-sm text-gray-800 whitespace-pre-wrap">${formatAIMessage(content)}</div>
                    </div>
                `;
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            lucide.createIcons();
        }
        
        function formatAIMessage(content) {
            // ç®€å•çš„Markdownæ ¼å¼æ”¯æŒ
            return content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br>');
        }
        
        function showAItyping() {
            const messagesContainer = document.getElementById('ai-chat-messages');
            const typingDiv = document.createElement('div');
            typingDiv.id = 'ai-typing';
            typingDiv.className = 'flex items-start space-x-3';
            typingDiv.innerHTML = `
                <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-blue-600 rounded-full flex-shrink-0 flex items-center justify-center">
                    <i data-lucide="bot" class="w-4 h-4 text-white"></i>
                </div>
                <div class="bg-gray-100 rounded-lg p-3">
                    <div class="flex space-x-1">
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
                    </div>
                </div>
            `;
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            lucide.createIcons();
        }
        
        function hideAItyping() {
            const typingDiv = document.getElementById('ai-typing');
            if (typingDiv) {
                typingDiv.remove();
            }
        }
        
        function showApplyButton(message) {
            console.log('ğŸ” å°è¯•æ˜¾ç¤ºåº”ç”¨æŒ‰é’®ï¼Œæ¶ˆæ¯å†…å®¹:', message.substring(0, 100) + '...');
            
            // å°è¯•å¤šç§å¯èƒ½çš„ä¿®æ”¹å»ºè®®æ ¼å¼
            const patterns = [
                { regex: /\*\*ä¿®æ”¹å»ºè®®\*\*(.*?)(\*\*|$)/s, name: 'ä¿®æ”¹å»ºè®®' },
                { regex: /\*\*ä¼˜åŒ–ç»“æœ\*\*(.*?)(\*\*|$)/s, name: 'ä¼˜åŒ–ç»“æœ' },
                { regex: /\*\*æ™ºèƒ½ä¼˜åŒ–ç»“æœ\*\*(.*?)(\*\*|$)/s, name: 'æ™ºèƒ½ä¼˜åŒ–ç»“æœ' },
                { regex: /ä¿®æ”¹å»ºè®®ï¼š(.*?)(\n\n|\*\*|$)/s, name: 'ä¿®æ”¹å»ºè®®' },
                { regex: /ä¼˜åŒ–ç»“æœï¼š(.*?)(\n\n|\*\*|$)/s, name: 'ä¼˜åŒ–ç»“æœ' }
            ];
            
            let suggestion = null;
            let matchedPattern = null;
            
            for (const pattern of patterns) {
                const match = message.match(pattern.regex);
                if (match) {
                    suggestion = match[1].trim();
                    matchedPattern = pattern.name;
                    console.log(`âœ… æ‰¾åˆ°${pattern.name}æ ¼å¼çš„ä¿®æ”¹å†…å®¹`);
                    break;
                }
            }
            
            if (!suggestion) {
                console.log('âš ï¸ æœªæ‰¾åˆ°æ ‡å‡†æ ¼å¼çš„ä¿®æ”¹å»ºè®®ï¼Œä½¿ç”¨æ•´ä¸ªæ¶ˆæ¯ä½œä¸ºä¿®æ”¹å†…å®¹');
                suggestion = message;
                matchedPattern = 'å®Œæ•´æ¶ˆæ¯';
            }
            
            // æŸ¥æ‰¾æœ€æ–°çš„AIæ¶ˆæ¯å…ƒç´ 
            const messages = document.querySelectorAll('#ai-chat-messages > div');
            let lastAIMessage = null;
            
            for (let i = messages.length - 1; i >= 0; i--) {
                if (messages[i].querySelector('.bg-gradient-to-br.from-purple-500.to-blue-600')) {
                    lastAIMessage = messages[i];
                    break;
                }
            }
            
            if (!lastAIMessage) {
                console.error('âŒ æœªæ‰¾åˆ°AIæ¶ˆæ¯å…ƒç´ ');
                return;
            }
            
            const aiMessageDiv = lastAIMessage.querySelector('.bg-gray-100');
            if (!aiMessageDiv) {
                console.error('âŒ æœªæ‰¾åˆ°AIæ¶ˆæ¯å†…å®¹å…ƒç´ ');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰åº”ç”¨æŒ‰é’®
            if (aiMessageDiv.querySelector('button')) {
                console.log('â„¹ï¸ å·²ç»å­˜åœ¨åº”ç”¨æŒ‰é’®ï¼Œä¸å†é‡å¤æ·»åŠ ');
                return;
            }
            
            // åˆ›å»ºåº”ç”¨æŒ‰é’®
            const applyButton = document.createElement('button');
            applyButton.className = 'mt-3 text-xs bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition-colors';
            applyButton.textContent = `åº”ç”¨${matchedPattern}`;
            applyButton.onclick = () => {
                console.log('ğŸš€ ç”¨æˆ·ç‚¹å‡»åº”ç”¨æŒ‰é’®ï¼Œåº”ç”¨ä¿®æ”¹å†…å®¹');
                applyAISuggestion(suggestion);
            };
            
            // æ·»åŠ æŒ‰é’®åˆ°æ¶ˆæ¯ä¸­
            aiMessageDiv.appendChild(applyButton);
            console.log('âœ… åº”ç”¨æŒ‰é’®å·²æ·»åŠ åˆ°AIæ¶ˆæ¯ä¸­');
        }
        
        function applyAISuggestion(suggestion) {
            console.log('ğŸ­ å¼€å§‹åº”ç”¨AIå»ºè®®:', suggestion.substring(0, 100) + '...');
            
            const scriptEditor = document.getElementById('script-editor');
            if (!scriptEditor) {
                showToast('âŒ æœªæ‰¾åˆ°å‰§æœ¬ç¼–è¾‘å™¨');
                return;
            }
            
            // æ¸…ç©ºç°æœ‰åˆ†é•œæ•°æ®ï¼Œé¿å…é‡å¤
            console.log('ğŸ—‘ï¸  æ¸…ç©ºç°æœ‰åˆ†é•œæ•°æ®ä»¥é¿å…é‡å¤');
            currentProject.acts.forEach(act => {
                act.scenes.forEach(scene => {
                    scene.shots = [];
                });
            });
            
            // ç›´æ¥æ›¿æ¢å‰§æœ¬å†…å®¹ï¼ˆä¸è¿½åŠ ï¼‰
            scriptEditor.value = suggestion;
            currentProject.script = suggestion;
            
            // è§¦å‘inputäº‹ä»¶
            scriptEditor.dispatchEvent(new Event('input', { bubbles: true }));
            
            // å¼ºåˆ¶é‡æ–°è§£æå‰§æœ¬å¹¶ç”Ÿæˆåˆ†é•œ
            console.log('ğŸ”„ å¼ºåˆ¶é‡æ–°è§£æå‰§æœ¬å¹¶ç”Ÿæˆåˆ†é•œ');
            setTimeout(() => {
                try {
                    // å¼ºåˆ¶é‡æ–°è§£æå‰§æœ¬
                    parseScriptToScenes(suggestion);
                    
                    // é‡æ–°æ¸²æŸ“åœºæ™¯åˆ—è¡¨
                    renderSceneList();
                    
                    // é‡æ–°æ¸²æŸ“åˆ†é•œæ—¶é—´è½´
                    renderStoryboardTimeline();
                    
                    showToast('âœ… AIå»ºè®®å·²æˆåŠŸåº”ç”¨å¹¶é‡æ–°ç”Ÿæˆåˆ†é•œï¼');
                    console.log('âœ… AIå»ºè®®åº”ç”¨å®Œæˆï¼Œåˆ†é•œå·²é‡æ–°ç”Ÿæˆ');
                } catch (error) {
                    console.error('âŒ é‡æ–°ç”Ÿæˆåˆ†é•œæ—¶å‡ºé”™:', error);
                    showToast('âš ï¸ åº”ç”¨æˆåŠŸï¼Œä½†åˆ†é•œç”Ÿæˆå‡ºç°é—®é¢˜ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥');
                }
            }, 200);
        }
        
        function getCurrentScene() {
            const selectedSceneId = document.querySelector('.scene-item.bg-blue-100')?.dataset.sceneId;
            if (selectedSceneId) {
                return findSceneById(selectedSceneId);
            }
            return null;
        }
        
        function getCurrentShot() {
            const selectedShotId = document.querySelector('.shot-card.bg-blue-100')?.dataset.shotId;
            if (selectedShotId) {
                return findShotById(selectedShotId);
            }
            return null;
        }

        // --- AIä¸»åŠ¨ä¿®æ”¹åŠŸèƒ½ ---
        async function autoImproveScript() {
            const scriptEditor = document.getElementById('script-editor');
            const scriptContent = scriptEditor ? scriptEditor.value : '';
            
            if (!scriptContent.trim()) {
                showToast('å‰§æœ¬å†…å®¹ä¸ºç©ºï¼Œæ— æ³•è¿›è¡Œæ™ºèƒ½ä¼˜åŒ–');
                return;
            }
            
            // æ˜¾ç¤ºAIæ­£åœ¨å·¥ä½œ
            addChatMessage('ai', 'æ­£åœ¨åˆ†ææ‚¨çš„å‰§æœ¬å¹¶è¿›è¡Œæ™ºèƒ½ä¼˜åŒ–...');
            showAItyping();
            
            try {
                const prompt = `
è¯·å¯¹ä»¥ä¸‹å‰§æœ¬å†…å®¹è¿›è¡Œå…¨é¢çš„æ™ºèƒ½ä¼˜åŒ–ï¼š

1. æ£€æŸ¥å¹¶æ”¹è¿›å¯¹ç™½çš„è‡ªç„¶åº¦å’Œè¡¨ç°åŠ›
2. å¢å¼ºåœºæ™¯æè¿°çš„ç”»é¢æ„Ÿå’Œç»†èŠ‚
3. ä¼˜åŒ–æƒ…èŠ‚èŠ‚å¥å’Œäººç‰©åŠ¨æœº
4. æå‡ºå…·ä½“çš„ä¿®æ”¹å»ºè®®

å‰§æœ¬å†…å®¹ï¼š
${scriptContent.substring(0, 1500)}${scriptContent.length > 1500 ? '...' : ''}

è¯·æä¾›è¯¦ç»†çš„ä¼˜åŒ–å»ºè®®ï¼Œå¹¶ä½¿ç”¨**æ™ºèƒ½ä¼˜åŒ–ç»“æœ**æ ‡è®°æœ€ç»ˆçš„ä¼˜åŒ–å†…å®¹ã€‚
                `.trim();
                
                const response = await callAIAssistant(prompt, {
                    projectTitle: document.getElementById('project-title')?.value || 'æœªå‘½åé¡¹ç›®',
                    currentScene: getCurrentScene(),
                    currentShot: getCurrentShot(),
                    scriptContent: scriptContent,
                    chatHistory: aiChatHistory
                });
                
                hideAItyping();
                addChatMessage('ai', response);
                
                // å¦‚æœåŒ…å«ä¼˜åŒ–ç»“æœï¼Œè‡ªåŠ¨æä¾›åº”ç”¨æŒ‰é’®
                if (response.includes('**æ™ºèƒ½ä¼˜åŒ–ç»“æœ**')) {
                    setTimeout(() => {
                        const match = response.match(/\*\*æ™ºèƒ½ä¼˜åŒ–ç»“æœ\*\*(.*?)(\*\*|$)/s);
                        if (match) {
                            const optimizedContent = match[1].trim();
                            showAutoApplyButton(optimizedContent);
                        }
                    }, 500);
                }
                
            } catch (error) {
                console.error('âŒ æ™ºèƒ½ä¼˜åŒ–å¤±è´¥:', error);
                hideAItyping();
                addChatMessage('ai', 'æ™ºèƒ½ä¼˜åŒ–å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        async function analyzeScript() {
            const scriptEditor = document.getElementById('script-editor');
            const scriptContent = scriptEditor ? scriptEditor.value : '';
            
            if (!scriptContent.trim()) {
                showToast('å‰§æœ¬å†…å®¹ä¸ºç©ºï¼Œæ— æ³•è¿›è¡Œåˆ†æ');
                return;
            }
            
            // æ˜¾ç¤ºAIæ­£åœ¨å·¥ä½œ
            addChatMessage('ai', 'æ­£åœ¨å¯¹æ‚¨çš„å‰§æœ¬è¿›è¡Œä¸“ä¸šåˆ†æ...');
            showAItyping();
            
            try {
                const prompt = `
è¯·å¯¹ä»¥ä¸‹å‰§æœ¬å†…å®¹è¿›è¡Œä¸“ä¸šåˆ†æï¼š

1. æƒ…èŠ‚ç»“æ„åˆ†æï¼ˆèµ·æ‰¿è½¬åˆã€å†²çªè®¾ç½®ç­‰ï¼‰
2. äººç‰©å¡‘é€ è¯„ä»·ï¼ˆè§’è‰²ä¸°æ»¡åº¦ã€åŠ¨æœºåˆç†æ€§ç­‰ï¼‰
3. å¯¹ç™½è´¨é‡è¯„ä¼°ï¼ˆè‡ªç„¶åº¦ã€æ€§æ ¼åŒ–ç­‰ï¼‰
4. åœºæ™¯æå†™åˆ†æï¼ˆç”»é¢æ„Ÿã€ç»†èŠ‚ä¸°å¯Œåº¦ç­‰ï¼‰
5. æ•´ä½“èŠ‚å¥è¯„ä¼°
6. å…·ä½“çš„æ”¹è¿›å»ºè®®

å‰§æœ¬å†…å®¹ï¼š
${scriptContent.substring(0, 1500)}${scriptContent.length > 1500 ? '...' : ''}

è¯·æä¾›è¯¦ç»†çš„åˆ†ææŠ¥å‘Šï¼Œä½¿ç”¨ä¸“ä¸šçš„å‰§æœ¬åˆ†ææœ¯è¯­ã€‚
                `.trim();
                
                const response = await callAIAssistant(prompt, {
                    projectTitle: document.getElementById('project-title')?.value || 'æœªå‘½åé¡¹ç›®',
                    currentScene: getCurrentScene(),
                    currentShot: getCurrentShot(),
                    scriptContent: scriptContent,
                    chatHistory: aiChatHistory
                });
                
                hideAItyping();
                addChatMessage('ai', response);
                
            } catch (error) {
                console.error('âŒ å‰§æœ¬åˆ†æå¤±è´¥:', error);
                hideAItyping();
                addChatMessage('ai', 'å‰§æœ¬åˆ†æå¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        function showAutoApplyButton(optimizedContent) {
            const lastMessage = document.querySelector('#ai-chat-messages > div:last-child');
            const aiMessageDiv = lastMessage.querySelector('.bg-gray-100');
            
            const applyButton = document.createElement('button');
            applyButton.className = 'mt-2 text-xs bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700';
            applyButton.textContent = 'åº”ç”¨ä¼˜åŒ–';
            applyButton.onclick = () => applyAutoOptimization(optimizedContent);
            
            aiMessageDiv.appendChild(applyButton);
        }
        
        function applyLatestAISuggestion() {
            console.log('ğŸ¯ ç”¨æˆ·ç‚¹å‡»äº†åº”ç”¨å»ºè®®æŒ‰é’®');
            
            // è·å–æœ€æ–°çš„AIæ¶ˆæ¯
            const messages = document.querySelectorAll('#ai-chat-messages > div');
            let latestAIMessage = null;
            let latestAIContent = '';
            
            for (let i = messages.length - 1; i >= 0; i--) {
                const message = messages[i];
                if (message.querySelector('.bg-gradient-to-br.from-purple-500.to-blue-600')) {
                    const contentDiv = message.querySelector('.bg-gray-100');
                    if (contentDiv) {
                        latestAIContent = contentDiv.textContent || contentDiv.innerText;
                        latestAIMessage = message;
                        console.log('ğŸ“ æ‰¾åˆ°æœ€æ–°AIæ¶ˆæ¯:', latestAIContent.substring(0, 50) + '...');
                        break;
                    }
                }
            }
            
            if (!latestAIMessage || !latestAIContent.trim()) {
                showToast('âŒ æœªæ‰¾åˆ°AIå»ºè®®å†…å®¹');
                return;
            }
            
            // å°è¯•æå–ä¿®æ”¹å»ºè®®å†…å®¹
            let suggestion = null;
            
            // å°è¯•å¤šç§æ ¼å¼
            const patterns = [
                { regex: /\*\*ä¿®æ”¹å»ºè®®\*\*(.*?)(\*\*|$)/s, name: 'ä¿®æ”¹å»ºè®®' },
                { regex: /\*\*ä¼˜åŒ–ç»“æœ\*\*(.*?)(\*\*|$)/s, name: 'ä¼˜åŒ–ç»“æœ' },
                { regex: /\*\*æ™ºèƒ½ä¼˜åŒ–ç»“æœ\*\*(.*?)(\*\*|$)/s, name: 'æ™ºèƒ½ä¼˜åŒ–ç»“æœ' },
                { regex: /ä¿®æ”¹å»ºè®®ï¼š(.*?)(\n\n|\*\*|$)/s, name: 'ä¿®æ”¹å»ºè®®' },
                { regex: /ä¼˜åŒ–ç»“æœï¼š(.*?)(\n\n|\*\*|$)/s, name: 'ä¼˜åŒ–ç»“æœ' }
            ];
            
            for (const pattern of patterns) {
                const match = latestAIContent.match(pattern.regex);
                if (match) {
                    suggestion = match[1].trim();
                    console.log(`âœ… æå–åˆ°${pattern.name}æ ¼å¼çš„å†…å®¹`);
                    break;
                }
            }
            
            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç‰¹å®šæ ¼å¼ï¼Œä½¿ç”¨æ•´ä¸ªæ¶ˆæ¯å†…å®¹
            if (!suggestion) {
                console.log('â„¹ï¸ æœªæ‰¾åˆ°æ ‡å‡†æ ¼å¼ï¼Œä½¿ç”¨å®Œæ•´æ¶ˆæ¯å†…å®¹');
                suggestion = latestAIContent;
            }
            
            // åº”ç”¨ä¿®æ”¹
            if (suggestion) {
                console.log('ğŸš€ å‡†å¤‡åº”ç”¨ä¿®æ”¹å†…å®¹');
                applyAISuggestion(suggestion);
            } else {
                showToast('âŒ æ— æ³•æå–æœ‰æ•ˆçš„ä¿®æ”¹å†…å®¹');
            }
        }

        function applyAutoOptimization(optimizedContent) {
            console.log('ğŸ”§ åº”ç”¨è‡ªåŠ¨ä¼˜åŒ–å†…å®¹');
            const scriptEditor = document.getElementById('script-editor');
            if (scriptEditor) {
                // æ›¿æ¢æ•´ä¸ªå‰§æœ¬å†…å®¹
                scriptEditor.value = optimizedContent;
                
                // æ›´æ–°åº”ç”¨çŠ¶æ€
                currentProject.script = optimizedContent;
                
                // è§¦å‘inputäº‹ä»¶ä»¥ç¡®ä¿ç•Œé¢æ›´æ–°
                scriptEditor.dispatchEvent(new Event('input', { bubbles: true }));
                
                // æ‰‹åŠ¨åŒæ­¥åˆ°åˆ†é•œå’Œå¤§çº²
                setTimeout(() => {
                    manualSync();
                }, 100);
                
                showToast('âœ… å‰§æœ¬å·²è‡ªåŠ¨ä¼˜åŒ–å®Œæˆå¹¶åŒæ­¥ï¼');
            } else {
                showToast('âŒ æ— æ³•åº”ç”¨ä¼˜åŒ–ï¼Œæœªæ‰¾åˆ°å‰§æœ¬ç¼–è¾‘å™¨');
            }
        }

        // --- AI Configuration ---
        const AI_CONFIG = {
            baseUrl: 'https://api-inference.modelscope.cn/v1',
            apiKey: 'bXMtNzczMzkyNDEtZTQ3Mi00MmNkLWFkODctODVhYzU0ZGUyNTA1', // Base64ç¼–ç çš„API Key
            defaultModel: 'Qwen/Qwen2.5-72B-Instruct',
            imageModel: 'Tongyi-MAI/Z-Image-Turbo'
        };

        // è§£å¯†APIå¯†é’¥çš„å‡½æ•°
        function getDecodedApiKey() {
            try {
                return atob(AI_CONFIG.apiKey);
            } catch (error) {
                console.error('âŒ APIå¯†é’¥è§£ç å¤±è´¥:', error);
                return '';
            }
        }

        // --- App State ---
        let currentProject = {
            title: 'æš—å¤œè¿½å‡¶ï¼šè¿·é›¾çœŸç›¸',
            outline: [],
            roles: [
                { id: '1', name: 'é™ˆé˜³', description: '35å²ï¼Œå‰åˆ‘è­¦é˜Ÿé•¿ï¼Œè¢«åœèŒè°ƒæŸ¥ï¼Œæ­£ç›´å‹‡æ•¢ï¼Œæ“…é•¿æ¨ç†ï¼Œçœ¼ç¥é”åˆ©ï¼Œé¢å®¹åšæ¯…ã€‚æ›¾æ˜¯è­¦é˜Ÿä¼ å¥‡ï¼Œå› è¢«è¯¬é™·å—è´¿è€ŒåœèŒï¼Œä½†å†…å¿ƒä»åšå®ˆæ­£ä¹‰ã€‚' },
                { id: '2', name: 'æé›¯', description: '32å²ï¼Œç°ä»»åˆ‘è­¦é˜Ÿé•¿ï¼Œé™ˆé˜³çš„å‰å¥³å‹ï¼Œå†·é™ç†æ€§ï¼Œåšäº‹å¹²ç»ƒï¼Œå†…å¿ƒä»å¯¹é™ˆé˜³æœ‰æ„Ÿæƒ…ã€‚åœ¨èŒä¸šå’Œæ„Ÿæƒ…ä¹‹é—´æ‘‡æ‘†ï¼Œæ˜¯è¿æ¥è­¦é˜Ÿå’Œé™ˆé˜³çš„å…³é”®äººç‰©ã€‚' },
                { id: '3', name: 'ç‹å¼º', description: '40å²ï¼ŒçŠ¯ç½ªé›†å›¢å¤´ç›®ï¼Œå¿ƒç‹ æ‰‹è¾£ï¼Œå–„äºä¼ªè£…ï¼Œè¡¨é¢æ¸©æ–‡å°”é›…ï¼Œå®åˆ™é˜´é™©ç‹¡è¯ˆã€‚æœ‰ç€å¤æ‚çš„èƒŒæ™¯æ•…äº‹ï¼Œä¸é™ˆé˜³æœ‰å®¿æ€¨ã€‚' },
                { id: '4', name: 'å°é›¨', description: '8å²ï¼Œè¢«ç»‘æ¶çš„äººè´¨ï¼Œèªæ˜å¯çˆ±ï¼Œæœºæ™ºå‹‡æ•¢ï¼Œåœ¨ææƒ§ä¸­ä¿æŒå¸Œæœ›ã€‚å¥¹çš„çœŸå®èº«ä»½æ˜¯æ¨åŠ¨å‰§æƒ…å‘å±•çš„å…³é”®çº¿ç´¢ã€‚' },
                { id: '5', name: 'å¼ å±€é•¿', description: '50å²ï¼Œè­¦å¯Ÿå±€å±€é•¿ï¼Œè¡¨é¢å…¬æ­£ä¸¥æ˜ï¼Œå®åˆ™æ˜¯çŠ¯ç½ªé›†å›¢çš„ä¿æŠ¤ä¼ï¼ŒåŸåºœææ·±ã€‚é™ˆé˜³æ›¾ç»æœ€ä¿¡ä»»çš„ä¸Šå¸ï¼Œå¦‚ä»Šæˆä¸ºæœ€å¤§çš„æ•Œäººã€‚' },
                { id: '6', name: 'é˜¿æ°', description: '28å²ï¼Œé™ˆé˜³çš„å‰æ­æ¡£ï¼Œå¿ è¯šå¯é ï¼Œåœ¨é™ˆé˜³åœèŒåä»æš—ä¸­æä¾›å¸®åŠ©ã€‚æŠ€æœ¯å‹äººæ‰ï¼Œæ“…é•¿ç½‘ç»œè¿½è¸ªå’Œæ•°æ®åˆ†æã€‚' },
                { id: '7', name: 'ç¥ç§˜äºº', description: 'èº«ä»½ä¸æ˜ï¼Œæ€»æ˜¯æˆ´ç€å¢¨é•œå’Œå£ç½©ï¼Œä¼¼ä¹çŸ¥é“æ‰€æœ‰ç§˜å¯†ã€‚æ˜¯æ•Œæ˜¯å‹ï¼Œæˆä¸ºæ•…äº‹çš„é‡è¦æ‚¬å¿µã€‚' }
            ],
            script: '',
            history: [],
            historyIndex: -1,
            currentSceneId: null
        };
        
        // --- Sync State ---
        let syncState = {
            lastSyncedScript: '',
            scriptEditorModified: false,
            outlineModified: false
        };

        // --- Mock Data ---
        const mockOutlines = {
            'three-act': [
                { id: '1', title: 'ç¬¬ä¸€å¹•ï¼šé“ºå«', children: [
                    { id: '1-1', title: 'å¼€åœºåœºæ™¯', content: 'ä¸€ä¸ªé˜³å…‰æ˜åªšçš„æ—©æ™¨ï¼Œä¸»è§’åœ¨åŸå¸‚å¹¿åœºä¸Šå¼€å§‹ä»–å¹³å‡¡çš„ä¸€å¤©ã€‚', shots: [
                        { id: '1-1-1', title: 'é•œå¤´1', description: 'å…¨æ™¯ï¼šæ™¨å…‰ä¸­çš„åŸå¸‚å¹¿åœºï¼Œé¸½å­åœ¨æ‚ é—²åœ°è§…é£Ÿã€‚', duration: '8ç§’' },
                        { id: '1-1-2', title: 'é•œå¤´2', description: 'ä¸­æ™¯ï¼šä¸»è§’Aï¼ˆ28å²ï¼Œç©¿ç€ä¼‘é—²ï¼‰ä»ç”»é¢å³ä¾§èµ°å…¥ï¼Œæ‰‹é‡Œæ‹¿ç€ä¸€ä¸ªé¢åŒ…ã€‚', duration: '5ç§’' },
                        { id: '1-1-3', title: 'é•œå¤´3', description: 'è¿‘æ™¯ï¼šä¸»è§’æ’•ä¸‹é¢åŒ…ï¼Œå¼€å§‹å–‚é¸½å­ï¼Œè„¸ä¸Šéœ²å‡ºæ¸©å’Œçš„ç¬‘å®¹ã€‚', duration: '6ç§’' },
                        { id: '1-1-4', title: 'é•œå¤´4', description: 'ç‰¹å†™ï¼šä¸€åªæ‰‹ï¼ˆå±äºç¥ç§˜äººBï¼‰ä»ç”»é¢å¤–é€’å…¥ä¸€å°ä¿¡ã€‚', duration: '3ç§’' },
                        { id: '1-1-5', title: 'é•œå¤´5', description: 'åæ‰“ï¼šä¸»è§’Aç–‘æƒ‘åœ°æŠ¬èµ·å¤´ï¼Œçœ‹ç€é€’ä¿¡çš„äººã€‚', duration: '4ç§’' },
                    ]},
                    { id: '1-2', title: 'è§’è‰²ä»‹ç»', content: 'é€šè¿‡ä¸»è§’çš„å›å¿†ï¼Œä»‹ç»å…¶èƒŒæ™¯å’Œä»–å°†è¦é¢å¯¹çš„å†²çªã€‚', shots: [
                        { id: '1-2-1', title: 'é•œå¤´1', description: 'è¿‘æ™¯ï¼šä¸»è§’Açš„é¢éƒ¨ç‰¹å†™ï¼Œçœ¼ç¥ä»ç–‘æƒ‘è½¬ä¸ºéœ‡æƒŠã€‚', duration: '3ç§’' },
                        { id: '1-2-2', title: 'é•œå¤´2', description: 'é—ªå›/ä¸­æ™¯ï¼šä¸»è§’ç©¿ç€è­¦æœï¼Œåœ¨è­¦å±€ä¸åŒäº‹ä»¬åº†ç¥ç ´æ¡ˆã€‚', duration: '7ç§’' },
                        { id: '1-2-3', title: 'é•œå¤´3', description: 'ç‰¹å†™ï¼šä¸»è§’åœ¨æ¡£æ¡ˆå‰è®¤çœŸå·¥ä½œï¼Œå¢™ä¸ŠæŒ‚æ»¡äº†å¥–çŠ¶ã€‚', duration: '5ç§’' },
                        { id: '1-2-4', title: 'é•œå¤´4', description: 'ä¸­æ™¯ï¼šä¸»è§’è¢«ä¸Šå¸è®­æ–¥ï¼Œæ¡Œä¸Šæ”¾ç€åœèŒæ–‡ä»¶ã€‚', duration: '8ç§’' },
                    ]},
                    { id: '1-3', title: 'ç¥ç§˜ä¿¡ä»¶', content: 'ä¸»è§’æ‰“å¼€ä¿¡ä»¶ï¼Œå‘ç°é‡Œé¢æœ‰ä¸€å¼ ç…§ç‰‡å’Œä¸€ä¸ªåœ°å€ï¼Œè¿™å°†æ”¹å˜ä»–çš„å‘½è¿ã€‚', shots: [
                        { id: '1-3-1', title: 'é•œå¤´1', description: 'ç‰¹å†™ï¼šä¸»è§’çš„æ‰‹é¢¤æŠ–ç€æ‰“å¼€ä¿¡å°ã€‚', duration: '4ç§’' },
                        { id: '1-3-2', title: 'é•œå¤´2', description: 'ç‰¹å†™ï¼šç…§ç‰‡ä¸Šæ˜¯ä¸€ä¸ªè¢«ç»‘æ¶çš„å¥³å­©ã€‚', duration: '3ç§’' },
                        { id: '1-3-3', title: 'é•œå¤´3', description: 'ç‰¹å†™ï¼šä¸»è§’çš„çœ¼ç›ç›¯ç€ç…§ç‰‡ï¼Œè¡¨æƒ…å˜å¾—ä¸¥è‚ƒã€‚', duration: '4ç§’' },
                        { id: '1-3-4', title: 'é•œå¤´4', description: 'å…¨æ™¯ï¼šä¸»è§’å¿«é€Ÿç¦»å¼€å¹¿åœºï¼ŒèƒŒæ™¯æ˜¯å¤•é˜³è¥¿ä¸‹ã€‚', duration: '6ç§’' },
                    ]},
                ]},
                { id: '2', title: 'ç¬¬äºŒå¹•ï¼šå†²çª', children: [
                    { id: '2-1', title: 'è°ƒæŸ¥å¼€å§‹', content: 'ä¸»è§’æ ¹æ®çº¿ç´¢æ¥åˆ°ä¸€ä¸ªåºŸå¼ƒå·¥å‚ï¼Œå¼€å§‹è°ƒæŸ¥çœŸç›¸ã€‚', shots: [
                        { id: '2-1-1', title: 'é•œå¤´1', description: 'å…¨æ™¯ï¼šå¤œæ™šçš„åºŸå¼ƒå·¥å‚ï¼Œéœ“è™¹ç¯é—ªçƒï¼Œæ°”æ°›è¯¡å¼‚ã€‚', duration: '10ç§’' },
                        { id: '2-1-2', title: 'é•œå¤´2', description: 'ä¸­æ™¯ï¼šä¸»è§’Aå°å¿ƒç¿¼ç¿¼åœ°è¿›å…¥å·¥å‚å¤§é—¨ã€‚', duration: '6ç§’' },
                        { id: '2-1-3', title: 'é•œå¤´3', description: 'è¿‘æ™¯ï¼šä¸»è§’ç”¨æ‰‹ç”µç­’ç…§äº®å››å‘¨ï¼Œè­¦æƒ•åœ°è§‚å¯Ÿã€‚', duration: '5ç§’' },
                        { id: '2-1-4', title: 'é•œå¤´4', description: 'ç‰¹å†™ï¼šåœ°ä¸Šæœ‰æ–°é²œçš„è„šå°ã€‚', duration: '3ç§’' },
                        { id: '2-1-5', title: 'é•œå¤´5', description: 'ä¸­æ™¯ï¼šä¸»è§’è·Ÿéšè„šå°æ·±å…¥å·¥å‚å†…éƒ¨ã€‚', duration: '7ç§’' },
                    ]},
                    { id: '2-2', title: 'åˆæ¬¡äº¤é”‹', content: 'ä¸»è§’é‡åˆ°äº†åæ´¾çš„æ‰‹ä¸‹ï¼ŒåŒæ–¹å‘ç”Ÿæ¿€çƒˆå†²çªã€‚', shots: [
                        { id: '2-2-1', title: 'é•œå¤´1', description: 'ä¸­æ™¯ï¼šä¸‰ä¸ªé»‘è¡£äººçªç„¶ä»é˜´å½±ä¸­è·³å‡ºï¼ŒåŒ…å›´ä¸»è§’ã€‚', duration: '5ç§’' },
                        { id: '2-2-2', title: 'é•œå¤´2', description: 'ç‰¹å†™ï¼šä¸»è§’Aæ¡ç´§æ‹³å¤´ï¼Œå‡†å¤‡æˆ˜æ–—ã€‚', duration: '3ç§’' },
                        { id: '2-2-3', title: 'é•œå¤´3', description: 'ä¸­æ™¯ï¼šæ¿€çƒˆçš„æ‰“æ–—åœºé¢ï¼Œä¸»è§’å±•ç°å‡ºè‰²çš„æ ¼æ–—æŠ€å·§ã€‚', duration: '12ç§’' },
                        { id: '2-2-4', title: 'é•œå¤´4', description: 'è¿‘æ™¯ï¼šä¸»è§’æ‰“å€’æœ€åä¸€ä¸ªå¯¹æ‰‹ï¼Œå–˜ç€ç²—æ°”ã€‚', duration: '6ç§’' },
                        { id: '2-2-5', title: 'é•œå¤´5', description: 'ç‰¹å†™ï¼šåœ°ä¸Šæœ‰ä¸€ä¸ªæ‰è½çš„æ‰‹æœºï¼Œæ˜¾ç¤ºç€ç¥ç§˜ä¿¡æ¯ã€‚', duration: '4ç§’' },
                    ]},
                    { id: '2-3', title: 'æ„å¤–å‘ç°', content: 'ä¸»è§’åœ¨å·¥å‚æ·±å¤„å‘ç°äº†è¢«ç»‘æ¶çš„å¥³å­©ï¼Œä½†è¿™åªæ˜¯æ›´å¤§é˜´è°‹çš„å¼€å§‹ã€‚', shots: [
                        { id: '2-3-1', title: 'é•œå¤´1', description: 'ä¸­æ™¯ï¼šä¸»è§’Aæ¥åˆ°å·¥å‚åœ°ä¸‹å®¤ï¼Œå¬åˆ°å¾®å¼±çš„å“­å£°ã€‚', duration: '6ç§’' },
                        { id: '2-3-2', title: 'é•œå¤´2', description: 'è¿‘æ™¯ï¼šä¸»è§’æ‰¾åˆ°äº†è¢«ç»‘åœ¨æ¤…å­ä¸Šçš„å°å¥³å­©ã€‚', duration: '5ç§’' },
                        { id: '2-3-3', title: 'é•œå¤´3', description: 'ç‰¹å†™ï¼šå°å¥³å­©å®³æ€•åœ°çœ‹ç€ä¸»è§’ï¼Œçœ¼ç¥ä¸­å……æ»¡å¸Œæœ›ã€‚', duration: '4ç§’' },
                        { id: '2-3-4', title: 'é•œå¤´4', description: 'ä¸­æ™¯ï¼šä¸»è§’è§£å¼€ç»³å­ï¼Œå®‰æ…°å°å¥³å­©ã€‚', duration: '7ç§’' },
                        { id: '2-3-5', title: 'é•œå¤´5', description: 'å…¨æ™¯ï¼šå·¥å‚å¤–çªç„¶ä¼ æ¥è­¦ç¬›å£°ï¼Œæƒ…å†µå˜å¾—å¤æ‚ã€‚', duration: '8ç§’' },
                    ]},
                ]},
                { id: '3', title: 'ç¬¬ä¸‰å¹•ï¼šé«˜æ½®ä¸è§£å†³', children: [
                    { id: '3-1', title: 'çœŸç›¸æ­éœ²', content: 'ä¸»è§’å‘ç°è¿™ä¸€åˆ‡éƒ½æ˜¯åæ´¾Bè®¾ä¸‹çš„é™·é˜±ï¼Œç›®çš„æ˜¯æ ½èµƒé™·å®³ä»–ã€‚', shots: [
                        { id: '3-1-1', title: 'é•œå¤´1', description: 'ä¸­æ™¯ï¼šä¸»è§’Aå¸¦ç€å°å¥³å­©é€ƒå‡ºå·¥å‚ï¼Œè­¦å¯Ÿå·²ç»åŒ…å›´ç°åœºã€‚', duration: '8ç§’' },
                        { id: '3-1-2', title: 'é•œå¤´2', description: 'ç‰¹å†™ï¼šè­¦å¯Ÿç”¨æªæŒ‡ç€ä¸»è§’ï¼Œå‘½ä»¤ä»–æ”¾ä¸‹å°å¥³å­©ã€‚', duration: '5ç§’' },
                        { id: '3-1-3', title: 'é•œå¤´3', description: 'è¿‘æ™¯ï¼šä¸»è§’Açš„è¡¨æƒ…ä»éœ‡æƒŠè½¬ä¸ºæ„¤æ€’ï¼Œæ„è¯†åˆ°è¢«é™·å®³ã€‚', duration: '4ç§’' },
                        { id: '3-1-4', title: 'é•œå¤´4', description: 'ç‰¹å†™ï¼šè¿œå¤„çš„å»ºç­‘ç‰©ä¸Šï¼Œåæ´¾Bå†·å†·åœ°çœ‹ç€è¿™ä¸€åˆ‡ã€‚', duration: '3ç§’' },
                    ]},
                    { id: '3-2', title: 'ç»åœ°åå‡»', content: 'ä¸»è§’åœ¨é…è§’Cçš„å¸®åŠ©ä¸‹ï¼Œå¼€å§‹åå‡»ï¼Œæ­éœ²åæ´¾çš„é˜´è°‹ã€‚', shots: [
                        { id: '3-2-1', title: 'é•œå¤´1', description: 'ä¸­æ™¯ï¼šä¸»è§’Aå’Œé…è§’Cåœ¨ç§˜å¯†åœ°ç‚¹ä¼šé¢ï¼Œå•†è®¨å¯¹ç­–ã€‚', duration: '7ç§’' },
                        { id: '3-2-2', title: 'é•œå¤´2', description: 'ç‰¹å†™ï¼šé…è§’Cå±•ç¤ºå¥¹è°ƒæŸ¥åˆ°çš„è¯æ®ã€‚', duration: '5ç§’' },
                        { id: '3-2-3', title: 'é•œå¤´3', description: 'ä¸­æ™¯ï¼šä¸»è§’Aåˆ¶å®šè¯¦ç»†çš„åå‡»è®¡åˆ’ã€‚', duration: '8ç§’' },
                        { id: '3-2-4', title: 'é•œå¤´4', description: 'å…¨æ™¯ï¼šä¸»è§’Aå•æªåŒ¹é©¬å‰å¾€åæ´¾çš„è€å·¢ã€‚', duration: '10ç§’' },
                    ]},
                    { id: '3-3', title: 'æœ€ç»ˆå¯¹å†³', content: 'ä¸»è§’ä¸åæ´¾Båœ¨æ‘©å¤©å¤§æ¥¼å±‹é¡¶å±•å¼€æœ€ç»ˆå¯¹å†³ã€‚', shots: [
                        { id: '3-3-1', title: 'é•œå¤´1', description: 'å…¨æ™¯ï¼šé›¨å¤œä¸­çš„æ‘©å¤©å¤§æ¥¼å±‹é¡¶ï¼Œé—ªç”µåˆ’ç ´å¤©ç©ºã€‚', duration: '12ç§’' },
                        { id: '3-3-2', title: 'é•œå¤´2', description: 'ä¸­æ™¯ï¼šä¸»è§’Aå’Œåæ´¾Bé¢å¯¹é¢ç«™ç«‹ï¼Œæ°”æ°›ç´§å¼ ã€‚', duration: '8ç§’' },
                        { id: '3-3-3', title: 'é•œå¤´3', description: 'ç‰¹å†™ï¼šä¸¤äººçš„çœ¼ç¥ä¸­å……æ»¡ä»‡æ¨å’Œå†³å¿ƒã€‚', duration: '5ç§’' },
                        { id: '3-3-4', title: 'é•œå¤´4', description: 'ä¸­æ™¯ï¼šæ¿€çƒˆçš„æ‰“æ–—ï¼Œä¸¤äººä»å±‹é¡¶è¾¹ç¼˜æ‰“åˆ°å†…éƒ¨ã€‚', duration: '15ç§’' },
                        { id: '3-3-5', title: 'é•œå¤´5', description: 'ç‰¹å†™ï¼šä¸»è§’AæŠ“ä½æœºä¼šï¼Œå°†åæ´¾Båˆ¶æœã€‚', duration: '8ç§’' },
                        { id: '3-3-6', title: 'é•œå¤´6', description: 'å…¨æ™¯ï¼šè­¦å¯Ÿèµ¶åˆ°ç°åœºï¼Œé€®æ•åæ´¾Bï¼Œä¸»è§’Aè¢«è¯æ˜æ¸…ç™½ã€‚', duration: '10ç§’' },
                    ]},
                    { id: '3-4', title: 'å°¾å£°', content: 'ä¸€åˆ‡ç»“æŸåï¼Œä¸»è§’æ¢å¤è­¦å¯Ÿèº«ä»½ï¼Œä¸é…è§’Cé‡å½’äºå¥½ã€‚', shots: [
                        { id: '3-4-1', title: 'é•œå¤´1', description: 'å…¨æ™¯ï¼šé˜³å…‰æ˜åªšçš„è­¦å±€ï¼Œä¸»è§’Aç©¿ç€è­¦æœå›åˆ°å·¥ä½œå²—ä½ã€‚', duration: '8ç§’' },
                        { id: '3-4-2', title: 'é•œå¤´2', description: 'ä¸­æ™¯ï¼šä¸»è§’Aå’Œé…è§’Cåœ¨åŠå…¬å®¤é‡Œæœ‰è¯´æœ‰ç¬‘ã€‚', duration: '6ç§’' },
                        { id: '3-4-3', title: 'é•œå¤´3', description: 'ç‰¹å†™ï¼šä¸¤äººç›¸è§†è€Œç¬‘ï¼Œä¸€åˆ‡å°½åœ¨ä¸è¨€ä¸­ã€‚', duration: '5ç§’' },
                        { id: '3-4-4', title: 'é•œå¤´4', description: 'å…¨æ™¯ï¼šé•œå¤´æ‹‰è¿œï¼ŒåŸå¸‚æ¢å¤å¹³é™ï¼Œæ•…äº‹åœ†æ»¡ç»“æŸã€‚', duration: '10ç§’' },
                    ]},
                ]},
            ]
        };

        const mockRoles = [
            { 
                id: '1', 
                name: 'ä¸»è§’A', 
                age: 28, 
                gender: 'ç”·',
                personality: 'å‹‡æ•¢, æ­£ç›´, å–„è‰¯', 
                background: 'å‰è­¦å¯Ÿï¼Œå› ä¸€æ¬¡ä»»åŠ¡å¤±è¯¯è¢«åœèŒï¼Œç°åœ¨æ˜¯ç§å®¶ä¾¦æ¢',
                relationships: 'ä¸åæ´¾Bæ˜¯å®¿æ•Œï¼Œä¸é…è§’Cæ˜¯æœ‹å‹',
                appearance: 'ä¸­ç­‰èº«æï¼ŒçŸ­å‘ï¼Œçœ¼ç¥é”åˆ©ï¼Œå¸¸ç©¿é»‘è‰²é£è¡£',
                goal: 'æŸ¥æ˜çœŸç›¸ï¼Œæ´—æ¸…è‡ªå·±çš„å†¤å±ˆ',
                image: ''
            },
            { 
                id: '2', 
                name: 'åæ´¾B', 
                age: 45, 
                gender: 'ç”·',
                personality: 'ç‹¡çŒ¾, é‚ªæ¶, é‡å¿ƒå‹ƒå‹ƒ', 
                background: 'è·¨å›½çŠ¯ç½ªé›†å›¢çš„å¤´ç›®ï¼Œä¸ä¸»è§’æœ‰ä¸ä¸ºäººçŸ¥çš„è¿‡å»',
                relationships: 'ä¸ä¸»è§’Aæ˜¯å®¿æ•Œï¼Œæ§åˆ¶ç€ä¼—å¤šæ‰‹ä¸‹',
                appearance: 'é«˜å¤§å¨çŒ›ï¼Œè¥¿è£…é©å±¥ï¼Œçœ¼ç¥é˜´é¸·ï¼Œæ€»æ˜¯å¸¦ç€ç¤¼è²Œçš„å¾®ç¬‘',
                goal: 'å®Œæˆä»–çš„çŠ¯ç½ªè®¡åˆ’ï¼Œé™¤æ‰ä¸»è§’',
                image: ''
            },
            { 
                id: '3', 
                name: 'é…è§’C', 
                age: 25, 
                gender: 'å¥³',
                personality: 'èªæ˜, æœºæ™º, å‹‡æ•¢', 
                background: 'ç°ä»»è­¦å¯Ÿï¼Œä¸»è§’çš„å‰å¥³å‹ï¼Œä¸€ç›´ç›¸ä¿¡ä¸»è§’çš„æ¸…ç™½',
                relationships: 'ä¸ä¸»è§’Aæ˜¯å‰å¥³å‹å…³ç³»ï¼Œä¸åæ´¾Bæœ‰é—´æ¥è”ç³»',
                appearance: 'èº«æé«˜æŒ‘ï¼Œé•¿å‘ï¼Œæ°”è´¨å¹²ç»ƒï¼Œå¸¸ç©¿èŒä¸šè£…',
                goal: 'å¸®åŠ©ä¸»è§’æ´—æ¸…å†¤å±ˆï¼Œæ­éœ²çœŸç›¸',
                image: ''
            }
        ];

        // --- Utility Functions ---
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 right-4 bg-black text-white px-4 py-2 rounded-md shadow-lg z-50';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function findSceneById(sceneId) {
            for (const act of currentProject.outline) {
                for (const scene of act.children) {
                    if (scene.id === sceneId) {
                        return scene;
                    }
                }
            }
            return null;
        }

        function findShotById(shotId) {
            for (const act of currentProject.outline) {
                for (const scene of act.children) {
                    if (scene.shots) {
                        for (const shot of scene.shots) {
                            if (shot.id === shotId) {
                                return shot;
                            }
                        }
                    }
                }
            }
            return null;
        }

        // --- AI Image Generation Functions ---
        async function generateShotImage(shotDescription) {
            console.log('ğŸ¨ æ­£åœ¨ç”ŸæˆAIåˆ†é•œå›¾ç‰‡...');
            console.log('ğŸ“ æç¤ºè¯:', shotDescription);
            
            if (!getDecodedApiKey()) {
                throw new Error('âŒ AI API Keyæœªé…ç½®');
            }

            try {
                // ä½¿ç”¨ç”¨æˆ·æŒ‡å®šçš„æ–°promptæ ¼å¼
                const prompt = `Cinematic concept line art, single keyframe, ${shotDescription}, clean ink outlines, minimalist architectural sketch style, white background, no shading, high contrast, wide angle composition, highly detailed, 8k resolution.`;
                console.log('ğŸ”¤ å®Œæ•´æç¤ºè¯:', prompt);
                
                console.log('ğŸŒ æ­£åœ¨è°ƒç”¨API:', AI_CONFIG.baseUrl);
                console.log('ğŸ¤– ä½¿ç”¨æ¨¡å‹:', AI_CONFIG.imageModel);
                
                const response = await fetch(`${AI_CONFIG.baseUrl}/images/generations`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getDecodedApiKey()}`
                    },
                    body: JSON.stringify({
                        model: AI_CONFIG.imageModel,
                        prompt: prompt,
                        n: 1,
                        size: '1280x720'
                    })
                });

                console.log('ğŸ“Š APIå“åº”çŠ¶æ€:', response.status);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('âŒ APIé”™è¯¯è¯¦æƒ…:', errorData);
                    throw new Error(`âŒ å›¾ç‰‡ç”Ÿæˆå¤±è´¥: ${errorData.error?.message || response.statusText}`);
                }

                const data = await response.json();
                console.log('ğŸ“¦ APIè¿”å›æ•°æ®:', JSON.stringify(data, null, 2));
                
                // å°è¯•å¤šç§å¯èƒ½çš„æ•°æ®ç»“æ„
                let imageUrl = null;
                
                // é­”æ­ç¤¾åŒºæ ¼å¼ (ä»æ—¥å¿—çœ‹åˆ°çš„å®é™…æ ¼å¼)
                if (data.images && data.images[0] && data.images[0].url) {
                    imageUrl = data.images[0].url;
                    console.log('âœ… æ‰¾åˆ°é­”æ­æ ¼å¼å›¾ç‰‡URL:', imageUrl);
                }
                // æ ‡å‡†OpenAIæ ¼å¼
                else if (data.data && data.data[0] && data.data[0].url) {
                    imageUrl = data.data[0].url;
                    console.log('âœ… æ‰¾åˆ°æ ‡å‡†æ ¼å¼å›¾ç‰‡URL:', imageUrl);
                }
                // å…¶ä»–å¯èƒ½çš„æ ¼å¼
                else if (data.results && data.results[0] && data.results[0].image_url) {
                    imageUrl = data.results[0].image_url;
                    console.log('âœ… æ‰¾åˆ°å…¶ä»–æ ¼å¼å›¾ç‰‡URL:', imageUrl);
                }
                // å•ä¸ªå›¾ç‰‡URL
                else if (data.image_url) {
                    imageUrl = data.image_url;
                    console.log('âœ… æ‰¾åˆ°å•ä¸ªå›¾ç‰‡URL:', imageUrl);
                }
                
                if (!imageUrl) {
                    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°å›¾ç‰‡URLï¼Œæä¾›ä¸€ä¸ªå¤‡ç”¨çš„ç¤ºä¾‹å›¾ç‰‡
                    console.warn('âš ï¸ æœªæ‰¾åˆ°å›¾ç‰‡URLï¼Œä½¿ç”¨å¤‡ç”¨å›¾ç‰‡');
                    const fallbackImages = [
                        'https://images.unsplash.com/photo-1512070679279-8988d32161be?w=500&h=500&fit=crop&crop=faces',
                        'https://images.unsplash.com/photo-1536440136628-849c177e76a1?w=500&h=500&fit=crop&crop=faces',
                        'https://images.unsplash.com/photo-1522075469751-3a6694fb2f61?w=500&h=500&fit=crop&crop=faces'
                    ];
                    imageUrl = fallbackImages[Math.floor(Math.random() * fallbackImages.length)];
                }

                console.log('âœ… æœ€ç»ˆå›¾ç‰‡URL:', imageUrl);
                return imageUrl;
            } catch (error) {
                console.error('âŒ å›¾ç‰‡ç”Ÿæˆå¤±è´¥:', error);
                console.error('ğŸ“‹ é”™è¯¯å †æ ˆ:', error.stack);
                
                // å‘ç”Ÿé”™è¯¯æ—¶æä¾›å¤‡ç”¨å›¾ç‰‡
                const fallbackImages = [
                    'https://images.unsplash.com/photo-1512070679279-8988d32161be?w=500&h=500&fit=crop&crop=faces',
                    'https://images.unsplash.com/photo-1536440136628-849c177e76a1?w=500&h=500&fit=crop&crop=faces',
                    'https://images.unsplash.com/photo-1522075469751-3a6694fb2f61?w=500&h=500&fit=crop&crop=faces'
                ];
                const fallbackUrl = fallbackImages[Math.floor(Math.random() * fallbackImages.length)];
                console.log('ğŸ”„ ä½¿ç”¨å¤‡ç”¨å›¾ç‰‡:', fallbackUrl);
                
                return fallbackUrl;
            }
        }

        async function generateImageForShot(shotId) {
            const shot = findShotById(shotId);
            if (!shot) {
                showToast('æœªæ‰¾åˆ°åˆ†é•œ');
                return;
            }

            try {
                showToast('æ­£åœ¨ç”ŸæˆAIåˆ†é•œå›¾ç‰‡...');
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const shotElement = document.querySelector(`[data-shot-id="${shotId}"]`);
                if (shotElement) {
                    const imageContainer = shotElement.querySelector('.shot-image-container');
                    if (imageContainer) {
                        imageContainer.innerHTML = '<div class="flex items-center justify-center aspect-video bg-gray-100 rounded-md"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-black"></div></div>';
                    }
                }

                const imageUrl = await generateShotImage(shot.description);
                
                // ä¿å­˜å›¾ç‰‡URLåˆ°åˆ†é•œæ•°æ®
                shot.imageUrl = imageUrl;
                
                // æ›´æ–°UIæ˜¾ç¤ºå›¾ç‰‡
                updateShotImageDisplay(shotId, imageUrl);
                
                showToast('åˆ†é•œå›¾ç‰‡ç”ŸæˆæˆåŠŸï¼');
            } catch (error) {
                console.error('âŒ å›¾ç‰‡ç”Ÿæˆå¤±è´¥:', error);
                showToast(`å›¾ç‰‡ç”Ÿæˆå¤±è´¥: ${error.message}`);
                
                // æ¢å¤æ˜¾ç¤º
                const shotElement = document.querySelector(`[data-shot-id="${shotId}"]`);
                if (shotElement) {
                    const imageContainer = shotElement.querySelector('.shot-image-container');
                    if (imageContainer) {
                        imageContainer.innerHTML = '<button onclick="generateImageForShot(\'' + shotId + '\')" class="flex items-center justify-center h-32 bg-gray-100 rounded-md hover:bg-gray-200 transition-colors"><i data-lucide="image" class="w-8 h-8 text-gray-400"></i><span class="ml-2 text-gray-600">ç”Ÿæˆå›¾ç‰‡</span></button>';
                        lucide.createIcons();
                    }
                }
            }
        }

        function updateShotImageDisplay(shotId, imageUrl) {
            const shotElement = document.querySelector(`[data-shot-id="${shotId}"]`);
            if (shotElement) {
                const imageContainer = shotElement.querySelector('.shot-image-container');
                if (imageContainer) {
                    imageContainer.innerHTML = `
                        <div class="relative aspect-video rounded-md overflow-hidden">
                            <img src="${imageUrl}" alt="åˆ†é•œå›¾ç‰‡" class="w-full h-full object-cover">
                            <button onclick="generateImageForShot('${shotId}')" class="absolute top-2 right-2 bg-black bg-opacity-50 text-white p-1 rounded hover:bg-opacity-70 transition-colors">
                                <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                            </button>
                        </div>
                    `;
                    lucide.createIcons();
                }
            }
        }

        // --- åˆ é™¤åˆ†é•œåŠŸèƒ½ ---
        function deleteShot(shotId) {
            console.log('ğŸ—‘ï¸ åˆ é™¤åˆ†é•œ:', shotId);
            
            // ç¡®è®¤åˆ é™¤
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåˆ†é•œå—ï¼Ÿ')) {
                return;
            }
            
            try {
                // æŸ¥æ‰¾å¹¶åˆ é™¤åˆ†é•œ
                let deleted = false;
                for (let i = 0; i < currentProject.outline.length; i++) {
                    const act = currentProject.outline[i];
                    for (let j = 0; j < act.children.length; j++) {
                        const scene = act.children[j];
                        if (scene.shots && Array.isArray(scene.shots)) {
                            const shotIndex = scene.shots.findIndex(shot => shot && shot.id === shotId);
                            if (shotIndex !== -1) {
                                // åˆ é™¤åˆ†é•œ
                                scene.shots.splice(shotIndex, 1);
                                deleted = true;
                                console.log('âœ… åˆ†é•œåˆ é™¤æˆåŠŸ');
                                break;
                            }
                        }
                    }
                    if (deleted) break;
                }
                
                if (deleted) {
                    // é‡æ–°æ¸²æŸ“æ—¶é—´è½´
                    renderTimeline();
                    // åŒæ­¥åˆ°å‰§æœ¬ç¼–è¾‘å™¨
                    syncScriptEditor();
                    showToast('åˆ†é•œåˆ é™¤æˆåŠŸï¼');
                } else {
                    console.warn('âŒ æœªæ‰¾åˆ°è¦åˆ é™¤çš„åˆ†é•œ:', shotId);
                    showToast('æœªæ‰¾åˆ°è¦åˆ é™¤çš„åˆ†é•œ');
                }
            } catch (error) {
                console.error('ğŸ’¥ åˆ é™¤åˆ†é•œæ—¶å‘ç”Ÿé”™è¯¯:', error);
                showToast('åˆ é™¤åˆ†é•œæ—¶å‘ç”Ÿé”™è¯¯');
            }
        }

        function handleDeleteClick(shotId) {
            console.log('ğŸ–±ï¸ ç‚¹å‡»åˆ é™¤æŒ‰é’®:', shotId);
            deleteShot(shotId);
        }

        // --- Timeline Rendering ---
        function renderTimeline() {
            const timeline = document.getElementById('timeline');
            timeline.innerHTML = '';
            if (!currentProject.currentSceneId) {
                timeline.innerHTML = `<div class="text-gray-500 text-center py-8">è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªåœºæ™¯æ¥æŸ¥çœ‹å’Œç®¡ç†å…¶åˆ†é•œå¤´ã€‚</div>`;
                return;
            }

            const currentScene = findSceneById(currentProject.currentSceneId);
            if (!currentScene) return;

            const sceneHeader = document.createElement('div');
            sceneHeader.className = 'mb-6';
            sceneHeader.innerHTML = `
                <div class="flex items-start justify-between mb-2">
                    <div class="flex-1">
                        <input type="text" id="scene-title-input" value="${currentScene.title}" 
                               class="text-2xl font-light text-gray-800 border-none bg-transparent focus:outline-none focus:ring-1 focus:ring-black w-full mb-2"
                               placeholder="åœºæ™¯æ ‡é¢˜">
                    </div>
                    <button onclick="saveSceneInfo()" class="btn-primary px-3 py-1 rounded-md text-sm flex items-center space-x-1">
                        <i data-lucide="save" class="w-4 h-4"></i>
                        <span>ä¿å­˜</span>
                    </button>
                </div>
                <div class="h-px w-24 bg-black mt-2 mb-3"></div>
                <textarea id="scene-content-input" 
                          class="w-full border border-gray-300 rounded-md px-3 py-2 text-gray-600 focus:outline-none focus:ring-1 focus:ring-black"
                          rows="3" placeholder="åœºæ™¯æè¿°...">${currentScene.content || ''}</textarea>
                <div class="flex justify-between items-center mt-4">
                    <button onclick="addNewShot()" class="btn-primary px-4 py-2 rounded-md flex items-center space-x-2">
                        <i data-lucide="plus"></i>
                        <span>æ·»åŠ åˆ†é•œ</span>
                    </button>
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-500">åˆ†é•œæ•°é‡: ${currentScene.shots ? currentScene.shots.length : 0}</span>
                    </div>
                </div>
            `;
            timeline.appendChild(sceneHeader);

            if (currentScene.shots && currentScene.shots.length > 0) {
                const shotsList = document.createElement('div');
                shotsList.className = 'space-y-6';
                currentScene.shots.forEach((shot) => {
                    const shotItem = document.createElement('div');
                    shotItem.className = 'p-4 rounded-lg border border-gray-200 bg-white hover:shadow-md transition-shadow flex flex-col';
                    shotItem.setAttribute('data-shot-id', shot.id);
                    shotItem.innerHTML = `
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="font-medium text-gray-800">${shot.title}</h4>
                            <div class="flex items-center space-x-4">
                                <span class="text-sm text-gray-500">${shot.duration || '0ç§’'}</span>
                                <div class="flex space-x-2">
                                    <button onclick="editShotModal('${shot.id}')" class="text-gray-400 hover:text-gray-600">
                                        <i data-lucide="edit"></i>
                                    </button>
                                    <button onclick="handleDeleteClick('${shot.id}')" class="text-gray-400 hover:text-gray-600" title="åˆ é™¤åˆ†é•œ">
                                        <i data-lucide="trash-2"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="flex-grow">
                            <div class="shot-image-container mb-2">
                                ${shot.imageUrl ? `
                                    <div class="relative w-full aspect-video rounded-md overflow-hidden">
                                        <img src="${shot.imageUrl}" alt="${shot.title}" class="w-full h-full object-cover">
                                        <button onclick="generateImageForShot('${shot.id}')" class="absolute top-2 right-2 bg-black bg-opacity-50 text-white p-1 rounded hover:bg-opacity-70 transition-colors" title="é‡æ–°ç”Ÿæˆå›¾ç‰‡">
                                            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                ` : `
                                    <button onclick="generateImageForShot('${shot.id}')" class="w-full aspect-video bg-gray-100 rounded-md flex items-center justify-center text-gray-600 hover:bg-gray-200 transition-colors">
                                        <div class="text-center">
                                            <i data-lucide="image" class="w-8 h-8 mx-auto text-gray-400 mb-2"></i>
                                            <span>AIç”Ÿæˆå›¾ç‰‡</span>
                                        </div>
                                    </button>
                                `}
                            </div>
                            <textarea class="w-full text-gray-600 border-none bg-transparent focus:outline-none focus:ring-black resize-none" 
                                      rows="3" placeholder="åˆ†é•œæè¿°..." onchange="updateShotDescription('${shot.id}', this.value)">${shot.description || ''}</textarea>
                        </div>
                    `;
                    shotsList.appendChild(shotItem);
                });
                timeline.appendChild(shotsList);
            } else {
                timeline.innerHTML += `<div class="text-gray-500 text-center py-8">è¯¥åœºæ™¯ä¸‹æš‚æ— åˆ†é•œå¤´ã€‚ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ ã€‚</div>`;
            }

            lucide.createIcons();
        }

        // --- Outline Rendering ---
        function renderOutlineTree() {
            const outlineTree = document.getElementById('outline-tree');
            outlineTree.innerHTML = '';
            currentProject.outline.forEach(act => {
                const actElement = document.createElement('div');
                actElement.className = 'mb-4';
                actElement.innerHTML = `
                    <div class="flex items-center justify-between p-2 bg-white rounded-md cursor-pointer border border-gray-200" onclick="toggleAct(this)">
                        <span class="font-medium text-gray-800">${act.title}</span>
                        <i data-lucide="chevron-down" class="w-4 h-4 text-gray-500"></i>
                    </div>
                    <div class="pl-4 mt-2 space-y-2">
                        ${act.children.map(scene => `
                            <div class="p-2 bg-white rounded-md cursor-pointer hover:bg-gray-100 border border-gray-200 text-gray-600" onclick="selectScene('${scene.id}')">
                                <div class="flex justify-between items-center">
                                    <span>${scene.title}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                outlineTree.appendChild(actElement);
            });
            lucide.createIcons();
        }

        // --- Event Handlers ---
        function selectScene(sceneId) {
            currentProject.currentSceneId = sceneId;
            renderTimeline();
            syncScriptEditor();
            // Highlight selected scene
            document.querySelectorAll('#outline-tree .p-2').forEach(el => {
                if(el.getAttribute('onclick') && el.getAttribute('onclick').includes(`selectScene('${sceneId}')`)) {
                    el.classList.add('bg-blue-100');
                } else {
                    el.classList.remove('bg-blue-100');
                }
            });
        }

        function addNewShot() {
            const scene = findSceneById(currentProject.currentSceneId);
            if (!scene) {
                showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªåœºæ™¯');
                return;
            }
            if (!scene.shots) scene.shots = [];
            
            const newShot = {
                id: Date.now().toString(),
                title: `æ–°é•œå¤´ ${scene.shots.length + 1}`,
                description: 'è¯·è¾“å…¥åˆ†é•œæè¿°...',
                duration: '0ç§’'
            };
            scene.shots.push(newShot);
            renderTimeline();
            syncScriptEditor();
        }

        function updateShotDescription(shotId, description) {
            const shot = findShotById(shotId);
            if (shot) {
                shot.description = description;
                syncScriptEditor();
            }
        }

        function editShotModal(shotId) {
            const shot = findShotById(shotId);
            if (!shot) return;

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-lg">
                    <h2 class="text-2xl font-bold mb-6">ç¼–è¾‘åˆ†é•œ</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="shot-title" class="block text-sm font-medium text-gray-700 mb-1">æ ‡é¢˜</label>
                            <input type="text" id="shot-title" value="${shot.title || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="shot-description" class="block text-sm font-medium text-gray-700 mb-1">æè¿°</label>
                            <textarea id="shot-description" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">${shot.description || ''}</textarea>
                        </div>
                        <div>
                            <label for="shot-duration" class="block text-sm font-medium text-gray-700 mb-1">æ—¶é•¿</label>
                            <input type="text" id="shot-duration" value="${shot.duration || ''}" placeholder="ä¾‹å¦‚: 5ç§’" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="shot-image" class="block text-sm font-medium text-gray-700 mb-1">å›¾ç‰‡</label>
                            <div class="flex space-x-2 mb-2">
                                <input type="file" id="shot-image" accept="image/*" class="flex-1 text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                                <button onclick="generateImageForShot('${shotId}')" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors duration-200 flex items-center space-x-2">
                                    <i data-lucide="image" class="w-4 h-4"></i>
                                    <span>AIç”Ÿæˆ</span>
                                </button>
                            </div>
                            ${shot.imageUrl ? `<img src="${shot.imageUrl}" alt="${shot.title}" class="mt-2 w-full aspect-video object-cover rounded-md">` : ''}
                        </div>
                    </div>
                    <div class="mt-8 flex justify-end">
                        <button onclick="saveAndClose('${shotId}', this)" class="px-6 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors duration-200">
                            ä¿å­˜å¹¶å…³é—­
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Handle image upload
            const imageInput = modal.querySelector('#shot-image');
            imageInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        shot.imageUrl = e.target.result;
                        const imgContainer = imageInput.parentElement;
                        const existingImg = imgContainer.querySelector('img');
                        if (existingImg) {
                            existingImg.src = shot.imageUrl;
                        } else {
                            const img = document.createElement('img');
                            img.src = shot.imageUrl;
                            img.alt = shot.title;
                            img.className = 'mt-2 w-full h-32 object-cover rounded-md';
                            imgContainer.appendChild(img);
                        }
                    };
                    reader.readAsDataURL(file);
                }
            });

            lucide.createIcons();
        }

        function saveAndClose(shotId, button) {
            const modal = button.closest('.fixed');
            const title = modal.querySelector('#shot-title').value;
            const description = modal.querySelector('#shot-description').value;
            const duration = modal.querySelector('#shot-duration').value;

            const shot = findShotById(shotId);
            if (shot) {
                shot.title = title;
                shot.description = description;
                shot.duration = duration;
                renderTimeline();
                syncScriptEditor();
            }

            modal.remove();
        }

        function saveSceneInfo() {
            const scene = findSceneById(currentProject.currentSceneId);
            if (scene) {
                scene.title = document.getElementById('scene-title-input').value;
                scene.content = document.getElementById('scene-content-input').value;
                renderOutlineTree();
                syncScriptEditor();
                showToast('åœºæ™¯ä¿¡æ¯å·²ä¿å­˜');
            }
        }

        function toggleAct(element) {
            const content = element.nextElementSibling;
            const icon = element.querySelector('i');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.setAttribute('data-lucide', 'chevron-down');
            } else {
                content.style.display = 'none';
                icon.setAttribute('data-lucide', 'chevron-right');
            }
            lucide.createIcons();
        }

        // --- Export Functions ---
        function openExportModal() {
            document.getElementById('export-modal').classList.remove('hidden');
        }

        function closeExportModal() {
            document.getElementById('export-modal').classList.add('hidden');
        }

        function previewExport() {
            showToast('é¢„è§ˆåŠŸèƒ½å¼€å‘ä¸­...');
        }

        function exportProject() {
            const format = document.querySelector('input[name="export-format"]:checked').value;
            const title = currentProject.title || 'æœªå‘½åå‰§æœ¬';
            
            showToast(`æ­£åœ¨å¯¼å‡º${format.toUpperCase()}æ ¼å¼...`);
            
            try {
                let content = '';
                let filename = `${title}.${format}`;
                let mimeType = 'text/plain';
                
                switch (format) {
                    case 'txt':
                        content = generateTXTContent();
                        mimeType = 'text/plain';
                        break;
                    case 'docx':
                        content = generateDOCXContent();
                        filename = `${title}.txt`; // å®é™…DOCXéœ€è¦æ›´å¤æ‚çš„åº“ï¼Œå…ˆç”¨TXTä»£æ›¿
                        mimeType = 'text/plain';
                        break;
                    case 'fdx':
                        content = generateFDXContent();
                        mimeType = 'text/xml';
                        break;
                    default:
                        throw new Error('ä¸æ”¯æŒçš„å¯¼å‡ºæ ¼å¼');
                }
                
                // åˆ›å»ºå¹¶ä¸‹è½½æ–‡ä»¶
                downloadFile(content, filename, mimeType);
                
                showToast('å¯¼å‡ºæˆåŠŸï¼');
                closeExportModal();
                
            } catch (error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                showToast('å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        function generateTXTContent() {
            let content = `=== ${currentProject.title} ===\n\n`;
            
            // æ·»åŠ è§’è‰²åˆ—è¡¨
            if (currentProject.roles && currentProject.roles.length > 0) {
                content += 'ã€è§’è‰²åˆ—è¡¨ã€‘\n';
                currentProject.roles.forEach(role => {
                    const name = role.name || 'æœªçŸ¥è§’è‰²';
                    const description = role.description || role.age || 'æš‚æ— æè¿°';
                    content += `${name}: ${description}\n`;
                });
                content += '\n';
            }
            
            // æ·»åŠ å‰§æœ¬å†…å®¹
            content += 'ã€å‰§æœ¬å†…å®¹ã€‘\n\n';
            
            // å°è¯•ä»outlineä¸­è·å–æ‰€æœ‰åœºæ™¯å†…å®¹
            let allScenesContent = '';
            let sceneFound = false;
            
            if (currentProject.outline && currentProject.outline.length > 0) {
                currentProject.outline.forEach(act => {
                    if (act.children && act.children.length > 0) {
                        act.children.forEach(scene => {
                            sceneFound = true;
                            // æ·»åŠ åœºæ™¯æ ‡é¢˜
                            allScenesContent += `\n${scene.title}\n\n`;
                            
                            // æ·»åŠ åœºæ™¯å†…å®¹
                            if (scene.content) {
                                allScenesContent += `${scene.content}\n\n`;
                            }
                            
                            // å¦‚æœæœ‰åˆ†é•œä¿¡æ¯ï¼Œä¹Ÿæ·»åŠ è¿›å»
                            if (scene.shots && scene.shots.length > 0) {
                                allScenesContent += `ã€åˆ†é•œã€‘\n`;
                                scene.shots.forEach((shot, index) => {
                                    allScenesContent += `${index + 1}. ${shot.title}`;
                                    if (shot.description) {
                                        allScenesContent += `: ${shot.description}`;
                                    }
                                    allScenesContent += `\n`;
                                });
                                allScenesContent += `\n`;
                            }
                        });
                    }
                });
            }
            
            // å¦‚æœæ‰¾åˆ°äº†åœºæ™¯å†…å®¹ï¼Œä½¿ç”¨æ•´åˆçš„å†…å®¹
            if (sceneFound && allScenesContent.trim()) {
                content += allScenesContent.trim();
            } else {
                // å¦åˆ™ä½¿ç”¨ç¼–è¾‘å™¨ä¸­çš„å†…å®¹ä½œä¸ºå¤‡é€‰
                const editor = document.getElementById('script-editor');
                const latestScript = editor ? editor.value : (currentProject.script || '');
                content += latestScript || 'æš‚æ— å‰§æœ¬å†…å®¹';
            }
            
            return content;
        }

        function generateDOCXContent() {
            // ç®€åŒ–ç‰ˆDOCXå¯¼å‡ºï¼Œå®é™…éœ€è¦ä½¿ç”¨jszipç­‰åº“
            let content = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>\n`;
            content += `<w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">\n`;
            content += `  <w:body>\n`;
            content += `    <w:p>\n`;
            content += `      <w:r><w:t>${currentProject.title}</w:t></w:r>\n`;
            content += `    </w:p>\n`;
            content += `    <w:p>\n`;
            content += `      <w:r><w:t>${currentProject.script || 'æš‚æ— å‰§æœ¬å†…å®¹'}</w:t></w:r>\n`;
            content += `    </w:p>\n`;
            content += `  </w:body>\n`;
            content += `</w:document>`;
            return content;
        }

        function generateFDXContent() {
            let content = `<?xml version="1.0" encoding="UTF-8"?>\n`;
            content += `<FinalDraft DocumentType="Script" Version="1">\n`;
            content += `  <Content>\n`;
            content += `    <Paragraph Type="Title">${currentProject.title}</Paragraph>\n`;
            
            const lines = (currentProject.script || '').split('\n');
            lines.forEach(line => {
                const trimmedLine = line.trim();
                if (trimmedLine === '') {
                    content += `    <Paragraph Type="Action"></Paragraph>\n`;
                } else if (trimmedLine.match(/^(INT|EXT)\./i)) {
                    content += `    <Paragraph Type="Scene Heading">${trimmedLine}</Paragraph>\n`;
                } else if (trimmedLine === trimmedLine.toUpperCase() && !trimmedLine.includes(' ') && 
                          currentProject.roles.some(role => role.name === trimmedLine)) {
                    content += `    <Paragraph Type="Character">${trimmedLine}</Paragraph>\n`;
                } else if (line.startsWith(' ')) {
                    content += `    <Paragraph Type="Dialogue">${trimmedLine}</Paragraph>\n`;
                } else {
                    content += `    <Paragraph Type="Action">${trimmedLine}</Paragraph>\n`;
                }
            });
            
            content += `  </Content>\n`;
            content += `</FinalDraft>`;
            return content;
        }

        function downloadFile(content, filename, mimeType) {
            try {
                // åˆ›å»ºBlobå¯¹è±¡
                const blob = new Blob([content], { type: mimeType });
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                
                // è§¦å‘ä¸‹è½½
                document.body.appendChild(link);
                link.click();
                
                // æ¸…ç†
                setTimeout(() => {
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                }, 100);
                
                console.log(`ğŸ“¥ æ–‡ä»¶ä¸‹è½½å·²è§¦å‘: ${filename}`);
                
            } catch (error) {
                console.error('æ–‡ä»¶ä¸‹è½½å¤±è´¥:', error);
                throw error;
            }
        }

        // --- Role Management Functions ---
        function renderRoles() {
            const rolesList = document.getElementById('roles-list');
            if (!rolesList) return;
            
            rolesList.innerHTML = currentProject.roles.map(role => `
                <div class="p-4 border-b border-gray-200 hover:bg-gray-50 cursor-pointer transition-colors" 
                     onclick="editRole('${role.id}')">
                    <div class="flex items-start justify-between">
                        <div>
                            <h4 class="font-semibold text-lg">${role.name}</h4>
                            <p class="text-sm text-gray-600">${role.age}å² Â· ${role.gender}</p>
                            <p class="text-sm text-gray-500 mt-1">${role.personality}</p>
                        </div>
                        <button class="text-red-500 hover:text-red-700" 
                                onclick="event.stopPropagation(); deleteRole('${role.id}')">
                            <i data-lucide="trash-2"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            
            lucide.createIcons();
        }

        function openRoleModal() {
            const modal = document.getElementById('role-modal');
            if (modal) {
                modal.classList.remove('hidden');
                renderRoles();
            }
        }

        function closeRoleModal() {
            const modal = document.getElementById('role-modal');
            if (modal) {
                modal.classList.add('hidden');
                clearRoleForm();
            }
        }

        function clearRoleForm() {
            const form = document.getElementById('role-form');
            if (form) {
                form.reset();
                document.getElementById('role-id').value = '';
            }
        }

        function addRole() {
            clearRoleForm();
            document.getElementById('role-modal-title').textContent = 'æ·»åŠ æ–°è§’è‰²';
            openRoleModal();
        }

        function editRole(roleId) {
            const role = currentProject.roles.find(r => r.id === roleId);
            if (!role) return;
            
            document.getElementById('role-modal-title').textContent = 'ç¼–è¾‘è§’è‰²';
            document.getElementById('role-id').value = role.id;
            document.getElementById('role-name').value = role.name;
            document.getElementById('role-age').value = role.age;
            document.getElementById('role-gender').value = role.gender;
            document.getElementById('role-personality').value = role.personality;
            document.getElementById('role-background').value = role.background;
            document.getElementById('role-relationships').value = role.relationships;
            document.getElementById('role-appearance').value = role.appearance;
            document.getElementById('role-goal').value = role.goal;
        }

        function deleteRole(roleId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè§’è‰²å—ï¼Ÿ')) {
                currentProject.roles = currentProject.roles.filter(r => r.id !== roleId);
                renderRoles();
            }
        }

        // --- Script Editor Sync ---
        function syncScriptEditor() {
            const scene = findSceneById(currentProject.currentSceneId);
            if (!scene) return;

            let scriptContent = `åœºæ™¯ï¼š${scene.title}\n`;
            scriptContent += `æè¿°ï¼š${scene.content}\n\n`;

            if (scene.shots && scene.shots.length > 0) {
                scriptContent += `ã€åˆ†é•œã€‘\n`;
                scene.shots.forEach((shot, index) => {
                    scriptContent += `${index + 1}. ${shot.title}: ${shot.description} (${shot.duration})\n`;
                });
            }

            const editor = document.getElementById('script-editor');
            editor.value = scriptContent;
            syncState.lastSyncedScript = scriptContent;
        }

        function manualSync() {
            const editor = document.getElementById('script-editor');
            const scriptContent = editor.value;
            
            // å°è¯•è§£æå‰§æœ¬å†…å®¹æ›´æ–°åˆ†é•œ
            const success = parseScriptToOutline(scriptContent);
            
            if (success) {
                syncState.lastSyncedScript = scriptContent;
                renderTimeline();
                showToast('åŒæ­¥æˆåŠŸï¼');
            } else {
                showToast('åŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ ¼å¼');
            }
        }

        function parseScriptToOutline(scriptContent) {
            try {
                const scene = findSceneById(currentProject.currentSceneId);
                if (!scene) return false;

                console.log('ğŸ¯ å½“å‰åœºæ™¯:', scene.title);
                console.log('ğŸ¬ å½“å‰åœºæ™¯åˆ†é•œæ•°é‡:', scene.shots.length);
                
                // è¶…çº§ç®€å•çš„è§£æé€»è¾‘ï¼šç›´æ¥æŸ¥æ‰¾åˆ†é•œç›¸å…³çš„è¡Œ
                const lines = scriptContent.split('\n');
                let updatedCount = 0;
                
                // æ–¹æ³•1ï¼šæŸ¥æ‰¾ã€åˆ†é•œã€‘æ ‡ç­¾åçš„å†…å®¹
                const mirrorIndex = lines.findIndex(line => line.includes('ã€åˆ†é•œã€‘'));
                if (mirrorIndex !== -1) {
                    console.log('ğŸ” æ‰¾åˆ°ã€åˆ†é•œã€‘æ ‡ç­¾ï¼Œå¼€å§‹è§£æ...');
                    let shotIndex = 0;
                    
                    for (let i = mirrorIndex + 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        
                        // å¦‚æœé‡åˆ°ç©ºè¡Œæˆ–æ–°çš„åœºæ™¯æ ‡è®°ï¼Œåœæ­¢è§£æ
                        if (line === '' || line.match(/^åœºæ™¯\d+:/) || line.match(/^ã€.*ã€‘$/)) {
                            break;
                        }
                        
                        // å°è¯•è§£æåˆ†é•œè¡Œ
                        if (line.length > 0 && shotIndex < scene.shots.length) {
                            // ç®€å•çš„è§£æï¼šæå–æ ‡é¢˜å’Œæè¿°
                            let title = line;
                            let description = '';
                            
                            // å°è¯•åˆ†ç¦»æ ‡é¢˜å’Œæè¿°ï¼ˆå¦‚æœæœ‰å†’å·ï¼‰
                            const colonIndex = line.indexOf(':');
                            if (colonIndex !== -1) {
                                title = line.substring(0, colonIndex).trim();
                                description = line.substring(colonIndex + 1).trim();
                            }
                            
                            // æ¸…ç†æ ‡é¢˜ï¼ˆç§»é™¤æ•°å­—å‰ç¼€ç­‰ï¼‰
                            title = title.replace(/^\d+\.\s*/, '').trim();
                            
                            // æ›´æ–°åˆ†é•œä¿¡æ¯
                            if (title !== scene.shots[shotIndex].title || 
                                description !== scene.shots[shotIndex].description) {
                                
                                if (title && title !== scene.shots[shotIndex].title) {
                                    scene.shots[shotIndex].title = title;
                                    console.log(`ğŸ¬ æ›´æ–°åˆ†é•œ ${shotIndex + 1} æ ‡é¢˜: "${title}"`);
                                }
                                
                                if (description && description !== scene.shots[shotIndex].description) {
                                    scene.shots[shotIndex].description = description;
                                    console.log(`ğŸ“ æ›´æ–°åˆ†é•œ ${shotIndex + 1} æè¿°: "${description.substring(0, 30)}..."`);
                                }
                                
                                updatedCount++;
                            }
                            
                            shotIndex++;
                        }
                    }
                }
                
                // æ–¹æ³•2ï¼šå¦‚æœæ²¡æ‰¾åˆ°ã€åˆ†é•œã€‘æ ‡ç­¾ï¼Œå°è¯•ç›´æ¥æŸ¥æ‰¾åˆ†é•œæ ¼å¼è¡Œ
                if (updatedCount === 0) {
                    console.log('ğŸ” æœªæ‰¾åˆ°ã€åˆ†é•œã€‘æ ‡ç­¾ï¼Œå°è¯•ç›´æ¥æŸ¥æ‰¾åˆ†é•œè¡Œ...');
                    
                    lines.forEach((line, index) => {
                        const trimmedLine = line.trim();
                        
                        // æŸ¥æ‰¾ç±»ä¼¼ "1. é•œå¤´åç§°" æˆ– "é•œå¤´1" çš„æ ¼å¼
                        const shotMatch = trimmedLine.match(/^(?:(\d+)\.\s+|é•œå¤´(\d+)\s*)(.+)$/);
                        if (shotMatch) {
                            const shotNum = shotMatch[1] || shotMatch[2];
                            const shotIndex = parseInt(shotNum) - 1;
                            
                            if (shotIndex >= 0 && shotIndex < scene.shots.length) {
                                const content = shotMatch[3].trim();
                                
                                // å°è¯•åˆ†ç¦»æ ‡é¢˜å’Œæè¿°
                                let title = content;
                                let description = '';
                                
                                const colonIndex = content.indexOf(':');
                                if (colonIndex !== -1) {
                                    title = content.substring(0, colonIndex).trim();
                                    description = content.substring(colonIndex + 1).trim();
                                }
                                
                                // æ›´æ–°åˆ†é•œ
                                if (title && title !== scene.shots[shotIndex].title) {
                                    scene.shots[shotIndex].title = title;
                                    updatedCount++;
                                    console.log(`ğŸ¬ ç›´æ¥è§£ææ›´æ–°åˆ†é•œ ${shotIndex + 1} æ ‡é¢˜: "${title}"`);
                                }
                                
                                if (description && description !== scene.shots[shotIndex].description) {
                                    scene.shots[shotIndex].description = description;
                                    updatedCount++;
                                    console.log(`ğŸ“ ç›´æ¥è§£ææ›´æ–°åˆ†é•œ ${shotIndex + 1} æè¿°: "${description.substring(0, 30)}..."`);
                                }
                            }
                        }
                    });
                }
                
                // æ–¹æ³•3ï¼šå¦‚æœè¿˜æ˜¯æ²¡æ‰¾åˆ°ï¼Œå°è¯•è§£ææ•´ä¸ªå‰§æœ¬å†…å®¹ä½œä¸ºå½“å‰åœºæ™¯çš„æè¿°
                if (updatedCount === 0) {
                    console.log('ğŸ” å°è¯•å°†æ•´ä¸ªå‰§æœ¬å†…å®¹ä½œä¸ºåœºæ™¯æè¿°...');
                    const cleanContent = scriptContent.replace(/ã€åˆ†é•œã€‘.*$/s, '').trim();
                    if (cleanContent && cleanContent.length > 10) {
                        scene.content = cleanContent;
                        console.log(`ğŸ“‹ æ›´æ–°åœºæ™¯æè¿°ï¼Œé•¿åº¦: ${cleanContent.length}`);
                    }
                }
                
                console.log(`ğŸ“Š è§£æå®Œæˆï¼Œæ›´æ–°äº† ${updatedCount} ä¸ªåˆ†é•œ`);
                
                // å³ä½¿æ²¡æœ‰æ›´æ–°åˆ†é•œï¼Œä¹Ÿè¦è¿”å›trueè¡¨ç¤ºè§£ææˆåŠŸ
                return true;
                
            } catch (error) {
                console.error('ğŸ’¥ è§£æå‰§æœ¬æ—¶å‘ç”Ÿé”™è¯¯:', error);
                console.error('é”™è¯¯å †æ ˆ:', error.stack);
                return true;
            }
        }

        // --- Initialization ---
        function init() {
            console.log('ğŸš€ åˆå§‹åŒ–åº”ç”¨...');
            
            // åŠ è½½ç¤ºä¾‹æ•°æ®
            currentProject.outline = mockOutlines['three-act'];
            currentProject.roles = mockRoles;
            
            // æ¸²æŸ“ç•Œé¢
            renderOutlineTree();
            
            // é€‰æ‹©ç¬¬ä¸€ä¸ªåœºæ™¯
            if (currentProject.outline.length > 0 && currentProject.outline[0].children.length > 0) {
                selectScene(currentProject.outline[0].children[0].id);
            }
            
            // ç»‘å®šäº‹ä»¶
            document.getElementById('generate-outline-btn').addEventListener('click', () => {
                const structure = document.getElementById('outline-structure-select').value;
                currentProject.outline = mockOutlines[structure] || [];
                renderOutlineTree();
                showToast('å¤§çº²ç»“æ„å·²ç”Ÿæˆï¼');
            });

            document.getElementById('outline-keyword-input').addEventListener('input', (e) => {
                const keyword = e.target.value.toLowerCase();
                // ç®€å•çš„æœç´¢åŠŸèƒ½
                console.log('ğŸ” æœç´¢å…³é”®è¯:', keyword);
            });

            document.getElementById('role-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const roleId = document.getElementById('role-id').value;
                const roleData = {
                    name: document.getElementById('role-name').value,
                    age: document.getElementById('role-age').value,
                    gender: document.getElementById('role-gender').value,
                    personality: document.getElementById('role-personality').value,
                    background: document.getElementById('role-background').value,
                    relationships: document.getElementById('role-relationships').value,
                    appearance: document.getElementById('role-appearance').value,
                    goal: document.getElementById('role-goal').value,
                    image: ''
                };

                if (roleId) {
                    const role = currentProject.roles.find(r => r.id === roleId);
                    if (role) {
                        Object.assign(role, roleData);
                    }
                } else {
                    roleData.id = Date.now().toString();
                    currentProject.roles.push(roleData);
                }

                renderRoles();
                showToast('è§’è‰²ä¿¡æ¯å·²ä¿å­˜');
            });

            // ç¼–è¾‘å™¨è‡ªåŠ¨åŒæ­¥
            const scriptEditor = document.getElementById('script-editor');
            scriptEditor.addEventListener('input', () => {
                syncState.scriptEditorModified = true;
            });

            // å®šæ—¶è‡ªåŠ¨åŒæ­¥
            setInterval(() => {
                if (syncState.scriptEditorModified) {
                    const currentScript = scriptEditor.value;
                    if (currentScript !== syncState.lastSyncedScript) {
                        manualSync();
                        syncState.scriptEditorModified = false;
                    }
                }
            }, 3000);

            console.log('âœ… åº”ç”¨åˆå§‹åŒ–å®Œæˆï¼');
        }

        // --- Debug Functions ---
        function createDebugButton() {
            console.log('ğŸ”§ åˆ›å»ºè°ƒè¯•æŒ‰é’®...');
            
            const header = document.querySelector('header');
            if (!header) {
                console.error('âŒ æ‰¾ä¸åˆ°å¤´éƒ¨å®¹å™¨ï¼');
                return;
            }

            const debugContainer = document.createElement('div');
            debugContainer.className = 'flex items-center space-x-2';
            debugContainer.innerHTML = `
                <div class="h-px w-8 bg-black mx-2"></div>
                <button id="debug-export-btn" class="bg-green-600 text-white px-4 py-2 rounded-md shadow-lg flex items-center space-x-2 text-sm font-bold">
                    <i data-lucide="bug" class="w-4 h-4"></i>
                    <span>è°ƒè¯•å¯¼å‡º</span>
                </button>
            `;

            header.appendChild(debugContainer);
            lucide.createIcons();

            const debugBtn = document.getElementById('debug-export-btn');
            if (debugBtn) {
                console.log('âœ… è°ƒè¯•æŒ‰é’®åˆ›å»ºæˆåŠŸï¼Œæ­£åœ¨ç»‘å®šäº‹ä»¶...');
                debugBtn.onclick = function() {
                    console.log('ğŸ›ğŸ›ğŸ› è°ƒè¯•å¯¼å‡ºæŒ‰é’®è¢«ç‚¹å‡»ï¼');
                    testExportModal();
                };
            } else {
                console.error('âŒ è°ƒè¯•æŒ‰é’®åˆ›å»ºå¤±è´¥ï¼');
            }
        }

        function testExportModal() {
            console.log('ğŸ” æµ‹è¯•å¯¼å‡ºé¢æ¿åŠŸèƒ½...');
            
            const exportModal = document.getElementById('export-modal');
            console.log('å¯¼å‡ºé¢æ¿å…ƒç´ :', exportModal);
            
            if (exportModal) {
                console.log('âœ… å¯¼å‡ºé¢æ¿å…ƒç´ å­˜åœ¨');
                console.log('å½“å‰ç±»å:', exportModal.className);
                
                exportModal.classList.remove('hidden');
                exportModal.classList.add('flex');
                console.log('ä¿®æ”¹åçš„ç±»å:', exportModal.className);
                
                const computedStyle = window.getComputedStyle(exportModal);
                console.log('æ˜¾ç¤ºçŠ¶æ€:', computedStyle.display);
                
                showToast('å¯¼å‡ºé¢æ¿æµ‹è¯•ï¼šå·²å°è¯•æ˜¾ç¤ºé¢æ¿ï¼Œè¯·æ£€æŸ¥ç•Œé¢');
            } else {
                console.error('âŒ æ‰¾ä¸åˆ°å¯¼å‡ºé¢æ¿å…ƒç´ ï¼');
                showToast('é”™è¯¯ï¼šæ‰¾ä¸åˆ°å¯¼å‡ºé¢æ¿å…ƒç´ ');
            }
        }

        // é¦–é¡µç›¸å…³å‡½æ•°
        function showApp() {
            console.log('ğŸš€ æ˜¾ç¤ºç¼–è¾‘å™¨åº”ç”¨');
            
            // æ·»åŠ åŠ è½½çŠ¶æ€
            const buttons = document.querySelectorAll('[onclick="showApp()"]');
            buttons.forEach(btn => {
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i data-lucide="loader-2" class="w-5 h-5 mr-2 animate-spin"></i>åŠ è½½ä¸­...';
                btn.disabled = true;
                btn.classList.add('opacity-70', 'cursor-not-allowed');
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    btn.classList.remove('opacity-70', 'cursor-not-allowed');
                    lucide.createIcons();
                }, 2000);
            });
            
            // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            showLoadingAnimation();
            
            // å»¶è¿Ÿæ˜¾ç¤ºåº”ç”¨ï¼Œæ¨¡æ‹ŸåŠ è½½è¿‡ç¨‹
            setTimeout(() => {
                document.getElementById('homepage').style.display = 'none';
                document.getElementById('app').style.display = 'flex';
                document.getElementById('app').style.flexDirection = 'column';
                document.getElementById('app').style.height = '100vh';
                
                // é‡æ–°åˆå§‹åŒ–ç¼–è¾‘å™¨
                setTimeout(() => {
                    lucide.createIcons();
                    initializeApp();
                    hideLoadingAnimation();
                }, 500);
            }, 1500);
        }

        function scrollToFeatures() {
            console.log('ğŸ“‹ æ»šåŠ¨åˆ°åŠŸèƒ½ç‰¹æ€§');
            const featuresSection = document.getElementById('features');
            if (featuresSection) {
                // æ·»åŠ æ»šåŠ¨åŠ¨ç”»æ•ˆæœ
                featuresSection.scrollIntoView({ 
                    behavior: 'smooth',
                    block: 'start'
                });
                
                // æ·»åŠ é«˜äº®æ•ˆæœ
                setTimeout(() => {
                    featuresSection.classList.add('animate-pulse');
                    setTimeout(() => {
                        featuresSection.classList.remove('animate-pulse');
                    }, 1000);
                }, 800);
            }
        }

        function showLoadingAnimation() {
            // åˆ›å»ºåŠ è½½åŠ¨ç”»å…ƒç´ 
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading-overlay';
            loadingDiv.className = 'fixed inset-0 bg-white bg-opacity-90 flex items-center justify-center z-50';
            loadingDiv.innerHTML = `
                <div class="text-center">
                    <div class="w-16 h-16 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mx-auto mb-4"></div>
                    <h3 class="text-xl font-semibold text-gray-900 mb-2">æ­£åœ¨å‡†å¤‡åˆ›ä½œç¯å¢ƒ</h3>
                    <p class="text-gray-600">å³å°†å¼€å¯æ‚¨çš„åˆ›ä½œä¹‹æ—…...</p>
                </div>
            `;
            document.body.appendChild(loadingDiv);
        }

        function hideLoadingAnimation() {
            const loadingDiv = document.getElementById('loading-overlay');
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }

        function initializeApp() {
            console.log('ğŸ”§ åˆå§‹åŒ–åº”ç”¨');
            
            // é‡æ–°åˆå§‹åŒ–æ‰€æœ‰ç¼–è¾‘å™¨åŠŸèƒ½
            if (typeof init === 'function') {
                init();
            }
            
            // é‡æ–°åŠ è½½åœºæ™¯åˆ—è¡¨
            if (typeof renderSceneList === 'function') {
                renderSceneList();
            }
            
            // é‡æ–°åŠ è½½åˆ†é•œæ—¶é—´è½´
            if (typeof renderStoryboardTimeline === 'function') {
                renderStoryboardTimeline();
            }
            
            // æ˜¾ç¤ºæ¬¢è¿æç¤º
            setTimeout(() => {
                showToast('ğŸ‰ æ¬¢è¿ä½¿ç”¨å½±å‰§å¸ˆï¼å¼€å§‹æ‚¨çš„åˆ›ä½œä¹‹æ—…å§ï¼');
            }, 1000);
        }

        // --- å‰§æœ¬ç¼–è¾‘å™¨å¢å¼ºåŠŸèƒ½ ---
        let editorHistory = [];
        let historyIndex = -1;
        let autoSaveEnabled = true;
        let autoSaveTimer = null;
        let wordCountVisible = false;

        // åˆå§‹åŒ–ç¼–è¾‘å™¨
        function initScriptEditor() {
            const editor = document.getElementById('script-editor');
            if (!editor) return;

            // ç»‘å®šäº‹ä»¶
            editor.addEventListener('input', handleEditorInput);
            editor.addEventListener('keydown', handleEditorKeydown);
            editor.addEventListener('scroll', syncLineNumbers);
            editor.addEventListener('click', updateCursorPosition);
            editor.addEventListener('keyup', updateCursorPosition);

            // åˆå§‹åŒ–è¡Œå·
            updateLineNumbers();
            
            // å¯åŠ¨è‡ªåŠ¨ä¿å­˜
            startAutoSave();
            
            // åˆå§‹åŒ–å­—æ•°ç»Ÿè®¡
            updateWordCount();
        }

        // å¤„ç†ç¼–è¾‘å™¨è¾“å…¥
        function handleEditorInput() {
            const editor = document.getElementById('script-editor');
            const content = editor.value;
            
            // ä¿å­˜åˆ°å†å²è®°å½•
            saveToHistory(content);
            
            // æ›´æ–°è¡Œå·
            updateLineNumbers();
            
            // æ›´æ–°å­—æ•°ç»Ÿè®¡
            updateWordCount();
            
            // æ›´æ–°å…‰æ ‡ä½ç½®
            updateCursorPosition();
            
            // æ›´æ–°é¡¹ç›®çŠ¶æ€
            currentProject.script = content;
            
            // è§¦å‘åŒæ­¥
            if (syncEnabled) {
                syncScriptToStoryboard();
            }
        }

        // å¤„ç†é”®ç›˜å¿«æ·é”®
        function handleEditorKeydown(e) {
            // Ctrl+Z: æ’¤é”€
            if (e.ctrlKey && e.key === 'z') {
                e.preventDefault();
                undoAction();
            }
            // Ctrl+Y: é‡åš
            else if (e.ctrlKey && e.key === 'y') {
                e.preventDefault();
                redoAction();
            }
            // Ctrl+F: æœç´¢
            else if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                toggleSearchReplace();
            }
            // Tabé”®å¤„ç†
            else if (e.key === 'Tab') {
                e.preventDefault();
                insertTab();
            }
        }

        // ä¿å­˜åˆ°å†å²è®°å½•
        function saveToHistory(content) {
            // å¦‚æœå½“å‰ä¸æ˜¯æœ€æ–°çŠ¶æ€ï¼Œåˆ é™¤åé¢çš„å†å²
            if (historyIndex < editorHistory.length - 1) {
                editorHistory = editorHistory.slice(0, historyIndex + 1);
            }
            
            // æ·»åŠ æ–°å†…å®¹åˆ°å†å²
            editorHistory.push(content);
            
            // é™åˆ¶å†å²è®°å½•é•¿åº¦
            if (editorHistory.length > 100) {
                editorHistory.shift();
            } else {
                historyIndex++;
            }
        }

        // æ’¤é”€
        function undoAction() {
            if (historyIndex > 0) {
                historyIndex--;
                applyHistoryState();
            }
        }

        // é‡åš
        function redoAction() {
            if (historyIndex < editorHistory.length - 1) {
                historyIndex++;
                applyHistoryState();
            }
        }

        // åº”ç”¨å†å²çŠ¶æ€
        function applyHistoryState() {
            const editor = document.getElementById('script-editor');
            const content = editorHistory[historyIndex];
            editor.value = content;
            currentProject.script = content;
            updateLineNumbers();
            updateWordCount();
            syncLineNumbers();
            
            if (syncEnabled) {
                syncScriptToStoryboard();
            }
        }

        // æ ¼å¼åŒ–å‰§æœ¬
        function formatScript() {
            const editor = document.getElementById('script-editor');
            let content = editor.value;
            
            // åœºæ™¯æ ‡é¢˜å¤§å†™
            content = content.replace(/^(INT\.|EXT\.|INT\/EXT\.)\s+.*$/gm, match => match.toUpperCase());
            
            // è§’è‰²åç§°å±…ä¸­å¤§å†™
            content = content.replace(/^([A-Z][A-Z\s]+)$/gm, match => {
                if (match.length > 2 && !match.includes(' ') && !match.match(/[.,!?]/)) {
                    return match; // ä¸æ˜¯è§’è‰²åç§°
                }
                return match.toUpperCase();
            });
            
            // å¯¹ç™½ç¼©è¿›
            content = content.replace(/^([A-Z][A-Z\s]+)$\n((?:(?!^[A-Z][A-Z\s]+$|^(INT\.|EXT\.|INT\/EXT\.)).*\n?)+)/gm, (match, character, dialogue) => {
                const indentedDialogue = dialogue.split('\n').map(line => 
                    line.trim() ? '    ' + line : line
                ).join('\n');
                return character + '\n' + indentedDialogue;
            });
            
            editor.value = content;
            handleEditorInput();
            showToast('âœ… å‰§æœ¬æ ¼å¼åŒ–å®Œæˆ');
        }

        // æ’å…¥åœºæ™¯æ ‡é¢˜
        function insertSceneHeading() {
            insertTextAtCursor('INT. LOCATION - TIME\n\n');
        }

        // æ’å…¥è§’è‰²åç§°
        function insertCharacterName() {
            insertTextAtCursor('CHARACTER\n\n');
        }

        // æ’å…¥å¯¹ç™½
        function insertDialogue() {
            insertTextAtCursor('    Dialogue here...\n\n');
        }

        // æ’å…¥åŠ¨ä½œæè¿°
        function insertAction() {
            insertTextAtCursor('Action description here...\n\n');
        }

        // åœ¨å…‰æ ‡ä½ç½®æ’å…¥æ–‡æœ¬
        function insertTextAtCursor(text) {
            const editor = document.getElementById('script-editor');
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const content = editor.value;
            
            const newContent = content.substring(0, start) + text + content.substring(end);
            editor.value = newContent;
            
            // è®¾ç½®æ–°çš„å…‰æ ‡ä½ç½®
            const newPosition = start + text.length;
            editor.setSelectionRange(newPosition, newPosition);
            
            handleEditorInput();
            editor.focus();
        }

        // æ’å…¥Tab
        function insertTab() {
            insertTextAtCursor('    ');
        }

        // æ›´æ–°è¡Œå·
        function updateLineNumbers() {
            const editor = document.getElementById('script-editor');
            const lineNumbers = document.getElementById('line-numbers');
            if (!editor || !lineNumbers) return;
            
            const lines = editor.value.split('\n');
            const lineNumbersHtml = lines.map((_, index) => index + 1).join('<br>');
            lineNumbers.innerHTML = lineNumbersHtml;
        }

        // åŒæ­¥è¡Œå·æ»šåŠ¨
        function syncLineNumbers() {
            const editor = document.getElementById('script-editor');
            const lineNumbers = document.getElementById('line-numbers');
            if (!editor || !lineNumbers) return;
            
            lineNumbers.scrollTop = editor.scrollTop;
        }

        // æ›´æ–°å…‰æ ‡ä½ç½®
        function updateCursorPosition() {
            const editor = document.getElementById('script-editor');
            const positionDisplay = document.getElementById('cursor-position');
            if (!editor || !positionDisplay) return;
            
            const cursorPos = editor.selectionStart;
            const textBeforeCursor = editor.value.substring(0, cursorPos);
            const lines = textBeforeCursor.split('\n');
            const line = lines.length;
            const column = lines[lines.length - 1].length + 1;
            
            positionDisplay.textContent = `è¡Œ: ${line}, åˆ—: ${column}`;
        }

        // æ›´æ–°å­—æ•°ç»Ÿè®¡
        function updateWordCount() {
            const editor = document.getElementById('script-editor');
            if (!editor) return;
            
            const content = editor.value;
            const charCount = content.length;
            const lineCount = content.split('\n').length;
            const sceneCount = (content.match(/^(INT\.|EXT\.|INT\/EXT\.)/gm) || []).length;
            
            const charCountElement = document.getElementById('char-count');
            const lineCountElement = document.getElementById('line-count');
            const sceneCountElement = document.getElementById('scene-count');
            
            if (charCountElement) charCountElement.textContent = charCount;
            if (lineCountElement) lineCountElement.textContent = lineCount;
            if (sceneCountElement) sceneCountElement.textContent = sceneCount;
        }

        // åˆ‡æ¢å­—æ•°ç»Ÿè®¡æ˜¾ç¤º
        function toggleWordCount() {
            const panel = document.getElementById('word-count-panel');
            if (!panel) return;
            
            wordCountVisible = !wordCountVisible;
            panel.style.display = wordCountVisible ? 'block' : 'none';
        }

        // åˆ‡æ¢è‡ªåŠ¨ä¿å­˜
        function toggleAutoSave() {
            autoSaveEnabled = !autoSaveEnabled;
            const statusDisplay = document.getElementById('auto-save-status');
            if (statusDisplay) {
                statusDisplay.textContent = `è‡ªåŠ¨ä¿å­˜: ${autoSaveEnabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨'}`;
            }
            
            if (autoSaveEnabled) {
                startAutoSave();
                showToast('âœ… è‡ªåŠ¨ä¿å­˜å·²å¯ç”¨');
            } else {
                stopAutoSave();
                showToast('âš ï¸ è‡ªåŠ¨ä¿å­˜å·²ç¦ç”¨');
            }
        }

        // å¯åŠ¨è‡ªåŠ¨ä¿å­˜
        function startAutoSave() {
            if (autoSaveTimer) {
                clearInterval(autoSaveTimer);
            }
            
            autoSaveTimer = setInterval(() => {
                if (autoSaveEnabled) {
                    saveProject();
                }
            }, 30000); // æ¯30ç§’è‡ªåŠ¨ä¿å­˜
        }

        // åœæ­¢è‡ªåŠ¨ä¿å­˜
        function stopAutoSave() {
            if (autoSaveTimer) {
                clearInterval(autoSaveTimer);
                autoSaveTimer = null;
            }
        }

        // æœç´¢æ›¿æ¢åŠŸèƒ½
        function toggleSearchReplace() {
            showToast('ğŸ” æœç´¢æ›¿æ¢åŠŸèƒ½å¼€å‘ä¸­...');
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–ç¼–è¾‘å™¨
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(initScriptEditor, 100);
        });
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOMåŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–åº”ç”¨...');
            init();
        });
    </script>

</div></body></html>