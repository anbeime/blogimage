“热点视频工坊” 应用的完整开发文档，涵盖了应用概述、核心功能、界面设计、技术实现等各个维度。我会基于这份文档，帮你梳理出一个可落地的**核心功能代码实现框架**，聚焦于前端核心逻辑和后端 API 设计，让你能快速搭建起应用的基础骨架。

---

## 一、核心功能实现思路

我会基于文档中提到的技术栈（React Native + Redux + Node.js/Express + MongoDB + FFmpeg），实现以下核心模块：

1. 前端：参数设置界面（核心交互入口）、状态管理（额度 / 金币 / 用户配置）
2. 后端：热点推荐 API、视频生成任务 API、用户额度管理 API
3. 核心逻辑：分镜脚本生成、视频合成调用

## 二、前端实现（React Native）

### 2.1 项目基础配置（关键依赖安装）

bash

运行

```
# 初始化React Native项目
npx react-native init HotVideoWorkshop
cd HotVideoWorkshop

# 安装核心依赖
npm install redux react-redux @reduxjs/toolkit axios react-navigation/native @react-navigation/stack react-native-safe-area-context react-native-screens
# 安装UI组件（可选，用于快速实现界面）
npm install react-native-paper react-native-slider
```

### 2.2 状态管理（Redux）- 存储用户额度、配置等核心状态

javascript

运行

```
// src/store/slices/appSlice.js
import { createSlice } from '@reduxjs/toolkit';

const initialState = {
  // 用户创作额度
  freeQuota: 3,
  // 金币数量
  goldCoins: 0,
  // 额外兑换的额度
  extraQuota: 0,
  // 当前选中的热点
  selectedHotTopic: null,
  // 参数设置
  videoParams: {
    shareLink: '',
    hotKeywords: '', // 最多15字符
    imageDesc: '',
    shotCount: 3, // 3-5个分镜
    videoStyle: 'hotNews', // 热点资讯/剧情创意/知识科普
    movieStyle: 'none', // 悬疑惊悚/轻松喜剧/浪漫爱情
    scriptElement: 'emotionalResonance' // 情感共鸣/悬念反转/生活化表达
  }
};

export const appSlice = createSlice({
  name: 'app',
  initialState,
  reducers: {
    // 减少创作额度
    useQuota: (state) => {
      if (state.freeQuota > 0) {
        state.freeQuota -= 1;
      } else if (state.extraQuota > 0) {
        state.extraQuota -= 1;
      }
    },
    // 金币兑换额度（假设10金币兑换1次）
    exchangeQuota: (state, action) => {
      const exchangeCount = action.payload;
      if (state.goldCoins >= exchangeCount * 10) {
        state.goldCoins -= exchangeCount * 10;
        state.extraQuota += exchangeCount;
      }
    },
    // 更新视频参数
    updateVideoParams: (state, action) => {
      state.videoParams = { ...state.videoParams, ...action.payload };
    },
    // 选择热点话题
    selectHotTopic: (state, action) => {
      state.selectedHotTopic = action.payload;
    }
  }
});

export const { useQuota, exchangeQuota, updateVideoParams, selectHotTopic } = appSlice.actions;
export default appSlice.reducer;
```

javascript

运行

```
// src/store/store.js
import { configureStore } from '@reduxjs/toolkit';
import appReducer from './slices/appSlice';

export const store = configureStore({
  reducer: {
    app: appReducer
  }
});
```

### 2.3 参数设置界面（核心交互页面）

javascript

运行

```
// src/screens/ParamsSettingScreen.js
import React, { useState } from 'react';
import { View, Text, TextInput, Button, Picker, StyleSheet, ScrollView } from 'react-native';
import { useDispatch, useSelector } from 'react-redux';
import { updateVideoParams } from '../store/slices/appSlice';

const ParamsSettingScreen = () => {
  const dispatch = useDispatch();
  const { videoParams } = useSelector((state) => state.app);
  const [localParams, setLocalParams] = useState(videoParams);

  // 保存参数
  const saveParams = () => {
    // 验证关键词长度（最多15字符）
    if (localParams.hotKeywords.length > 15) {
      alert('热点关键词最多15个字符');
      return;
    }
    // 验证分镜数量（3-5）
    if (localParams.shotCount < 3 || localParams.shotCount > 5) {
      alert('分镜数量需在3-5之间');
      return;
    }
    dispatch(updateVideoParams(localParams));
    alert('参数设置成功');
  };

  return (
    <ScrollView style={styles.container}>
      {/* 1. 分享链接解析 */}
      <View style={styles.inputGroup}>
        <Text style={styles.label}>分享链接解析</Text>
        <TextInput
          style={styles.input}
          value={localParams.shareLink}
          onChangeText={(text) => setLocalParams({ ...localParams, shareLink: text })}
          placeholder="输入抖音/快手/B站视频链接"
        />
      </View>

      {/* 2. 热点关键词 */}
      <View style={styles.inputGroup}>
        <Text style={styles.label}>热点关键词（最多15字）</Text>
        <TextInput
          style={styles.input}
          value={localParams.hotKeywords}
          onChangeText={(text) => setLocalParams({ ...localParams, hotKeywords: text })}
          placeholder="输入热点关键词"
          maxLength={15}
        />
      </View>

      {/* 3. 参考图片描述 */}
      <View style={styles.inputGroup}>
        <Text style={styles.label}>参考图片描述</Text>
        <TextInput
          style={styles.input}
          value={localParams.imageDesc}
          onChangeText={(text) => setLocalParams({ ...localParams, imageDesc: text })}
          placeholder="描述图片风格/人物/场景"
          multiline
        />
      </View>

      {/* 4. 分镜数量 */}
      <View style={styles.inputGroup}>
        <Text style={styles.label}>分镜数量（3-5）</Text>
        <Picker
          selectedValue={localParams.shotCount}
          onValueChange={(value) => setLocalParams({ ...localParams, shotCount: value })}
          style={styles.picker}
        >
          <Picker.Item label="3个分镜" value={3} />
          <Picker.Item label="4个分镜" value={4} />
          <Picker.Item label="5个分镜" value={5} />
        </Picker>
      </View>

      {/* 5. 视频风格 */}
      <View style={styles.inputGroup}>
        <Text style={styles.label}>视频风格</Text>
        <Picker
          selectedValue={localParams.videoStyle}
          onValueChange={(value) => setLocalParams({ ...localParams, videoStyle: value })}
          style={styles.picker}
        >
          <Picker.Item label="热点资讯" value="hotNews" />
          <Picker.Item label="剧情创意" value="storyCreative" />
          <Picker.Item label="知识科普" value="knowledge" />
        </Picker>
      </View>

      {/* 6. 电影风格 */}
      <View style={styles.inputGroup}>
        <Text style={styles.label}>电影风格</Text>
        <Picker
          selectedValue={localParams.movieStyle}
          onValueChange={(value) => setLocalParams({ ...localParams, movieStyle: value })}
          style={styles.picker}
        >
          <Picker.Item label="不使用" value="none" />
          <Picker.Item label="悬疑惊悚" value="suspense" />
          <Picker.Item label="轻松喜剧" value="comedy" />
          <Picker.Item label="浪漫爱情" value="romance" />
        </Picker>
      </View>

      {/* 7. 脚本创作元素 */}
      <View style={styles.inputGroup}>
        <Text style={styles.label}>脚本创作元素</Text>
        <Picker
          selectedValue={localParams.scriptElement}
          onValueChange={(value) => setLocalParams({ ...localParams, scriptElement: value })}
          style={styles.picker}
        >
          <Picker.Item label="情感共鸣" value="emotionalResonance" />
          <Picker.Item label="悬念反转" value="suspenseReversal" />
          <Picker.Item label="生活化表达" value="dailyExpression" />
        </Picker>
      </View>

      <Button title="保存参数" onPress={saveParams} />
    </ScrollView>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    padding: 20,
    backgroundColor: '#fef7fb', // 浅粉渐变基底
  },
  inputGroup: {
    marginBottom: 20,
  },
  label: {
    fontSize: 16,
    marginBottom: 8,
    color: '#333',
  },
  input: {
    height: 40,
    borderColor: '#ddd',
    borderWidth: 1,
    borderRadius: 8,
    paddingHorizontal: 10,
    backgroundColor: '#fff',
  },
  picker: {
    height: 50,
    borderColor: '#ddd',
    borderWidth: 1,
    borderRadius: 8,
    backgroundColor: '#fff',
  },
});

export default ParamsSettingScreen;
```

### 2.4 主界面（核心功能入口）

javascript

运行

```
// src/screens/HomeScreen.js
import React from 'react';
import { View, Text, Button, StyleSheet, TouchableOpacity } from 'react-native';
import { useDispatch, useSelector } from 'react-redux';
import { useQuota, exchangeQuota } from '../store/slices/appSlice';
import { useNavigation } from '@react-navigation/native';

const HomeScreen = () => {
  const dispatch = useDispatch();
  const navigation = useNavigation();
  const { freeQuota, goldCoins, extraQuota } = useSelector((state) => state.app);

  // 生成视频（扣减额度）
  const generateVideo = () => {
    if (freeQuota + extraQuota <= 0) {
      alert('暂无创作额度，可兑换额外额度');
      return;
    }
    dispatch(useQuota());
    // 跳转到参数设置页，完成后调用后端生成接口
    navigation.navigate('ParamsSetting');
  };

  // 兑换额度（10金币=1次）
  const exchange = () => {
    if (goldCoins < 10) {
      alert('金币不足，无法兑换');
      return;
    }
    dispatch(exchangeQuota(1));
    alert('兑换成功，获得1次额外创作额度');
  };

  return (
    <View style={styles.container}>
      {/* 顶部状态区 */}
      <View style={styles.statusBar}>
        <Text style={styles.statusText}>09:30</Text>
        <View style={styles.statusIcons}>
          <Text style={styles.callIcon}>📞</Text>
          <Text style={styles.msgIcon}>💬</Text>
          <Text style={styles.signalIcon}>📶</Text>
          <Text style={styles.batteryIcon}>🔋90%</Text>
        </View>
      </View>

      {/* 应用标题区 */}
      <View style={styles.header}>
        <Text style={styles.title}>热点视频工坊</Text>
        <Text style={styles.subtitle}>一键生成高质量热点视频</Text>
      </View>

      {/* 额度信息区 */}
      <View style={styles.quotaArea}>
        <Text style={styles.quotaText}>今日免费额度：{freeQuota}次</Text>
        <Text style={styles.quotaText}>额外额度：{extraQuota}次</Text>
        <Text style={styles.quotaText}>金币：{goldCoins}个</Text>
        <TouchableOpacity style={styles.exchangeBtn} onPress={exchange}>
          <Text style={styles.exchangeText}>兑换额度（10金币/次）</Text>
        </TouchableOpacity>
      </View>

      {/* 核心功能按钮 */}
      <View style={styles.buttonsArea}>
        <Button title="生成热点视频" onPress={generateVideo} />
        <Button title="分镜脚本历史" onPress={() => navigation.navigate('ScriptHistory')} />
        <Button title="收藏模板" onPress={() => navigation.navigate('CollectedTemplates')} />
        <Button title="热点推荐" onPress={() => navigation.navigate('HotTopics')} />
      </View>
    </View>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#fef7fb', // 浅粉渐变基底
    padding: 20,
  },
  statusBar: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 20,
  },
  statusText: {
    color: '#fff',
    fontSize: 14,
  },
  statusIcons: {
    flexDirection: 'row',
    gap: 8,
  },
  callIcon: {
    color: 'red',
  },
  msgIcon: {
    color: 'blue',
  },
  signalIcon: {
    color: '#fff',
  },
  batteryIcon: {
    color: '#fff',
  },
  header: {
    marginBottom: 30,
  },
  title: {
    fontSize: 24,
    fontWeight: 'bold',
    color: '#333',
    textAlign: 'center',
  },
  subtitle: {
    fontSize: 14,
    color: '#666',
    textAlign: 'center',
    marginTop: 8,
  },
  quotaArea: {
    backgroundColor: '#fff',
    padding: 15,
    borderRadius: 12,
    marginBottom: 30,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.1,
    shadowRadius: 8,
  },
  quotaText: {
    fontSize: 16,
    marginBottom: 8,
    color: '#333',
  },
  exchangeBtn: {
    backgroundColor: '#ff6b8b',
    padding: 10,
    borderRadius: 8,
    marginTop: 10,
  },
  exchangeText: {
    color: '#fff',
    textAlign: 'center',
    fontSize: 14,
  },
  buttonsArea: {
    gap: 15,
  },
});

export default HomeScreen;
```

## 三、后端实现（Node.js + Express + MongoDB）

### 3.1 项目初始化与依赖安装

bash

运行

```
# 初始化后端项目
mkdir hot-video-server && cd hot-video-server
npm init -y

# 安装核心依赖
npm install express mongoose axios ffmpeg-static cors dotenv
# 安装开发依赖
npm install nodemon --save-dev
```

### 3.2 数据库模型设计（MongoDB）

javascript

运行

```
// models/User.js
const mongoose = require('mongoose');

const userSchema = new mongoose.Schema({
  userId: { type: String, required: true, unique: true },
  freeQuota: { type: Number, default: 3 },
  extraQuota: { type: Number, default: 0 },
  goldCoins: { type: Number, default: 0 },
  // 分镜脚本历史
  scriptHistory: [{
    title: String,
    content: Object, // 脚本内容（分镜、台词等）
    createTime: { type: Date, default: Date.now },
    videoUrl: String // 生成的视频链接
  }],
  // 收藏的模板
  collectedTemplates: [{
    templateId: String,
    templateName: String,
    style: String,
    collectTime: { type: Date, default: Date.now }
  }]
});

module.exports = mongoose.model('User', userSchema);
```

javascript

运行

```
// models/HotTopic.js
const mongoose = require('mongoose');

const hotTopicSchema = new mongoose.Schema({
  title: { type: String, required: true },
  content: { type: String, required: true },
  hotDegree: { type: Number, default: 0 }, // 热度值
  source: { type: String }, // 来源：抖音/快手/微博等
  createTime: { type: Date, default: Date.now },
  category: { type: String } // 分类：新闻/娱乐/科技等
});

module.exports = mongoose.model('HotTopic', hotTopicSchema);
```

### 3.3 核心 API 接口实现

javascript

运行

```
// server.js
require('dotenv').config();
const express = require('express');
const mongoose = require('mongoose');
const cors = require('cors');
const User = require('./models/User');
const HotTopic = require('./models/HotTopic');
const ffmpeg = require('ffmpeg-static');
const { exec } = require('child_process');
const path = require('path');

const app = express();
const PORT = process.env.PORT || 3000;

// 中间件
app.use(cors());
app.use(express.json());

// 连接MongoDB
mongoose.connect(process.env.MONGODB_URI || 'mongodb://localhost:27017/hotVideoWorkshop')
  .then(() => console.log('MongoDB连接成功'))
  .catch(err => console.error('MongoDB连接失败：', err));

// 1. 获取热点话题列表
app.get('/api/hot-topics', async (req, res) => {
  try {
    // 按热度排序
    const hotTopics = await HotTopic.find().sort({ hotDegree: -1 }).limit(10);
    res.status(200).json({ success: true, data: hotTopics });
  } catch (err) {
    res.status(500).json({ success: false, message: '获取热点失败', error: err.message });
  }
});

// 2. 获取热点详情
app.get('/api/hot-topics/:id', async (req, res) => {
  try {
    const hotTopic = await HotTopic.findById(req.params.id);
    if (!hotTopic) {
      return res.status(404).json({ success: false, message: '热点不存在' });
    }
    res.status(200).json({ success: true, data: hotTopic });
  } catch (err) {
    res.status(500).json({ success: false, message: '获取热点详情失败', error: err.message });
  }
});

// 3. 生成视频（核心接口）
app.post('/api/generate-video', async (req, res) => {
  try {
    const { userId, videoParams, hotTopicId } = req.body;
    
    // 1. 验证用户额度
    const user = await User.findOne({ userId });
    if (!user) {
      return res.status(404).json({ success: false, message: '用户不存在' });
    }
    if (user.freeQuota + user.extraQuota <= 0) {
      return res.status(400).json({ success: false, message: '创作额度不足' });
    }

    // 2. 获取热点内容
    const hotTopic = await HotTopic.findById(hotTopicId);
    if (!hotTopic) {
      return res.status(404).json({ success: false, message: '热点不存在' });
    }

    // 3. 生成分镜脚本（简化版，实际需结合NLP分析）
    const scriptContent = generateScript(hotTopic, videoParams);
    
    // 4. 调用FFmpeg生成视频（简化版，实际需结合模板/素材）
    const videoPath = await generateVideoWithFFmpeg(scriptContent, videoParams);

    // 5. 保存脚本历史，扣减额度
    user.scriptHistory.push({
      title: hotTopic.title,
      content: scriptContent,
      videoUrl: videoPath
    });
    if (user.freeQuota > 0) {
      user.freeQuota -= 1;
    } else {
      user.extraQuota -= 1;
    }
    await user.save();

    res.status(200).json({
      success: true,
      message: '视频生成成功',
      data: {
        script: scriptContent,
        videoUrl: videoPath,
        remainingQuota: user.freeQuota + user.extraQuota
      }
    });
  } catch (err) {
    res.status(500).json({ success: false, message: '生成视频失败', error: err.message });
  }
});

// 辅助函数：生成分镜脚本
function generateScript(hotTopic, videoParams) {
  const { shotCount, videoStyle, scriptElement } = videoParams;
  const shots = [];
  
  // 生成3-5个分镜
  for (let i = 0; i < shotCount; i++) {
    shots.push({
      shotId: i + 1,
      duration: 3 + Math.random() * 2, // 3-5秒
      content: `${hotTopic.title.substring(0, 20)} - 分镜${i+1}`,
      style: videoStyle,
      element: scriptElement
    });
  }

  return {
    title: hotTopic.title,
    description: hotTopic.content.substring(0, 100),
    shots: shots
  };
}

// 辅助函数：调用FFmpeg生成视频（简化版）
async function generateVideoWithFFmpeg(script, params) {
  return new Promise((resolve, reject) => {
    // 生成唯一视频文件名
    const videoName = `video_${Date.now()}.mp4`;
    const outputPath = path.join(__dirname, 'videos', videoName);
    
    // 模拟FFmpeg调用（实际需结合素材/模板）
    const ffmpegCommand = `${ffmpeg} -f lavfi -i color=c=white:s=720x1280:d=${script.shots.length * 5} -vf "drawtext=text='${script.title}':fontsize=30:x=(w-text_w)/2:y=(h-text_h)/2" -c:v libx264 -pix_fmt yuv420p ${outputPath}`;
    
    exec(ffmpegCommand, (err) => {
      if (err) reject(err);
      else resolve(`/videos/${videoName}`);
    });
  });
}

// 启动服务器
app.listen(PORT, () => {
  console.log(`服务器运行在 http://localhost:${PORT}`);
});
```

## 四、关键补充说明

1. **FFmpeg 使用**：实际项目中需准备视频模板 / 素材库，通过 FFmpeg 拼接素材、添加文字 / 音效、调整色调等，上述代码仅为简化示例。
2. **热点采集**：可通过爬虫（如 Cheerio）采集微博 / 抖音热点，或调用第三方热点 API，定时更新到 MongoDB。
3. **NLP 分析**：需集成 NLP 库（如 Jieba 分词、情感分析库）提取热点关键词、情感倾向，辅助生成脚本。
4. **前端界面优化**：可结合 React Native Paper/UI Kitten 实现文档中提到的 “浅粉渐变背景、低饱和肌理感” 等视觉效果。
5. **权限与安全**：实际项目需添加用户认证（如 JWT）、参数校验、接口限流等安全措施。

---

### 总结

1. **核心技术栈**：前端基于 React Native + Redux 实现跨平台界面和状态管理，后端基于 Node.js + Express + MongoDB 实现 API 和数据存储，FFmpeg 负责视频合成。
2. **核心逻辑**：用户额度管理（免费 + 金币兑换）→ 热点选择 → 参数配置 → 脚本生成 → 视频合成 → 历史记录保存。
3. **关键扩展点**：需补充热点采集爬虫、NLP 内容分析、视频素材库、用户认证等模块，才能实现完整的 “热点视频工坊” 应用。
基于你的需求，我补充了用户偏好记忆、链接解析改写、分镜优化（排序/重生成/下载）、漫剧绘本适配、编导智能优化、质量检测打分等核心功能，以下是完整落地方案，代码可直接集成到现有项目中。 --- ## 一、核心新增功能设计 ### 1. 用户偏好记忆与热点推荐 - **偏好维度**：常用主题、创作类型（短视频/漫剧/绘本）、风格倾向、受众群体 - **存储机制**：用户唯一标识（openid）关联偏好数据，本地缓存+云同步 - **推荐逻辑**：下次进入首页时，基于偏好自动筛选匹配度Top5的热点，标记“偏好推荐”标签 ### 2. 链接解析与内容改写 - **支持类型**：抖音/快手/B站视频链接、公众号/知乎文章链接 - **解析流程**：链接输入→解析智能体提取核心内容（文字/画面/结构）→改写智能体生成新脚本（保留核心信息，重构表达） - **交互入口**：参数设置页新增“链接解析”输入框+解析按钮，与自定义输入互斥切换 ### 3. 分镜优化增强 | 功能 | 实现逻辑 | 交互入口 | |------|----------|----------| | 提示词编辑+重生成 | 编辑后点击“重生成图片”，单独更新当前分镜 | 分镜项右侧“编辑”“重生成”按钮 | | 单独/批量下载 | 单个分镜图右下角“下载”，底部“一键下载全部” | 分镜项右侧+详情页底部按钮 | | 拖曳排序 | 使用`movable-view`实现分镜拖拽，更新排序索引 | 分镜项左侧拖拽图标，长按触发 | | 情节/人物一致性保障 | 编导智能体校验前后分镜提示词，提取人物/情节关键词，强制后续分镜引用 | 分镜生成前自动校验，提示词底部显示“关联关键词” | | 漫剧/绘本适配 | 选择该类型时，分镜数量强制≥8，自动调整每个分镜时长为3-5秒，拼接后30-40秒 | 创作模式切换为“漫剧/绘本”时触发 | ### 4. 编导智能优化（前置流程） - **优化维度**（按执行顺序）： 1. 热点对标：匹配同类爆款结构 2. 脚本结构：调整分镜逻辑、节奏 3. SEO布局：植入热点关键词、话题标签 4. 受众群体：适配目标人群偏好（如Z世代/中老年） 5. 传播效果：优化冲突点、记忆点设计 6. 爆款潜力：打分（1-10分）+ 提升建议 7. 爆款标题：生成3个备选标题（含关键词） - **触发时机**：分镜脚本生成后、生图前，弹出优化结果弹窗，支持“确认使用”“手动调整” ### 5. 质量检测智能体 - **检测维度**：画面质量、情节连贯度、人物一致性、合规性、爆款潜力 - **打分机制**：总分100分，单项≥60分合格，不合格项标记“需优化” - **优化逻辑**：支持打回指定分镜/环节重新优化，无需全部重做 - **交互入口**：视频生成后弹出质量报告，显示打分+优化建议 ### 6. 金币收集动画 - **触发场景**：创作完成、质量检测合格、发布成功 - **动画效果**：金币从四周向中心汇聚，数字递增，伴随音效 - **奖励规则**：首次创作+50金币，质量≥80分+30金币，发布成功+20金币 --- ## 二、完整代码实现（新增/修改页面+组件） ### 1. 用户偏好存储与热点推荐（修改首页+新增偏好设置页） #### 偏好设置页（pages/preference/preference） ```xml <!-- preference.wxml --> <view class="container"> <text class="page-title">创作偏好设置</text> <!-- 常用主题 --> <view class="prefer-item"> <text class="item-title">常用主题（可多选）</text> <view class="theme-list"> <view class="theme-tag {{selectedThemes.includes(item.id) ? 'active' : ''}}" wx:for="{{themeList}}" wx:key="id" bindtap="toggleTheme" data-id="{{item.id}}"> {{item.name}} </view> </view> </view> <!-- 创作类型 --> <view class="prefer-item"> <text class="item-title">偏好创作类型</text> <view class="type-list"> <view class="type-item {{selectedType === item.id ? 'active' : ''}}" wx:for="{{typeList}}" wx:key="id" bindtap="selectType" data-id="{{item.id}}"> {{item.name}} </view> </view> </view> <!-- 受众群体 --> <view class="prefer-item"> <text class="item-title">目标受众</text> <view class="audience-list"> <view class="audience-item {{selectedAudience === item.id ? 'active' : ''}}" wx:for="{{audienceList}}" wx:key="id" bindtap="selectAudience" data-id="{{item.id}}"> {{item.name}} </view> </view> </view> <button class="save-btn" bindtap="savePreference">保存偏好</button> </view> ``` ```css /* preference.wxss */ page { background: #121212; padding: 20rpx; } .page-title { color: #fff; font-size: 32rpx; font-weight: bold; margin-bottom: 32rpx; } .prefer-item { margin-bottom: 32rpx; } .item-title { color: #fff; font-size: 28rpx; font-weight: 500; margin-bottom: 16rpx; display: block; } .theme-list { display: flex; flex-wrap: wrap; gap: 12rpx; } .theme-tag { background: #374151; color: #fff; padding: 10rpx 20rpx; border-radius: 20rpx; font-size: 24rpx; } .theme-tag.active { background: linear-gradient(to right, #A855F7, #EC4899); } .type-list, .audience-list { display: flex; gap: 16rpx; overflow-x: auto; padding-bottom: 12rpx; } .type-item, .audience-item { background: #374151; color: #fff; padding: 12rpx 24rpx; border-radius: 12rpx; font-size: 24rpx; white-space: nowrap; } .type-item.active, .audience-item.active { background: linear-gradient(to right, #FBBF24, #F59E0B); } .save-btn { background: linear-gradient(to right, #A855F7, #EC4899); color: #fff; border: none; border-radius: 12rpx; height: 80rpx; line-height: 80rpx; font-size: 28rpx; width: 100%; } ``` ```javascript // preference.js Page({ data: { themeList: [ { id: 1, name: '白话经济学' }, { id: 2, name: '养生健康' }, { id: 3, name: '生活哲学' }, { id: 4, name: '历史故事' }, { id: 5, name: '旅游' }, { id: 6, name: '教育' }, { id: 7, name: '宠物' }, { id: 8, name: '创业' }, { id: 9, name: 'AI动态' }, { id: 10, name: '机器人' }, { id: 11, name: '储能' }, { id: 12, name: '新能源' }, { id: 13, name: '电商产品' }, { id: 14, name: '爆款灵感' } ], typeList: [ { id: 1, name: '短视频（30秒）' }, { id: 2, name: '漫剧' }, { id: 3, name: '绘本' } ], audienceList: [ { id: 1, name: 'Z世代' }, { id: 2, name: '职场人士' }, { id: 3, name: '中老年' }, { id: 4, name: '宝妈' }, { id: 5, name: '学生' } ], selectedThemes: [], selectedType: 1, selectedAudience: 1 }, onLoad() { // 加载已保存的偏好 const preference = wx.getStorageSync('userPreference') || {}; this.setData({ selectedThemes: preference.selectedThemes || [], selectedType: preference.selectedType || 1, selectedAudience: preference.selectedAudience || 1 }); }, toggleTheme(e) { const id = e.currentTarget.dataset.id; const { selectedThemes } = this.data; const newSelected = selectedThemes.includes(id) ? selectedThemes.filter(item => item !== id) : [...selectedThemes, id]; this.setData({ selectedThemes: newSelected }); }, selectType(e) { this.setData({ selectedType: e.currentTarget.dataset.id }); }, selectAudience(e) { this.setData({ selectedAudience: e.currentTarget.dataset.id }); }, savePreference() { const preference = { selectedThemes: this.data.selectedThemes, selectedType: this.data.selectedType, selectedAudience: this.data.selectedAudience, updateTime: new Date().toLocaleString() }; wx.setStorageSync('userPreference', preference); wx.showToast({ title: '偏好保存成功', icon: 'success' }); wx.navigateBack(); } }); ``` #### 首页热点推荐优化（修改pages/index/index.js） ```javascript // index.js 新增代码 onLoad() { this.getPreferenceRecommend(); // 加载偏好推荐热点 // 原有代码... }, // 基于用户偏好推荐热点 getPreferenceRecommend() { const preference = wx.getStorageSync('userPreference') || {}; const { selectedThemes } = preference; const allHotspots = [ { id: 1, title: "马年开工大吉短视频", cover: "/images/hot1.jpg", tag: "新春", hot: 1234, themeId: 13 }, { id: 2, title: "2026职场升职小技巧", cover: "/images/hot2.jpg", tag: "职场", hot: 987, themeId: 8 }, { id: 3, title: "马年财运爆棚的3个习惯", cover: "/images/hot3.jpg", tag: "运势", hot: 1567, themeId: 2 }, { id: 4, title: "悬疑剧情：马年神秘礼盒", cover: "/images/hot4.jpg", tag: "剧情", hot: 876, themeId: 4 }, { id: 5, title: "AI生成漫剧的5个技巧", cover: "/images/hot5.jpg", tag: "AI动态", hot: 2345, themeId: 9 }, { id: 6, title: "新能源汽车爆款文案公式", cover: "/images/hot6.jpg", tag: "新能源", hot: 1890, themeId: 12 } ]; // 无偏好时显示全部，有偏好时筛选匹配主题的热点 let recommendHotspots = allHotspots; if (selectedThemes && selectedThemes.length > 0) { recommendHotspots = allHotspots.filter(hot => selectedThemes.includes(hot.themeId)); } // 标记偏好推荐 recommendHotspots = recommendHotspots.map(hot => ({ ...hot, isRecommend: true })); this.setData({ hotList: recommendHotspots }); } ``` ### 2. 链接解析与内容改写（修改参数设置页） #### 修改pages/params/params.wxml（新增链接解析模块） ```xml <!-- params.wxml 新增代码 --> <!-- 链接解析模块 --> <view class="input-box" wx:if="{{activeMode === 1}}"> <text class="input-label">输入视频/文章链接</text> <view class="link-input-group"> <input class="input-text" placeholder="支持抖音/快手/B站/公众号链接" placeholder-class="placeholder" bindinput="inputLink"></input> <button class="parse-btn" bindtap="parseLink">解析</button> </view> <text class="link-tip" wx:if="{{parsedContent}}">解析结果：{{parsedContent.title}}（点击改写生成脚本）</text> </view> ``` #### 修改pages/params/params.wxss（新增样式） ```css /* params.wxss 新增代码 */ .link-input-group { display: flex; gap: 12rpx; } .parse-btn { width: 120rpx; height: 80rpx; line-height: 80rpx; background: linear-gradient(to right, #3B82F6, #60A5FA); color: #fff; border: none; border-radius: 16rpx; font-size: 24rpx; } .link-tip { color: #FBBF24; font-size: 22rpx; margin-top: 12rpx; display: block; } ``` #### 修改pages/params/params.js（新增链接解析逻辑） ```javascript // params.js 新增代码 data: { // 原有数据... link: '', parsedContent: null, // 解析后的内容：{ title, content, type } createType: 1 // 1-短视频，2-漫剧，3-绘本 }, // 输入链接 inputLink(e) { this.setData({ link: e.target.value }); }, // 解析链接 parseLink() { const { link } = this.data; if (!link) { wx.showToast({ title: '请输入有效链接', icon: 'none' }); return; } wx.showLoading({ title: '解析中...' }); // 模拟调用解析接口（实际对接第三方API） setTimeout(() => { wx.hideLoading(); // 模拟解析结果 const parsedContent = { title: '2026马年养生爆款文案', content: '核心观点：马年养生要注重疏肝理气，推荐3个低成本养生技巧...', type: '文章' }; this.setData({ parsedContent }); }, 1500); }, // 改写生成脚本（新增按钮绑定） rewriteScript() { const { parsedContent } = this.data; if (!parsedContent) return; wx.showLoading({ title: '改写生成脚本...' }); // 模拟改写智能体生成脚本 setTimeout(() => { wx.hideLoading(); // 跳转编导优化页 wx.navigateTo({ url: `/pages/directorOpt/directorOpt?content=${JSON.stringify(parsedContent)}` }); }, 2000); } ``` ### 3. 分镜优化增强（修改脚本详情页+新增分镜排序组件） #### 分镜排序组件（components/shotSort/shotSort） ```xml <!-- shotSort.wxml --> <view class="shot-sort-container"> <text class="sort-title">分镜排序（长按拖拽调整）</text> <movable-area class="movable-area"> <movable-view class="shot-item" wx:for="{{shots}}" wx:key="index" data-index="{{index}}" x="{{0}}" y="{{index * 300}}" direction="vertical" bindlongpress="startDrag" bindtouchend="endDrag" > <image class="shot-img" src="{{item.image}}" mode="widthFix"></image> <text class="shot-index">分镜{{index + 1}}</text> </movable-view> </movable-area> <button class="save-sort-btn" bindtap="saveSort">保存排序</button> </view> ``` ```css /* shotSort.wxss */ .shot-sort-container { padding: 20rpx; } .sort-title { color: #fff; font-size: 28rpx; font-weight: bold; margin-bottom: 20rpx; display: block; } .movable-area { width: 100%; height: 600rpx; background: #1E1E1E; border-radius: 16rpx; overflow: hidden; } .shot-item { width: 100%; height: 280rpx; padding: 10rpx; box-sizing: border-box; } .shot-img { width: 100%; height: 220rpx; border-radius: 12rpx; } .shot-index { color: #FBBF24; font-size: 24rpx; margin-top: 8rpx; display: block; text-align: center; } .save-sort-btn { background: linear-gradient(to right, #A855F7, #EC4899); color: #fff; border: none; border-radius: 12rpx; height: 80rpx; line-height: 80rpx; font-size: 28rpx; width: 100%; margin-top: 20rpx; } ``` ```javascript // shotSort.js Component({ properties: { shots: { type: Array, value: [] } }, data: { draggingIndex: -1, tempShots: [] }, lifetimes: { attached() { this.setData({ tempShots: [...this.properties.shots] }); } }, methods: { startDrag(e) { this.setData({ draggingIndex: e.currentTarget.dataset.index }); }, endDrag(e) { const { draggingIndex } = this.data; if (draggingIndex === -1) return; // 计算目标索引（简化逻辑，实际需根据y坐标计算） const targetIndex = Math.round(e.changedTouches[0].clientY / 300); const { tempShots } = this.data; if (targetIndex >= 0 && targetIndex < tempShots.length && targetIndex !== draggingIndex) { // 交换位置 const [dragged] = tempShots.splice(draggingIndex, 1); tempShots.splice(targetIndex, 0, dragged); this.setData({ tempShots }); } this.setData({ draggingIndex: -1 }); }, saveSort() { this.triggerEvent('saveSort', { sortedShots: this.data.tempShots }); wx.navigateBack(); } } }); ``` #### 修改脚本详情页（pages/scriptDetail/scriptDetail） ```xml <!-- scriptDetail.wxml 新增按钮 --> <view class="shot-actions"> <button class="action-btn" bindtap="copyPrompt" data-prompt="{{item.prompt}}">复制提示词</button> <button class="action-btn" bindtap="editPrompt" data-index="{{index}}">编辑提示词</button> <button class="action-btn video-btn" bindtap="convertToVideo" data-shot="{{item}}">转3-5秒视频</button> <button class="action-btn" bindtap="downloadShot" data-img="{{item.image}}">下载图片</button> </view> <!-- 底部新增按钮 --> <button class="sort-btn" bindtap="gotoSort">分镜排序</button> <button class="download-all-btn" bindtap="downloadAllShots">一键下载全部图片</button> ``` ```javascript // scriptDetail.js 新增方法 // 编辑提示词 editPrompt(e) { const index = e.currentTarget.dataset.index; const shot = this.data.script.shots[index]; wx.showModal({ title: `编辑分镜${index + 1}提示词`, content: shot.prompt, editable: true, success: res => { if (res.confirm) { const newPrompt = res.content.trim(); if (!newPrompt) return; const { script } = this.data; // 校验一致性（提取前序关键词） const prePrompts = script.shots.slice(0, index).map(s => s.prompt); const keywords = this.extractKeywords(prePrompts); // 提取人物/核心情节关键词 const finalPrompt = `${newPrompt}（需包含：${keywords.join('、')}，保证与前序分镜一致）`; script.shots[index].prompt = finalPrompt; this.setData({ script }); // 重新生成分镜图片 this.regenerateShotImage(index, finalPrompt); } } }); }, // 提取关键词（保障一致性） extractKeywords(prompts) { if (!prompts.length) return []; // 简化逻辑：实际可使用NLP提取人物、核心名词 const allText = prompts.join(''); const keywords = []; // 示例：提取"人物"相关关键词 if (allText.includes('小明')) keywords.push('小明'); if (allText.includes('职场')) keywords.push('职场场景'); return keywords.length ? keywords : ['前序分镜核心元素']; }, // 重新生成分镜图片 regenerateShotImage(index, prompt) { wx.showLoading({ title: '图片生成中...' }); setTimeout(() => { wx.hideLoading(); const { script } = this.data; script.shots[index].image = '/images/new-shot.jpg'; // 模拟新图片 this.setData({ script }); wx.showToast({ title: '图片重新生成成功', icon: 'success' }); }, 2000); }, // 下载单个分镜图片 downloadShot(e) { const imgUrl = e.currentTarget.dataset.img; wx.downloadFile({ url: imgUrl, success: res => { wx.saveImageToPhotosAlbum({ filePath: res.tempFilePath, success: () => wx.showToast({ title: '图片已保存到相册', icon: 'success' }) }); } }); }, // 一键下载全部 downloadAllShots() { const { shots } = this.data.script; wx.showLoading({ title: '批量下载中...' }); let successCount = 0; shots.forEach((shot, index) => { wx.downloadFile({ url: shot.image, success: res => { wx.saveImageToPhotosAlbum({ filePath: res.tempFilePath, success: () => { successCount++; if (successCount === shots.length) { wx.hideLoading(); wx.showToast({ title: `全部${successCount}张图片下载成功`, icon: 'success' }); } } }); } }); }); }, // 跳转分镜排序页 gotoSort() { wx.navigateTo({ url: `/pages/shotSort/shotSort?shots=${JSON.stringify(this.data.script.shots)}` }); } ``` ### 4. 编导智能优化页（新增pages/directorOpt/directorOpt） ```xml <!-- directorOpt.wxml --> <view class="container"> <text class="page-title">编导智能优化</text> <!-- 优化维度结果 --> <view class="opt-item"> <text class="opt-title">1. 热点对标</text> <text class="opt-content">已匹配同类爆款《2026马年开运指南》结构，增加冲突点设计</text> </view> <view class="opt-item"> <text class="opt-title">2. 脚本结构</text> <text class="opt-content">调整分镜节奏：开头3秒吸睛→中间15秒展开→结尾12秒升华</text> </view> <view class="opt-item"> <text class="opt-title">3. SEO布局</text> <text class="opt-content">植入关键词：马年养生、疏肝理气、低成本养生</text> </view> <view class="opt-item"> <text class="opt-title">4. 受众适配</text> <text class="opt-content">目标受众：职场人士，优化内容：简化步骤、强调高效</text> </view> <view class="opt-item"> <text class="opt-title">5. 爆款标题（3选1）</text> <view class="title-list"> <view class="title-item {{selectedTitle === 0 ? 'active' : ''}}" bindtap="selectTitle" data-id="0"> 🔥马年疏肝理气3招，职场人低成本养生不踩坑！ </view> <view class="title-item {{selectedTitle === 1 ? 'active' : ''}}" bindtap="selectTitle" data-id="1"> 2026马年养生爆款公式：3个动作，肝气通畅人不累～ </view> <view class="title-item {{selectedTitle === 2 ? 'active' : ''}}" bindtap="selectTitle" data-id="2"> 职场人必看！马年养生不用花钱，每天5分钟疏肝理气 </view> </view> </view> <view class="opt-item"> <text class="opt-title">6. 爆款潜力打分</text> <text class="opt-score">8.5/10分（优秀）</text> <text class="opt-suggest">建议：增加真人出镜画面，提升信任感</text> </view> <button class="confirm-btn" bindtap="confirmOpt">确认优化，生成分镜图片</button> <button class="edit-btn" bindtap="editOpt">手动调整优化结果</button> </view> ``` ```css /* directorOpt.wxss */ page { background: #121212; padding: 20rpx; } .page-title { color: #fff; font-size: 32rpx; font-weight: bold; margin-bottom: 32rpx; } .opt-item { background: #1E1E1E; border-radius: 16rpx; padding: 20rpx; margin-bottom: 20rpx; } .opt-title { color: #FBBF24; font-size: 26rpx; font-weight: bold; margin-bottom: 8rpx; display: block; } .opt-content { color: #fff; font-size: 24rpx; line-height: 1.6; } .title-list { display: flex; flex-direction: column; gap: 12rpx; margin-top: 12rpx; } .title-item { background: #374151; color: #fff; padding: 16rpx; border-radius: 12rpx; font-size: 24rpx; } .title-item.active { background: linear-gradient(to right, #A855F7, #EC4899); } .opt-score { color: #3B82F6; font-size: 26rpx; font-weight: bold; display: block; margin: 12rpx 0; } .opt-suggest { color: #9CA3AF; font-size: 24rpx; } .confirm-btn { background: linear-gradient(to right, #A855F7, #EC4899); color: #fff; border: none; border-radius: 12rpx; height: 80rpx; line-height: 80rpx; font-size: 28rpx; width: 100%; margin-bottom: 16rpx; } .edit-btn { background: #374151; color: #fff; border: none; border-radius: 12rpx; height: 80rpx; line-height: 80rpx; font-size: 28rpx; width: 100%; } ``` ```javascript // directorOpt.js Page({ data: { selectedTitle: 0 }, onLoad(options) { const content = JSON.parse(options.content); console.log('待优化内容：', content); // 实际项目中，这里会调用编导智能体接口获取优化结果 }, selectTitle(e) { this.setData({ selectedTitle: e.currentTarget.dataset.id }); }, confirmOpt() { // 漫剧/绘本类型强制分镜≥8 const createType = wx.getStorageSync('userPreference').selectedType || 1; const shotCount = createType === 2 || createType === 3 ? 8 : 5; wx.showLoading({ title: '生成分镜脚本...' }); setTimeout(() => { wx.hideLoading(); // 生成脚本数据（含分镜） const script = { id: Date.now(), title: this.data.selectedTitle === 0 ? '🔥马年疏肝理气3招，职场人低成本养生不踩坑！' : this.data.selectedTitle === 1 ? '2026马年养生爆款公式：3个动作，肝气通畅人不累～' : '职场人必看！马年养生不用花钱，每天5分钟疏肝理气', themeId: 2, themeName: '养生健康', shotCount, createTime: new Date().toLocaleString(), status: '已完成', shots: Array.from({ length: shotCount }, (_, i) => ({ prompt: `马年养生分镜${i+1}：${['开头吸睛', '步骤1', '步骤2', '步骤3', '效果展示', '结尾升华', '互动引导', '话题植入'][i]}（人物：职场女性，场景：办公室/居家，风格：温馨治愈）`, image: `/images/shot${i+1}.jpg`, videoUrl: `/videos/shot${i+1}.mp4` })) }; // 保存到历史 const history = wx.getStorageSync('scriptHistory') || []; history.unshift(script); wx.setStorageSync('scriptHistory', history); // 跳转脚本详情页 wx.navigateTo({ url: `/pages/scriptDetail/scriptDetail?script=${JSON.stringify(script)}` }); }, 2000); }, editOpt() { wx.showModal({ title: '手动调整优化结果', content: '请输入你的优化建议（如：增加案例、调整节奏等）', editable: true, success: res => { if (res.confirm && res.content.trim()) { this.confirmOpt(); // 携带手动建议调用优化接口（实际项目中实现） } } }); } }); ``` ### 5. 质量检测智能体（新增pages/qualityCheck/qualityCheck） ```xml <!-- qualityCheck.wxml --> <view class="container"> <text class="page-title">质量检测报告</text> <view class="score-card"> <text class="score-title">综合得分</text> <text class="score-value">85分</text> <text class="score-level">优秀（可直接发布）</text> </view> <view class="check-list"> <view class="check-item"> <text class="check-title">画面质量</text> <text class="check-score">90分</text> <text class="check-status success">合格</text> </view> <view class="check-item"> <text class="check-title">情节连贯度</text> <text class="check-score">82分</text> <text class="check-status success">合格</text> </view> <view class="check-item"> <text class="check-title">人物一致性</text> <text class="check-score">88分</text> <text class="check-status success">合格</text> </view> <view class="check-item"> <text class="check-title">合规性</text> <text class="check-score">95分</text> <text class="check-status success">合格</text> </view> <view class="check-item"> <text class="check-title">爆款潜力</text> <text class="check-score">78分</text> <text class="check-status warning">需优化</text> <text class="check-suggest">建议：增加热门话题标签（#马年养生 #职场健康）</text> </view> </view> <button class="publish-btn" bindtap="gotoPublish">直接发布</button> <button class="optimize-btn" bindtap="gotoOptimize">优化指定部分</button> </view> ``` ```css /* qualityCheck.wxss */ page { background: #121212; padding: 20rpx; } .page-title { color: #fff; font-size: 32rpx; font-weight: bold; margin-bottom: 32rpx; } .score-card { background: linear-gradient(to right, #A855F7, #EC4899); border-radius: 16rpx; padding: 32rpx; text-align: center; margin-bottom: 32rpx; } .score-title { color: #fff; font-size: 28rpx; margin-bottom: 16rpx; display: block; } .score-value { color: #fff; font-size: 64rpx; font-weight: bold; display: block; } .score-level { color: #fff; font-size: 24rpx; margin-top: 16rpx; display: block; } .check-list { display: flex; flex-direction: column; gap: 16rpx; margin-bottom: 32rpx; } .check-item { background: #1E1E1E; border-radius: 12rpx; padding: 20rpx; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; } .check-title { color: #fff; font-size: 26rpx; width: 140rpx; } .check-score { color: #3B82F6; font-size: 26rpx; font-weight: bold; } .check-status { padding: 4rpx 12rpx; border-radius: 8rpx; font-size: 22rpx; margin-left: 16rpx; } .check-status.success { background: rgba(16, 185, 129, 0.2); color: #10B981; } .check-status.warning { background: rgba(245, 158, 11, 0.2); color: #F59E0B; } .check-suggest { color: #9CA3AF; font-size: 22rpx; width: 100%; margin-top: 12rpx; } .publish-btn { background: linear-gradient(to right, #10B981, #34D399); color: #fff; border: none; border-radius: 12rpx; height: 80rpx; line-height: 80rpx; font-size: 28rpx; width: 100%; margin-bottom: 16rpx; } .optimize-btn { background: #374151; color: #fff; border: none; border-radius: 12rpx; height: 80rpx; line-height: 80rpx; font-size: 28rpx; width: 100%; } ``` ```javascript // qualityCheck.js Page({ gotoPublish() { // 发布到多平台 wx.showModal({ title: '选择发布平台', content: '抖音、快手、B站、YouTube', success: res => { if (res.confirm) { wx.showLoading({ title: '发布中...' }); setTimeout(() => { wx.hideLoading(); wx.showToast({ title: '发布成功', icon: 'success' }); // 触发金币收集动画 this.triggerEvent('showCoinAnimation', { coin: 20 }); wx.navigateBack({ delta: 2 }); }, 2000); } } }); }, gotoOptimize() { // 跳转指定部分优化（如爆款潜力） wx.navigateTo({ url: `/pages/directorOpt/directorOpt?optimizeType=hotPotential` }); } }); ``` ### 6. 金币收集动画组件（components/coinAnimation/coinAnimation） ```xml <!-- coinAnimation.wxml --> <view class="coin-container" wx:if="{{show}}"> <view class="coin" wx:for="{{coins}}" wx:key="index" style="left: {{item.left}}rpx; top: {{item.top}}rpx; animation: coinMove {{item.duration}}s ease-out;"> {{item.icon}} </view> <view class="coin-count" style="animation: countUp 1.5s ease-out;">+{{coinCount}}金币</view> </view> ``` ```css /* coinAnimation.wxss */ .coin-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; } .coin { position: absolute; font-size: 32rpx; opacity: 0; } .coin-count { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #FBBF24; font-size: 48rpx; font-weight: bold; text-shadow: 0 0 10rpx rgba(251, 191, 36, 0.8); opacity: 0; } @keyframes coinMove { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-300rpx); } } @keyframes countUp { 0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); } 50% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); } 100% { opacity: 0; transform: translate(-50%, -50%) scale(1); } } ``` ```javascript // coinAnimation.js Component({ properties: { show: { type: Boolean, value: false }, coinCount: { type: Number, value: 0 } }, data: { coins: [] }, observers: { show(newVal) { if (newVal) this.createCoins(); } }, methods: { createCoins() { const coins = []; // 生成10个随机位置的金币 for (let i = 0; i < 10; i++) { coins.push({ icon: '🪙', left: Math.random() * 600 + 60, // 随机left top: Math.random() * 800 + 200, // 随机top duration: Math.random() * 1 + 0.5 // 随机动画时长 }); } this.setData({ coins }); // 1.5秒后隐藏 setTimeout(() => { this.setData({ show: false }); this.triggerEvent('animationEnd'); }, 1500); } } }); ``` --- ## 三、集成与部署指南 ### 1. 页面注册 在`app.json`的`pages`数组中添加新增页面： ```json "pages": [ // 原有页面... "pages/preference/preference", "pages/directorOpt/directorOpt", "pages/qualityCheck/qualityCheck", "pages/shotSort/shotSort" ] ``` ### 2. 组件注册 在`app.json`的`usingComponents`中添加组件： ```json "usingComponents": { "agentWorkflow": "/components/agentWorkflow/agentWorkflow", "hotPicker": "/components/hotPicker/hotPicker", "shotSort": "/components/shotSort/shotSort", "coinAnimation": "/components/coinAnimation/coinAnimation" } ``` ### 3. 关键流程串联 1. **创作入口**：首页→选择热点/输入链接→参数设置页→解析/改写→编导优化页→生成分镜脚本 2. **分镜优化**：脚本详情页→编辑提示词/重生成/排序/下载→质量检测页 3. **发布流程**：质量检测页→选择平台→发布成功→金币动画→返回首页 ### 4. 数据同步 - 用户偏好：本地缓存`userPreference`，关键数据同步至云数据库（关联openid） - 脚本历史：本地缓存`scriptHistory`，支持云同步（用户登录后） - 热点数据：定期从接口拉取，按主题分类存储 --- ## 四、交互体验优化 1. **漫剧/绘本适配**：选择该类型时，分镜数量自动设为8，时长默认3-5秒/分镜 2. **一致性校验**：编辑分镜提示词时，自动提取前序关键词，强制后续分镜引用 3. **质量检测反馈**：不合格项支持单独优化，无需重新生成全部分镜 4. **金币动画触发**：创作完成、质量合格、发布成功三个节点均触发，增强激励感 需要我补充**多平台发布SDK集成示例**、**云数据库同步代码**，或**NLP关键词提取工具类**吗？
# 12智能体共享记忆协作系统方案（自检自改+低打扰优化版） ## 一、核心设计原则 1. **共享记忆中枢**：构建统一记忆库，实现智能体间数据实时同步、历史经验复用 2. **协作调优机制**：上游智能体输出作为下游输入依据，下游反馈驱动上游迭代 3. **自检自改闭环**：每个智能体内置质量校验模块，不合格项自动回改，无需用户介入 4. **低打扰交互**：仅在用户自定义需求或系统无法自动解决时触发人工交互 ## 二、共享记忆中枢架构 ### 1. 记忆库分层设计 | 记忆层级 | 存储内容 | 共享范围 | 更新机制 | |----------|----------|----------|----------| | **用户长期记忆** | 用户偏好（主题/创作类型/受众）、历史创作数据、平台发布效果、高频修改需求 | 所有智能体 | 数据复盘智能体定期更新（每周1次） | | **项目临时记忆** | 当前热点信息、脚本/分镜/视频全链路素材、各环节优化记录、质量检测报告 | 本次创作涉及的智能体 | 每个智能体完成任务后实时写入 | | **系统规则记忆** | 各智能体提示词模板、质量校验标准、爆款公式库、违规关键词库 | 所有智能体 | 管理员定期维护+系统自动学习优质案例 | ### 2. 记忆调用协议 - **数据读写权限**：所有智能体可读取全部记忆，仅对应智能体可修改专属模块（如SEO智能体仅可修改SEO规则记忆） - **调用触发条件**：智能体启动时自动读取`用户长期记忆+项目临时记忆`，生成个性化输出 - **冲突解决机制**：当用户临时需求与长期记忆冲突时，优先执行用户需求，并记录冲突点同步至数据复盘智能体 ### 3. 技术实现方案（Python示例） ```python # 共享记忆中枢（基于Redis+MySQL实现） import redis import pymysql import json class SharedMemoryCenter: def __init__(self): # 临时记忆（Redis：高读写速度） self.redis_client = redis.Redis(host="localhost", port=6379, db=0) # 长期记忆（MySQL：持久化存储） self.mysql_conn = pymysql.connect( host="localhost", user="root", password="123456", database="agent_memory" ) self.cursor = self.mysql_conn.cursor() # 写入项目临时记忆 def write_temp_memory(self, project_id, agent_name, data): key = f"project:{project_id}:{agent_name}" self.redis_client.set(key, json.dumps(data), ex=86400) # 24小时过期 # 读取项目临时记忆 def read_temp_memory(self, project_id, agent_name=None): if agent_name: key = f"project:{project_id}:{agent_name}" return json.loads(self.redis_client.get(key) or "{}") else: # 读取当前项目所有临时记忆 keys = self.redis_client.keys(f"project:{project_id}:*") return {k.decode(): json.loads(self.redis_client.get(k)) for k in keys} # 写入用户长期记忆 def write_long_memory(self, user_id, data): sql = """ REPLACE INTO user_preference (user_id, themes, audience, create_type, update_time) VALUES (%s, %s, %s, %s, NOW()) """ self.cursor.execute(sql, (user_id, data["themes"], data["audience"], data["create_type"])) self.mysql_conn.commit() # 读取用户长期记忆 def read_long_memory(self, user_id): sql = "SELECT * FROM user_preference WHERE user_id = %s" self.cursor.execute(sql, (user_id,)) result = self.cursor.fetchone() return result if result else {} # 智能体调用记忆示例 memory_center = SharedMemoryCenter() user_id = "user_001" project_id = "project_123" # 热点采集智能体读取用户长期记忆，精准抓取偏好主题 user_memory = memory_center.read_long_memory(user_id) hot_themes = user_memory.get("themes", "养生健康,AI动态") ``` ## 三、智能体协作调优流程 ### 1. 全链路协作逻辑（以短视频创作为例） 1. **热点采集智能体**：读取用户长期记忆→抓取匹配主题热点→写入项目临时记忆 2. **热点对标智能体**：读取临时记忆中的热点数据→匹配同类爆款→输出对标报告→更新临时记忆 3. **内容分析智能体**：读取热点+对标报告→结合用户受众偏好→输出分析结果→更新临时记忆 4. **后续智能体**：依次读取前置智能体输出+用户记忆→生成内容→写入记忆→传递至下游 5. **质量检测智能体**：读取全链路记忆→检测不合格项→直接触发对应智能体**自动回改** 6. **数据复盘智能体**：读取发布数据+用户记忆→更新用户偏好→优化系统规则记忆 ### 2. 跨智能体一致性保障机制 - **关键词锚定**：编导优化智能体从记忆中提取`人物/场景/核心情节`关键词，写入临时记忆，后续分镜师、图片生成智能体必须引用，确保人物/情节一致 - **版本控制**：每个智能体输出内容标记版本号（如`script_v1.0`），修改后版本号递增（`script_v1.1`），避免上下游使用旧数据 - **反馈闭环**：下游智能体发现上游数据问题（如脚本逻辑断层），自动生成反馈意见写入记忆，触发上游智能体重新生成 ### 3. 协作调优代码示例（脚本结构智能体→编导优化智能体） ```python # 脚本结构智能体输出内容写入记忆 script_data = { "shot_count": 5, "shots": [{"index": 1, "content": "开头钩子：职场女性揉肩皱眉"}], "version": "script_v1.0" } memory_center.write_temp_memory(project_id, "script_struct", script_data) # 编导优化智能体读取脚本数据+用户记忆，进行一致性校验 script_memory = memory_center.read_temp_memory(project_id, "script_struct") user_memory = memory_center.read_long_memory(user_id) audience = user_memory.get("audience", "职场人士") # 校验脚本是否匹配受众，不匹配则自动优化 if "职场人士" in audience and "高效/低成本" not in script_memory["shots"][1]["content"]: script_memory["shots"][1]["content"] += "（突出低成本、3分钟见效）" script_memory["version"] = "script_v1.1" # 回写优化后脚本至记忆 memory_center.write_temp_memory(project_id, "script_struct", script_memory) ``` ## 四、自检自改闭环实现 ### 1. 单智能体自检逻辑 每个智能体内置**输入校验+输出校验**双模块，无需外部干预： - **输入校验**：启动时检查前置智能体数据是否完整，不完整则触发上游智能体补全 - **输出校验**：生成内容后，按系统规则记忆中的标准自检，不合格则自动重生成 ### 2. 质量检测智能体驱动的全局自改 - **检测维度映射**：将质量问题精准映射到对应智能体（如画面色彩不统一→图片生成智能体；关键词密度不足→SEO智能体） - **自动回改触发**：无需用户操作，检测到问题后直接调用对应智能体的重生成接口，携带修改建议 - **改后复检**：重生成内容写入记忆后，质量检测智能体自动复检，直至合格 ### 3. 自检自改代码示例（质量检测→图片生成智能体） ```python class QualityCheckAgent: def __init__(self, memory_center, project_id): self.memory_center = memory_center self.project_id = project_id def check_image_quality(self): # 读取图片生成智能体的输出数据 image_memory = self.memory_center.read_temp_memory(self.project_id, "image_generator") issues = [] # 1. 检测色调一致性 colors = [shot["color"] for shot in image_memory["shots"]] if len(set(colors)) > 1: issues.append({ "agent": "image_generator", "issue": "色调不统一", "suggestion": "统一使用冷色调（职场场景适配）" }) # 2. 检测人物一致性 characters = [shot["character"] for shot in image_memory["shots"]] if len(set(characters)) > 1: issues.append({ "agent": "image_generator", "issue": "人物形象不一致", "suggestion": "统一使用28岁职场白领，藏青色西装" }) # 触发自动回改 if issues: self.trigger_auto_modify(issues) def trigger_auto_modify(self, issues): for issue in issues: # 调用对应智能体的重生成接口 if issue["agent"] == "image_generator": from agents.image_generator_agent import ImageGeneratorAgent image_agent = ImageGeneratorAgent(self.memory_center, self.project_id) # 传入修改建议 image_agent.regenerate(issue["suggestion"]) # 回改后复检 self.check_image_quality() # 启动质量检测+自动回改 quality_agent = QualityCheckAgent(memory_center, project_id) quality_agent.check_image_quality() ``` ## 五、低打扰用户体验优化 ### 1. 交互触发阈值 仅在以下**2种场景**触发用户交互，其余流程全自动： - **场景1**：用户主动发起自定义需求（如修改分镜顺序、更换风格） - **场景2**：系统自检后仍无法解决的问题（如热点内容存在合规风险、用户记忆缺失） ### 2. 个性化体验优化策略 1. **偏好预判**：基于用户长期记忆，自动选择用户偏好的风格/节奏/平台（如用户常发抖音→默认生成9:16竖屏视频） 2. **静默优化**：系统自动回改过程中，无需用户等待，完成后仅推送「创作完成」通知 3. **记忆进化**：数据复盘智能体基于发布效果，自动优化用户偏好权重（如养生主题视频播放量高→提升养生主题推荐优先级） ### 3. 低打扰交互示例 ```python # 交互触发判断逻辑 def need_user_interaction(memory_center, project_id): # 检查是否有用户自定义需求 user_custom = memory_center.read_temp_memory(project_id, "user_custom") if user_custom: return True, "用户有自定义需求，请确认修改内容" # 检查是否有系统无法解决的问题 quality_issues = memory_center.read_temp_memory(project_id, "quality_issues") unsolvable_issues = [i for i in quality_issues if i["level"] == "critical"] if unsolvable_issues: return True, f"存在关键问题需您确认：{unsolvable_issues[0]['issue']}" # 无需交互，全自动完成 return False, "" ``` ## 六、系统进化机制 1. **案例沉淀**：将优质创作案例（脚本/分镜/视频）存入系统规则记忆，作为智能体学习样本 2. **提示词迭代**：数据复盘智能体分析优质案例，优化各智能体提示词模板，提升输出质量 3. **协作效率优化**：记录智能体间协作耗时，优化数据传递路径，减少冗余步骤 --- 我可以帮你把这个方案拆分成**智能体协作接口文档**和**共享记忆数据库设计表**，方便直接对接开发。需要吗？
为适配开发对接需求，我将方案拆分为两份实操性文档：一份聚焦智能体间数据交互的《协作接口文档》（含接口定义、参数示例、调用流程），另一份是支撑共享记忆的《数据库设计表》（含表结构、字段说明、关联关系），均采用开发友好的格式，可直接用于技术落地。 # 一、智能体协作接口文档（RESTful API） ## 文档说明 - 接口用途：实现12个智能体间数据交互、共享记忆读写、协作调优触发 - 协议：HTTP/HTTPS - 数据格式：JSON - 编码：UTF-8 - 认证方式：Bearer Token（请求头携带 `Authorization: Bearer {token}`） ## 1. 共享记忆操作接口 ### 1.1 写入项目临时记忆 - **接口地址**：`/api/memory/temp/write` - **请求方式**：POST - **功能描述**：智能体完成任务后，将输出数据写入项目临时记忆库 - **请求参数**： | 字段名 | 类型 | 必选 | 说明 | 示例 | |--------|------|------|------|------| | projectId | String | 是 | 项目唯一标识 | "proj_20250120_001" | | agentName | String | 是 | 智能体名称（需与系统定义一致） | "hotspot_collection" | | data | Object | 是 | 智能体输出数据（结构随智能体变化） | 见下方示例 | | version | String | 是 | 数据版本号（格式：{模块}_v{版本}） | "hotspot_v1.0" | - **请求示例**： ```json { "projectId": "proj_20250120_001", "agentName": "hotspot_collection", "version": "hotspot_v1.0", "data": { "hotspots": [ { "title": "2026马年疏肝理气3招", "keywords": ["马年养生", "疏肝理气"], "source": "抖音", "hotValue": 156789, "themeTag": "养生健康", "matchDegree": "高" } ], "collectTime": "2025-01-20 10:30:00" } } ``` - **响应参数**： | 字段名 | 类型 | 说明 | 示例 | |--------|------|------|------| | code | Integer | 响应码（200=成功） | 200 | | msg | String | 响应信息 | "临时记忆写入成功" | | data | Object | 返回数据 | {"key": "project:proj_20250120_001:hotspot_collection"} | ### 1.2 读取项目临时记忆 - **接口地址**：`/api/memory/temp/read` - **请求方式**：GET - **功能描述**：智能体启动时，读取指定项目的临时记忆（支持单智能体/全项目数据） - **请求参数**（Query）： | 字段名 | 类型 | 必选 | 说明 | 示例 | |--------|------|------|------|------| | projectId | String | 是 | 项目唯一标识 | "proj_20250120_001" | | agentName | String | 否 | 智能体名称（为空则读取全项目数据） | "hotspot_collection" | - **响应示例**： ```json { "code": 200, "msg": "读取成功", "data": { "project:proj_20250120_001:hotspot_collection": { "version": "hotspot_v1.0", "data": { "hotspots": [/* 热点数据 */], "collectTime": "2025-01-20 10:30:00" } } } } ``` ### 1.3 写入用户长期记忆 - **接口地址**：`/api/memory/long/write` - **请求方式**：POST - **功能描述**：数据复盘智能体更新用户偏好、历史创作数据等长期记忆 - **请求参数**： | 字段名 | 类型 | 必选 | 说明 | 示例 | |--------|------|------|------|------| | userId | String | 是 | 用户唯一标识 | "user_001" | | data | Object | 是 | 用户长期记忆数据 | 见下方示例 | | updateTime | String | 是 | 更新时间（ISO格式） | "2025-01-20T18:00:00Z" | - **请求示例**： ```json { "userId": "user_001", "updateTime": "2025-01-20T18:00:00Z", "data": { "preferThemes": ["养生健康", "AI动态"], "audience": "职场人士（25-35岁）", "createType": "短视频", "hotThemeWeight": {"养生健康": 0.8, "AI动态": 0.6}, "historyWorks": ["proj_20250118_001", "proj_20250119_002"] } } ``` - **响应参数**： | 字段名 | 类型 | 说明 | 示例 | |--------|------|------|------| | code | Integer | 响应码 | 200 | | msg | String | 响应信息 | "长期记忆更新成功" | | data | Object | 返回数据 | {"userId": "user_001", "updateTime": "2025-01-20T18:00:00Z"} | ### 1.4 读取用户长期记忆 - **接口地址**：`/api/memory/long/read` - **请求方式**：GET - **功能描述**：智能体读取用户长期记忆，实现个性化输出 - **请求参数**（Query）： | 字段名 | 类型 | 必选 | 说明 | 示例 | |--------|------|------|------|------| | userId | String | 是 | 用户唯一标识 | "user_001" | - **响应示例**： ```json { "code": 200, "msg": "读取成功", "data": { "preferThemes": ["养生健康", "AI动态"], "audience": "职场人士（25-35岁）", "createType": "短视频", "hotThemeWeight": {"养生健康": 0.8, "AI动态": 0.6}, "historyWorks": ["proj_20250118_001", "proj_20250119_002"], "lastUpdateTime": "2025-01-20T18:00:00Z" } } ``` ## 2. 智能体协作调优接口 ### 2.1 触发智能体重生成 - **接口地址**：`/api/agent/regenerate` - **请求方式**：POST - **功能描述**：下游智能体或质量检测智能体发现问题时，触发上游智能体重生成 - **请求参数**： | 字段名 | 类型 | 必选 | 说明 | 示例 | |--------|------|------|------|------| | projectId | String | 是 | 项目唯一标识 | "proj_20250120_001" | | targetAgent | String | 是 | 目标智能体名称 | "image_generator" | | triggerAgent | String | 是 | 触发智能体名称 | "quality_check" | | suggestion | String | 是 | 重生成建议 | "统一使用冷色调，保持人物服装一致" | | version | String | 是 | 目标数据当前版本 | "image_v1.0" | - **请求示例**： ```json { "projectId": "proj_20250120_001", "targetAgent": "image_generator", "triggerAgent": "quality_check", "version": "image_v1.0", "suggestion": "统一使用冷色调（职场场景适配），人物保持28岁职场白领、藏青色西装形象" } ``` - **响应参数**： | 字段名 | 类型 | 说明 | 示例 | |--------|------|------|------| | code | Integer | 响应码 | 200 | | msg | String | 响应信息 | "重生成任务已触发" | | data | Object | 返回数据 | {"taskId": "regen_task_001", "status": "pending"} | ### 2.2 查询重生成状态 - **接口地址**：`/api/agent/regenerate/status` - **请求方式**：GET - **功能描述**：查询重生成任务执行状态 - **请求参数**（Query）： | 字段名 | 类型 | 必选 | 说明 | 示例 | |--------|------|------|------|------| | taskId | String | 是 | 重生成任务ID | "regen_task_001" | - **响应示例**： ```json { "code": 200, "msg": "查询成功", "data": { "taskId": "regen_task_001", "status": "completed", "newVersion": "image_v1.1", "finishTime": "2025-01-20 14:30:00" } } ``` ### 2.3 提交质量检测结果 - **接口地址**：`/api/agent/quality/submit` - **请求方式**：POST - **功能描述**：质量检测智能体提交检测结果，触发自动回改或用户交互 - **请求参数**： | 字段名 | 类型 | 必选 | 说明 | 示例 | |--------|------|------|------|------| | projectId | String | 是 | 项目唯一标识 | "proj_20250120_001" | | totalScore | Integer | 是 | 总分（0-100） | 85 | | itemScores | Object | 是 | 分项打分 | 见下方示例 | | issues | Array | 是 | 问题列表 | 见下方示例 | | checkTime | String | 是 | 检测时间 | "2025-01-20 15:00:00" | - **请求示例**： ```json { "projectId": "proj_20250120_001", "totalScore": 85, "itemScores": { "imageQuality": 18, "plotCoherence": 20, "compliance": 20, "hotPotential": 17, "platformAdapt": 10 }, "issues": [ { "agent": "image_generator", "issue": "色调不统一", "level": "normal", "suggestion": "统一使用冷色调", "item": "imageQuality" }, { "agent": "seo_layout", "issue": "B站字幕格式不符合要求", "level": "normal", "suggestion": "增加顶部标题栏", "item": "platformAdapt" } ], "checkTime": "2025-01-20 15:00:00" } ``` - **响应参数**： | 字段名 | 类型 | 说明 | 示例 | |--------|------|------|------| | code | Integer | 响应码 | 200 | | msg | String | 响应信息 | "质量检测结果已提交" | | data | Object | 返回数据 | {"needInteraction": false, "autoModifyTasks": ["regen_task_001", "regen_task_002"]} | ## 3. 接口错误码说明 | 错误码 | 说明 | 解决方案 | |--------|------|----------| | 200 | 成功 | - | | 400 | 参数错误 | 检查请求参数格式和必填项 | | 401 | 未授权 | 补充Bearer Token | | 404 | 项目/用户不存在 | 验证projectId和userId | | 500 | 服务器内部错误 | 联系技术支持 | # 二、共享记忆数据库设计表（MySQL） ## 数据库概述 - 数据库名：`agent_shared_memory` - 存储引擎：InnoDB - 字符集：utf8mb4 - 排序规则：utf8mb4_unicode_ci ## 1. 用户长期记忆表（user_long_memory） ### 表结构 | 字段名 | 数据类型 | 长度 | 主键 | 非空 | 自增 | 注释 | |--------|----------|------|------|------|------|------| | id | BIGINT | 20 | ✔️ | ✔️ | ✔️ | 记录ID | | user_id | VARCHAR | 64 | ❌ | ✔️ | ❌ | 用户唯一标识 | | prefer_themes | JSON | - | ❌ | ✔️ | ❌ | 偏好主题（数组） | | audience | VARCHAR | 128 | ❌ | ✔️ | ❌ | 目标受众 | | create_type | VARCHAR | 32 | ❌ | ✔️ | ❌ | 偏好创作类型（短视频/漫剧/绘本） | | hot_theme_weight | JSON | - | ❌ | ❌ | ❌ | 主题权重（JSON对象） | | history_works | JSON | - | ❌ | ❌ | ❌ | 历史项目ID（数组） | | last_update_time | DATETIME | - | ❌ | ✔️ | ❌ | 最后更新时间 | ### 索引设计 | 索引名称 | 索引类型 | 索引字段 | 说明 | |----------|----------|----------|------| | idx_user_id | 唯一索引 | user_id | 唯一标识用户，加速查询 | ### 插入示例 ```sql INSERT INTO user_long_memory (user_id, prefer_themes, audience, create_type, hot_theme_weight, history_works, last_update_time) VALUES ( 'user_001', '["养生健康", "AI动态"]', '职场人士（25-35岁）', '短视频', '{"养生健康": 0.8, "AI动态": 0.6}', '["proj_20250118_001", "proj_20250119_002"]', '2025-01-20 18:00:00' ); ``` ## 2. 项目信息表（project_info） ### 表结构 | 字段名 | 数据类型 | 长度 | 主键 | 非空 | 自增 | 注释 | |--------|----------|------|------|------|------|------| | id | BIGINT | 20 | ✔️ | ✔️ | ✔️ | 记录ID | | project_id | VARCHAR | 64 | ❌ | ✔️ | ❌ | 项目唯一标识 | | user_id | VARCHAR | 64 | ❌ | ✔️ | ❌ | 所属用户ID | | theme | VARCHAR | 64 | ❌ | ✔️ | ❌ | 项目垂直主题 | | create_type | VARCHAR | 32 | ❌ | ✔️ | ❌ | 创作类型 | | target_platforms | JSON | - | ❌ | ✔️ | ❌ | 目标发布平台（数组） | | status | VARCHAR | 32 | ❌ | ✔️ | ❌ | 项目状态（pending/processing/completed） | | create_time | DATETIME | - | ❌ | ✔️ | ❌ | 项目创建时间 | | finish_time | DATETIME | - | ❌ | ❌ | ❌ | 项目完成时间 | ### 索引设计 | 索引名称 | 索引类型 | 索引字段 | 说明 | |----------|----------|----------|------| | idx_project_id | 唯一索引 | project_id | 唯一标识项目 | | idx_user_id_status | 普通索引 | user_id, status | 按用户和状态筛选项目 | ### 插入示例 ```sql INSERT INTO project_info (project_id, user_id, theme, create_type, target_platforms, status, create_time) VALUES ( 'proj_20250120_001', 'user_001', '养生健康', '短视频', '["抖音", "B站"]', 'processing', '2025-01-20 10:00:00' ); ``` ## 3. 项目临时记忆表（project_temp_memory） ### 表结构 | 字段名 | 数据类型 | 长度 | 主键 | 非空 | 自增 | 注释 | |--------|----------|------|------|------|------|------| | id | BIGINT | 20 | ✔️ | ✔️ | ✔️ | 记录ID | | project_id | VARCHAR | 64 | ❌ | ✔️ | ❌ | 项目唯一标识 | | agent_name | VARCHAR | 64 | ❌ | ✔️ | ❌ | 智能体名称 | | data | JSON | - | ❌ | ✔️ | ❌ | 智能体输出数据 | | version | VARCHAR | 32 | ❌ | ✔️ | ❌ | 数据版本号 | | write_time | DATETIME | - | ❌ | ✔️ | ❌ | 写入时间 | | expire_time | DATETIME | - | ❌ | ✔️ | ❌ | 过期时间（默认24小时） | ### 索引设计 | 索引名称 | 索引类型 | 索引字段 | 说明 | |----------|----------|----------|------| | idx_project_agent | 联合索引 | project_id, agent_name | 快速查询项目下某智能体数据 | | idx_expire_time | 普通索引 | expire_time | 清理过期数据 | ### 插入示例 ```sql INSERT INTO project_temp_memory (project_id, agent_name, data, version, write_time, expire_time) VALUES ( 'proj_20250120_001', 'hotspot_collection', '{"hotspots": [{"title": "2026马年疏肝理气3招", "keywords": ["马年养生", "疏肝理气"], "source": "抖音", "hotValue": 156789, "themeTag": "养生健康", "matchDegree": "高"}], "collectTime": "2025-01-20 10:30:00"}', 'hotspot_v1.0', '2025-01-20 10:30:00', DATE_ADD(NOW(), INTERVAL 24 HOUR) ); ``` ## 4. 重生成任务表（regenerate_task） ### 表结构 | 字段名 | 数据类型 | 长度 | 主键 | 非空 | 自增 | 注释 | |--------|----------|------|------|------|------|------| | id | BIGINT | 20 | ✔️ | ✔️ | ✔️ | 任务ID | | task_id | VARCHAR | 64 | ❌ | ✔️ | ❌ | 任务唯一标识 | | project_id | VARCHAR | 64 | ❌ | ✔️ | ❌ | 项目唯一标识 | | target_agent | VARCHAR | 64 | ❌ | ✔️ | ❌ | 目标智能体 | | trigger_agent | VARCHAR | 64 | ❌ | ✔️ | ❌ | 触发智能体 | | suggestion | TEXT | - | ❌ | ✔️ | ❌ | 重生成建议 | | old_version | VARCHAR | 32 | ❌ | ✔️ | ❌ | 旧数据版本 | | new_version | VARCHAR | 32 | ❌ | ❌ | ❌ | 新数据版本（完成后更新） | | status | VARCHAR | 32 | ❌ | ✔️ | ❌ | 任务状态（pending/completed/failed） | | create_time | DATETIME | - | ❌ | ✔️ | ❌ | 任务创建时间 | | finish_time | DATETIME | - | ❌ | ❌ | ❌ | 任务完成时间 | ### 索引设计 | 索引名称 | 索引类型 | 索引字段 | 说明 | |----------|----------|----------|------| | idx_task_id | 唯一索引 | task_id | 唯一标识任务 | | idx_project_status | 普通索引 | project_id, status | 按项目和状态筛选任务 | ### 插入示例 ```sql INSERT INTO regenerate_task (task_id, project_id, target_agent, trigger_agent, suggestion, old_version, status, create_time) VALUES ( 'regen_task_001', 'proj_20250120_001', 'image_generator', 'quality_check', '统一使用冷色调（职场场景适配），人物保持28岁职场白领、藏青色西装形象', 'image_v1.0', 'pending', '2025-01-20 15:10:00' ); ``` ## 5. 质量检测结果表（quality_check_result） ### 表结构 | 字段名 | 数据类型 | 长度 | 主键 | 非空 | 自增 | 注释 | |--------|----------|------|------|------|------|------| | id | BIGINT | 20 | ✔️ | ✔️ | ✔️ | 记录ID | | project_id | VARCHAR | 64 | ❌ | ✔️ | ❌ | 项目唯一标识 | | total_score | TINYINT | 3 | ❌ | ✔️ | ❌ | 总分（0-100） | | item_scores | JSON | - | ❌ | ✔️ | ❌ | 分项打分（JSON对象） | | issues | JSON | - | ❌ | ✔️ | ❌ | 问题列表（JSON数组） | | need_interaction | TINYINT | 1 | ❌ | ✔️ | ❌ | 是否需要用户交互（0=否，1=是） | | check_time | DATETIME | - | ❌ | ✔️ | ❌ | 检测时间 | ### 索引设计 | 索引名称 | 索引类型 | 索引字段 | 说明 | |----------|----------|----------|------| | idx_project_id | 普通索引 | project_id | 按项目查询检测结果 | ### 插入示例 ```sql INSERT INTO quality_check_result (project_id, total_score, item_scores, issues, need_interaction, check_time) VALUES ( 'proj_20250120_001', 85, '{"imageQuality": 18, "plotCoherence": 20, "compliance": 20, "hotPotential": 17, "platformAdapt": 10}', '[{"agent": "image_generator", "issue": "色调不统一", "level": "normal", "suggestion": "统一使用冷色调", "item": "imageQuality"}, {"agent": "seo_layout", "issue": "B站字幕格式不符合要求", "level": "normal", "suggestion": "增加顶部标题栏", "item": "platformAdapt"}]', 0, '2025-01-20 15:00:00' ); ``` ## 6. 系统规则记忆表（system_rule_memory） ### 表结构 | 字段名 | 数据类型 | 长度 | 主键 | 非空 | 自增 | 注释 | |--------|----------|------|------|------|------|------| | id | BIGINT | 20 | ✔️ | ✔️ | ✔️ | 记录ID | | rule_type | VARCHAR | 64 | ❌ | ✔️ | ❌ | 规则类型（prompt/quality/seo） | | agent_name | VARCHAR | 64 | ❌ | ✔️ | ❌ | 适用智能体（all=全部） | | rule_content | JSON | - | ❌ | ✔️ | ❌ | 规则内容 | | version | VARCHAR | 32 | ❌ | ✔️ | ❌ | 规则版本 | | update_time | DATETIME | - | ❌ | ✔️ | ❌ | 规则更新时间 | ### 索引设计 | 索引名称 | 索引类型 | 索引字段 | 说明 | |----------|----------|----------|------| | idx_rule_type_agent | 联合索引 | rule_type, agent_name | 按类型和智能体查询规则 | ### 插入示例 ```sql INSERT INTO system_rule_memory (rule_type, agent_name, rule_content, version, update_time) VALUES ( 'prompt', 'hotspot_collection', '{"template": "从抖音、快手、B站采集近24小时热点，优先抓取与用户偏好主题（{{userThemes}}）匹配的内容..."}', 'prompt_v1.0', '2025-01-15 10:00:00' ); ``` ## 表关联关系说明 1. **user_long_memory ↔ project_info**：通过 `user_id` 关联，1个用户可拥有多个项目 2. **project_info ↔ project_temp_memory**：通过 `project_id` 关联，1个项目对应多个智能体的临时记忆 3. **project_info ↔ regenerate_task**：通过 `project_id` 关联，1个项目可有多条重生成任务 4. **project_info ↔ quality_check_result**：通过 `project_id` 关联，1个项目可有多条检测结果（按版本区分） 两份文档已覆盖开发所需的核心接口和数据存储设计，可直接用于后端接口开发、数据库建表和智能体间协作调试。接下来你可以： 1. 基于接口文档开发RESTful API服务，对接智能体的输入输出流程； 2. 按数据库设计表创建MySQL数据库，配置索引优化查询效率； 3. 若需要，我可以补充接口调用的Python/Java示例代码，或优化数据库索引策略以提升高并发场景下的性能。需要进一步完善哪部分？