C:\D\compet\gaode\GDzhixing 加了高德功能的鸿蒙应用，现在启动有很多错误需要修改。之前有一个可以预览的版本。C:\D\compet\gaode\GDzhixing - 副本,还有一个官方示例C:\D\compet\gaode\zhixing 一些，你还需要到https://lbs.amap.com/api/harmonyosnext-navi-sdk/guide/navigation-map/gps-navi 爬取更多开发知识，保存到开发相关的知识库进行参考C:\D\compet\gaode\docs

> ❝[[开发鸿蒙应用调用高德地图HarmonyOS版本SDK]]
> 
[[ArkTS高性能编程实践]]
> 
> 我们都知道鸿蒙原生应用已经启动开发，目前地图等SDK可能还不是很完善。那我们有没有办法在这些条件都不是很完善的前提下，去使用相关相关服务呢？

经过坚果派内部的测试，最后发现，其实这个问题还是有解决的办法的。不信，你继续往后读。

## 一、创建项目

![图片](https://mmbiz.qpic.cn/mmbiz_png/5qkQdsicTu1nibN5voBvCAXGaNicBd4czia1hwvY8vouK2kSDbrwI9gdCxgpZk4bvGUZlM8richPVVWJ051o8pblovg/640?wx_fmt=png&from=appmsg&tp=webp&wxfrom=5&wx_lazy=1#imgIndex=0)

image-20240102142924183

![图片](https://mmbiz.qpic.cn/mmbiz_png/5qkQdsicTu1nibN5voBvCAXGaNicBd4czia1pQbmUJmzLYzcWNQQjfCoM7I8wKwePAAHgVXAs7puw9EZH4ecS18fLw/640?wx_fmt=png&from=appmsg&tp=webp&wxfrom=5&wx_lazy=1#imgIndex=1)

i

## 二、Want学习

### Want的定义与用途

Want是一种对象，用于在应用组件之间传递信息。

其中，一种常见的使用场景是作为`startAbility()`方法的参数。例如，当UIAbilityA需要启动UIAbilityB并向UIAbilityB传递一些数据时，可以使用Want作为一个载体，将数据传递给UIAbilityB。

Want用法示意![图片](https://mmbiz.qpic.cn/mmbiz_png/5qkQdsicTu1nibN5voBvCAXGaNicBd4czia1owoT44kQrfre4zXkPnbK8MHNSBdejvciaUtUqFet3AyAJgerqosvGLA/640?wx_fmt=png&from=appmsg&tp=webp&wxfrom=5&wx_lazy=1#imgIndex=2)

### Want的类型

- **显式Want**：在启动目标应用组件时，调用方传入的want参数中指定了abilityName和bundleName，称为显式Want。
    
    显式Want通常用于在当前应用中启动已知的目标应用组件，通过提供目标应用组件所在应用的Bundle名称信息（bundleName）并在Want对象内指定abilityName来启动目标应用组件。当有明确处理请求的对象时，显式Want是一种简单有效的启动目标应用组件的方式。
    
    `import Want from '@ohos.app.ability.Want';      let wantInfo: Want = {     deviceId: '', // deviceId为空表示本设备     bundleName: 'com.nut.17752170152',     abilityName: 'FuncAbility',   }   `
    
- **隐式Want**：在启动目标应用组件时，调用方传入的want参数中未指定abilityName，称为隐式Want。
    
    当需要处理的对象不明确时，可以使用隐式Want，在当前应用中使用其他应用提供的某个能力，而不关心提供该能力的具体应用。隐式Want使用skills标签来定义需要使用的能力，并由系统匹配声明支持该请求的所有应用来处理请求。例如，需要打开一个链接的请求，系统将匹配所有声明支持该请求的应用，然后让用户选择使用哪个应用打开链接。
    
    `import Want from '@ohos.app.ability.Want';      let wantInfo: Want = {     // uncomment line below if wish to implicitly query only in the specific bundle.     // bundleName: 'com.example.myapplication',     action: 'ohos.want.action.search',     // entities can be omitted     entities: [ 'entity.system.browsable' ],     uri: 'https://www.test.com:8080/query/student',     type: 'text/plain',   };   `
    

## 三、导航

### 用法

`cat=android.intent.category.DEFAULT   dat=androidamap://navi?sourceApplication=appname&poiname=fangheng&lat=36.547901&lon=104.258354&dev=1&style=2   pkg=com.autonavi.minimap   `

### 参数说明

|参数|说明|是否必填|
|---|---|---|
|navi|服务类型|是|
|sourceApplication|第三方调用应用名称。如 amap|是|
|poiname|POI 名称|否|
|lat|纬度|是|
|lon|经度|是|
|dev|是否偏移(0:lat 和 lon 是已经加密后的,不需要国测加密; 1:需要国测加密)|是|
|style|导航方式（0 速度快；1 费用少；2路程短；3 不走高速；4 躲避拥堵；5 不走高速且避免收费；6 不走高速且躲避拥堵；7；躲避收费和拥堵；8 不走高速躲避收费和拥堵）**由于与用户本地设置冲突，Android平台自8.2.6版本起不支持该参数，偏好设置将以用户本地设置为准**|是|

### 关键代码

  `let context = getContext(this) as common.UIAbilityContext       context.startAbility({         uri: "androidamap://navi?sourceApplication=appname&lat=" + this.latitude + "&lon=" + this.longitude + "&dev=1",         action: "android.intent.action.VIEW"       })`

### 效果图

![图片](https://mmbiz.qpic.cn/mmbiz_png/5qkQdsicTu1nibN5voBvCAXGaNicBd4czia14GLdAdicBt9aWLM9dna5uI96iclUVjic2NqoncH8Pc93FOSXbD6EsPt4Q/640?wx_fmt=png&from=appmsg&tp=webp&wxfrom=5&wx_lazy=1#imgIndex=3)

i

## 四、路径规划

### 用法

`act=android.intent.action.VIEW   cat=android.intent.category.DEFAULT   dat=amapuri://route/plan/?sid=&slat=39.92848272&slon=116.39560823&sname=A&did=&dlat=39.98848272&dlon=116.47560823&dname=B&dev=0&t=0   pkg=com.autonavi.minimap   `

### 参数说明：

|参数|说明|是否必填|
|---|---|---|
|route|服务类型|是|
|sourceApplication|第三方调用应用名称。如 amap|是|
|sid|起点的POI ID（例如天安门为B000A60DA1）|否|
|slat|起点纬度。如果不填写此参数则自动将用户当前位置设为起点纬度。|否|
|slon|起点经度。如果不填写此参数则自动将用户当前位置设为起点经度。|否|
|sname|起点名称|否|
|did|终点的POI ID （例如天安门为B000A60DA1）|否|
|dlat|终点纬度|是|
|dlon|终点经度|是|
|dname|终点名称|否|
|dev|起终点是否偏移(0:lat 和 lon 是已经加密后的,不需要国测加密; 1:需要国测加密)|是|
|m|驾车方式 =0（速度快）=1（费用少） =2（路程短）=3 不走高速 =4（躲避拥堵）=5（不走高速且避免收费） =6（不走高速且躲避拥堵） =7（躲避收费和拥堵） =8（不走高速躲避收费和拥堵）。公交 =0（速度快）=1（费用少） =2（换乘较少）=3（步行少）=4（舒适）=5（不乘地铁）**由于与用户本地设置冲突，Android平台7.5.9版本起不支持该参数，偏好设置将以用户本地设置为准**|是|
|t|t = 0（驾车）= 1（公交）= 2（步行）= 3（骑行）= 4（火车）= 5（长途客车） （骑行仅在V7.8.8以上版本支持）|是|
|rideType|仅当 t = 3 时该参数生效。rideType = elebike   电动车，rideType = bike/为空 自行车（电动车规划仅在V8.65.0及以上版本支持）||

输入起点和终点，搜索公交、驾车或步行的线路。**支持版本 V4.2.1 起**。

### 关键代码

    `let context = getContext(this) as common.UIAbilityContext       context.startAbility({         uri: "amapuri://route/plan/?did=&dlat=36.07&dlon=103.82&dname=坚果派17752170152&dev=0&t=0",                  action: "android.intent.action.VIEW"       })`

### 效果

![图片](https://mmbiz.qpic.cn/mmbiz_png/5qkQdsicTu1nibN5voBvCAXGaNicBd4czia1iaI0XLENMNBibZPLLQlPDt965oDkOQJSYicibdNpgNPv0iarmiaruykiahwyg/640?wx_fmt=png&from=appmsg&tp=webp&wxfrom=5&wx_lazy=1#imgIndex=4)

image-202

## 五、Web组件实现地图图显示

`import web_webview from '@ohos.web.webview';      @Entry   @Component   struct MainPage {     controller: web_webview.WebviewController = new web_webview.WebviewController()        build() {       Row() {         Column() {              Web({ src: $rawfile("drive.html"), controller: this.controller })         }         .width('100%')       }       .height('100%')     }   }   `

### 效果图

![图片](https://mmbiz.qpic.cn/mmbiz_png/5qkQdsicTu1nibN5voBvCAXGaNicBd4czia1aibh7vpycfqel3tlGFSIrOWqhVeMYV2HTsKc6U5iaGYz4eDyOEich5PmQ/640?wx_fmt=png&from=appmsg&tp=webp&wxfrom=5&wx_lazy=1#imgIndex=5)

im

# 鸿蒙应用开发-HarmonyOS实现定位功能如此简单

点击上方"名片"，**关注公众号，我们一起学习**

---

听取大家的意见，把往期的文章进行了分类整理，如有需要可直接链接到对应系列文章：

HarmonyOS生态：**[HarmonyOS生态](https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3ODU3MzY0NA==&action=getalbum&album_id=3390586828671680523#wechat_redirect)**

HarmonyOS应用开发-基础：[**HarmonyOS-基础相关**](https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3ODU3MzY0NA==&action=getalbum&album_id=3358701016967249923#wechat_redirect)

HarmonyOS应用开发-媒体：[**HarmonyOS媒体**](https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3ODU3MzY0NA==&action=getalbum&album_id=3358703406143471622#wechat_redirect)

HarmonyOS应用开发-文件管理：[**HarmonyOS文件管理**](https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3ODU3MzY0NA==&action=getalbum&album_id=3358705403789803522#wechat_redirect)  

HarmonyOS应用开发-安全：[**HarmonyOS-安全**](https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3ODU3MzY0NA==&action=getalbum&album_id=3358687951827730436#wechat_redirect)

HarmonyOS应用开发-AI能力：[**HarmonyOS-AI**](https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3ODU3MzY0NA==&action=getalbum&album_id=3358693814877519877#wechat_redirect)

HarmonyOS应用开发-进阶：[**HarmonyOS-进阶**](https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3ODU3MzY0NA==&action=getalbum&album_id=3390587243521900557#wechat_redirect)

[HarmonyOS-问题记录](https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3ODU3MzY0NA==&action=getalbum&album_id=3358701973251784712#wechat_redirect)：[**HarmonyOS-问题记录**](https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg3ODU3MzY0NA==&action=getalbum&album_id=3358701973251784712#wechat_redirect)

# 获取当前位置信息

## 申请权限

系统提供的定位权限有：

- ohos.permission.LOCATION：用于获取精准位置，精准度在米级别。
    
- ohos.permission.APPROXIMATELY_LOCATION：用于获取模糊位置，精确度为5公里。
    
- ohos.permission.LOCATION_IN_BACKGROUND：用于应用切换到后台仍然需要获取定位信息的场景。
    

本测试代码中使用到了ohos.permission.LOCATION和ohos.permission.APPROXIMATELY_LOCATION权限，根据权限申请说明对定位权限进行申请。

## 导入依赖

导入geoLocationManager模块，所有与基础定位能力相关的功能API，都是通过该模块提供的：

```
import { geoLocationManager } from '@kit.LocationKit';
```

## 获取当前位置

获取当前位置，具体请查看官网API：

```
geoLocationManager.getCurrentLocation()
```

## 坐标转换为地理描述

调用逆地理编码服务，将坐标转换为地理描述，具体请查看官网API：

```
geoLocationManager.getAddressesFromLocation()
```

![图片](https://mmbiz.qpic.cn/sz_mmbiz_png/c0m0u5vbs6q9O7DXWdwLG5Qke7QUOm8fRTmyIic9dmHnSXm37iaFmOLHpIKibRSX0j0g6qSNq6FBCno4ibNKr79xOg/640?wx_fmt=png&from=appmsg&tp=webp&wxfrom=5&wx_lazy=1#imgIndex=0)

## 代码示例

```
import { abilityAccessCtrl, common, Permissions, Want } from '@kit.AbilityKit';import { hilog } from '@kit.PerformanceAnalysisKit';import { BusinessError } from '@kit.BasicServicesKit';import { geoLocationManager } from '@kit.LocationKit';import Logger from '../utils/Logger';const TAG = '[locationChange]'@Entry@Componentstruct LocationPage {  @State message: string = 'Hello World';  permissions: Array<Permissions> = [    'ohos.permission.LOCATION',    'ohos.permission.APPROXIMATELY_LOCATION'  ];  onPageShow(): void {    this.reqPermissionsFromUser(this.permissions);  }  // 打开应用的详情页面  openPermissionsInSystemSettings(): void {    let context = getContext(this) as common.UIAbilityContext;    let wantInfo: Want = {      bundleName: 'com.huawei.hmos.settings',      abilityName: 'com.huawei.hmos.settings.MainAbility', // com.huawei.hmos.settings.AppInfoAbility      uri: 'application_info_entry', //application_settings   application_info_entry      parameters: {        pushParams: context.abilityInfo.bundleName // 应用包名com.example.myapplication  'uiAbilityContext.abilityInfo.bundleName'      }    }    context.startAbility(wantInfo);  }  // 申请授权  reqPermissionsFromUser(permissions: Array<Permissions>): void {    const atManager = abilityAccessCtrl.createAtManager();    let context = getContext(this) as common.UIAbilityContext;    atManager.requestPermissionsFromUser(context, permissions).then((data) => {      let grantStatus: Array<number> = data.authResults;      let length: number = grantStatus.length;      for (let i = 0; i < length; i++) {        if (grantStatus[i] === 0) {          // 用户授权，可以继续访问目标操作          hilog.info(0x0000, 'testTag', '%{public}s', '已经授权，可以继续访问目标操作');        } else {          hilog.info(0x0000, 'testTag', '%{public}s', '拒绝授权');          // 用户拒绝授权，提示用户必须授权才能访问当前页面的功能，并引导用户到系统设置中打开相应的权限          this.openPermissionsInSystemSettings();          return;        }      }    }).catch((err: BusinessError) => {      console.error(`requestPermissionsFromUser failed, code is ${err.code}, message is ${err.message}`);    })  }  getLocation() {    // 获取当前位置    geoLocationManager.getCurrentLocation((err, location) => {      if (err) {        hilog.error(0x00000, 'locationChanger: err=', JSON.stringify(err));      }      if (location) {        let reverseGeocodeRequest: geoLocationManager.ReverseGeoCodeRequest = {          // 表示纬度信息，正值表示北纬，负值表示南纬。          'latitude': location.latitude,          // 表示经度信息，正值表示东经，负值表示西经。          'longitude': location.longitude,          // 指定返回位置信息的最大个数。          'maxItems': 1        };        // 调用逆地理编码服务，将坐标转换为地理描述        geoLocationManager.getAddressesFromLocation(reverseGeocodeRequest, (err, data) => {          if (data) {            // [{"latitude":xxx.913915786588525,"longitude":xxx.28978269123463,"locale":"zh","placeName":"北京市海淀区xxx","countryCode":"CN","countryName":"中国","administrativeArea":"北京市","subAdministrativeArea":"北京市","locality":"北京市","subLocality":"海淀区","roadName":"","subRoadName":"15","premises":"15","postalCode":"","phoneNumber":"","addressUrl":"","descriptions":["010","110108001"],"descriptionsSize":2,"isFromMock":false}]            Logger.info(TAG, 'getAddressesFromLocation: data=: ' + JSON.stringify(data));            this.message = JSON.stringify(data)            if (data[0].locality !== undefined) {              Logger.info(TAG, 'locality: ' + data[0].locality);            }          }        });      }    });  }  build() {    RelativeContainer() {      Text(this.message)        .id('LocationPageHelloWorld')        .fontWeight(FontWeight.Bold)        .alignRules({          center: { anchor: '__container__', align: VerticalAlign.Center },          middle: { anchor: '__container__', align: HorizontalAlign.Center }        })      Button('获取位置')        .onClick(() => {          this.getLocation()        })    }    .height('100%')    .width('100%')  }}
```

# Q&A

之前申请权限是这样的：

https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V2/accesstoken-guidelines-0000001493744016-V2

现在不能用了？如何跳转到应用设置页面？

https://developer.huawei.com/consumer/cn/forum/topic/0208151081864331150?fid=0109140870620153026

位置服务：

https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/js-apis-geolocationmanager-V5